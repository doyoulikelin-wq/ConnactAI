<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connact.ai</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Brice Semi Expanded';
            src: local('Brice Semi Expanded'), local('BriceSemiExpanded');
            font-weight: 400;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dreamcore Sci-Fi Color Palette */
            --bg: #0a0a0f;
            --bg-secondary: #12121a;
            --text: #e8e6f0;
            --text-bright: #ffffff;
            --muted: rgba(232, 230, 240, 0.65);
            --muted-2: rgba(232, 230, 240, 0.45);
            
            /* Ethereal Accent Colors */
            --accent: #8b5cf6;
            --accent-hover: #a78bfa;
            --accent-pressed: #7c3aed;
            --accent-glow: rgba(139, 92, 246, 0.4);
            
            /* Dreamcore Secondary Colors */
            --cyan: #22d3ee;
            --cyan-glow: rgba(34, 211, 238, 0.3);
            --magenta: #f472b6;
            --magenta-glow: rgba(244, 114, 182, 0.3);
            --emerald: #34d399;
            --emerald-glow: rgba(52, 211, 153, 0.3);
            
            /* Glass Panel Effects */
            --panel: rgba(20, 20, 30, 0.75);
            --panel-strong: rgba(25, 25, 38, 0.88);
            --panel-hover: rgba(30, 30, 45, 0.85);
            --border: rgba(139, 92, 246, 0.2);
            --border-soft: rgba(255, 255, 255, 0.08);
            --border-glow: rgba(139, 92, 246, 0.5);
            
            /* Shadows & Effects */
            --shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 60px rgba(139, 92, 246, 0.15);
            --shadow-sm: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 30px rgba(139, 92, 246, 0.1);
            --shadow-glow: 0 0 40px var(--accent-glow), 0 0 80px rgba(139, 92, 246, 0.2);
            
            /* Border Radius */
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            
            /* Focus States */
            --focus-ring: 0 0 0 3px rgba(139, 92, 246, 0.4), 0 0 20px rgba(139, 92, 246, 0.3);
            
            /* Success State */
            --success: #34d399;
            --success-glow: rgba(52, 211, 153, 0.4);
        }

        body {
            font-family: 'Brice Semi Expanded', 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            
            /* Dreamcore Background */
            background: var(--bg);
            background-image:
                /* Floating orbs / bokeh effect */
                radial-gradient(800px 600px at 20% 10%, rgba(139, 92, 246, 0.15), transparent 50%),
                radial-gradient(600px 500px at 80% 20%, rgba(34, 211, 238, 0.12), transparent 50%),
                radial-gradient(700px 600px at 60% 80%, rgba(244, 114, 182, 0.1), transparent 50%),
                radial-gradient(500px 400px at 10% 90%, rgba(52, 211, 153, 0.08), transparent 50%),
                /* Subtle grid pattern for depth */
                linear-gradient(rgba(139, 92, 246, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(139, 92, 246, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 100% 100%, 100% 100%, 60px 60px, 60px 60px;
            background-attachment: fixed;
        }

        /* Animated background particles effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(2px 2px at 20% 30%, rgba(139, 92, 246, 0.4), transparent),
                radial-gradient(2px 2px at 40% 70%, rgba(34, 211, 238, 0.3), transparent),
                radial-gradient(2px 2px at 60% 20%, rgba(244, 114, 182, 0.3), transparent),
                radial-gradient(2px 2px at 80% 60%, rgba(52, 211, 153, 0.3), transparent),
                radial-gradient(1px 1px at 30% 50%, rgba(255, 255, 255, 0.2), transparent),
                radial-gradient(1px 1px at 70% 40%, rgba(255, 255, 255, 0.15), transparent);
            background-size: 350px 350px, 400px 400px, 300px 300px, 450px 450px, 200px 200px, 250px 250px;
            animation: floatParticles 30s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes floatParticles {
            0%, 100% { transform: translate(0, 0) rotate(0deg); opacity: 0.6; }
            25% { transform: translate(10px, -20px) rotate(2deg); opacity: 0.8; }
            50% { transform: translate(-5px, 10px) rotate(-1deg); opacity: 0.7; }
            75% { transform: translate(15px, 5px) rotate(1deg); opacity: 0.9; }
        }

        .container {
            max-width: 920px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
        }

        .header h1 {
            color: var(--text-bright);
            font-size: 2em;
            letter-spacing: -0.02em;
            font-weight: 600;
            text-shadow: 0 0 40px var(--accent-glow);
        }

        .app-logo {
            color: inherit;
            text-decoration: none;
            text-shadow: inherit;
        }

        .app-logo:hover {
            opacity: 0.92;
        }

        .app-logo:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
            border-radius: 12px;
        }

        /* Floating LCD Panel - Mode Switcher */
        .mode-switcher {
            position: fixed;
            top: 18px;
            right: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 999px;
            backdrop-filter: blur(25px) saturate(180%);
            box-shadow: var(--shadow-sm), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            z-index: 900;
        }

        .mode-switcher-label {
            color: var(--muted);
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .mode-pill {
            border: 1px solid var(--border-soft);
            background: rgba(255, 255, 255, 0.05);
            color: var(--muted);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }

        .mode-pill:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--border);
            color: var(--text);
            transform: translateY(-1px);
        }

        .mode-pill.active {
            background: linear-gradient(135deg, var(--accent) 0%, #a78bfa 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 8px 25px var(--accent-glow), 0 0 20px var(--accent-glow);
        }

        .version-badge {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-hover);
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 11px;
            margin-left: 12px;
            border: 1px solid var(--border);
            letter-spacing: 0.05em;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.05);
            color: var(--muted);
            padding: 10px 22px;
            border: 1px solid var(--border-soft);
            border-radius: 999px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            font-family: inherit;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--border);
            color: var(--text);
            box-shadow: var(--shadow-sm);
        }

        .user-chip {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-soft);
            border-radius: 999px;
            padding: 8px 14px;
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            max-width: 340px;
        }

        .user-chip img {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        .user-chip span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Progress Steps - Holographic Bar */
        .progress-container {
            display: flex;
            justify-content: center;
            margin-bottom: 35px;
        }

        .progress-steps {
            display: flex;
            align-items: center;
            background: var(--panel);
            border: 1px solid var(--border);
            backdrop-filter: blur(25px) saturate(180%);
            box-shadow: var(--shadow-sm), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            padding: 16px 35px;
            border-radius: 50px;
        }

        .step {
            display: flex;
            align-items: center;
            color: var(--muted-2);
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
        }

        .step.active {
            color: var(--text-bright);
        }

        .step.completed {
            color: var(--emerald);
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 13px;
            transition: all 0.3s;
        }

        .step.active .step-number {
            background: linear-gradient(135deg, var(--accent) 0%, #a78bfa 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .step.completed .step-number {
            background: linear-gradient(135deg, var(--emerald) 0%, #4ade80 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 0 20px var(--emerald-glow);
        }

        .step-connector {
            width: 45px;
            height: 2px;
            background: linear-gradient(90deg, var(--border-soft), var(--border));
            margin: 0 16px;
            border-radius: 2px;
        }

        .step-connector.completed {
            background: linear-gradient(90deg, var(--emerald), var(--cyan));
            box-shadow: 0 0 10px var(--emerald-glow);
        }

        /* Floating LCD Panels */
        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            backdrop-filter: blur(25px) saturate(180%);
            padding: 32px;
            box-shadow: var(--shadow), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        /* Subtle animated gradient border effect */
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent), var(--cyan), var(--magenta), transparent);
            opacity: 0.5;
        }

        .panel h2 {
            color: var(--text-bright);
            margin-bottom: 25px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-soft);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .panel h2 .icon {
            font-size: 1.4em;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        .panel-description {
            color: var(--muted);
            margin-bottom: 25px;
            line-height: 1.7;
        }

        /* Form Styles - Soft Glow Inputs */
        .form-group {
            margin-bottom: 22px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--muted);
            font-size: 13px;
            letter-spacing: 0.02em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.03);
            font-size: 14px;
            color: var(--text);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--muted-2);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: var(--focus-ring);
            background: rgba(139, 92, 246, 0.05);
        }

        /* Option Cards - Holographic Selection */
        .option-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 22px;
        }

        .option-card {
            padding: 22px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            background: rgba(255, 255, 255, 0.02);
            position: relative;
            overflow: hidden;
        }

        .option-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 40%, rgba(139, 92, 246, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .option-card:hover {
            border-color: var(--border-glow);
            background: rgba(139, 92, 246, 0.08);
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }

        .option-card:hover::before {
            opacity: 1;
        }

        .option-card.selected {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.12);
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .option-card.selected::before {
            opacity: 1;
        }

        .option-card .icon {
            font-size: 2.2em;
            margin-bottom: 12px;
            filter: drop-shadow(0 0 10px rgba(139, 92, 246, 0.3));
        }

        .option-card .title {
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 6px;
        }

        .option-card .desc {
            font-size: 12px;
            color: var(--muted);
        }

        /* Custom Input for "Other" option */
        .custom-input {
            margin-top: 16px;
            display: none;
        }

        .custom-input.visible {
            display: block;
        }

        .custom-input textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.03);
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            color: var(--text);
            transition: all 0.3s;
            font-family: inherit;
        }

        .custom-input textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: var(--focus-ring);
            background: rgba(139, 92, 246, 0.05);
        }

        /* Yes/No Choice - Soft Glow Buttons */
        .choice-buttons {
            display: flex;
            gap: 16px;
            margin-bottom: 22px;
        }

        .choice-btn {
            flex: 1;
            padding: 16px 28px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.03);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--muted);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .choice-btn:hover {
            border-color: var(--border-glow);
            background: rgba(139, 92, 246, 0.08);
            color: var(--text);
            box-shadow: var(--shadow-sm);
        }

        .choice-btn.selected {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.15);
            color: var(--text-bright);
            box-shadow: 0 0 25px var(--accent-glow);
        }

        .choice-btn:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        /* Questionnaire - Dynamic Cards */
        .questionnaire {
            display: none;
        }

        .questionnaire.visible {
            display: block;
        }

        .question-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 22px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
        }

        .question-card h4 {
            color: var(--text-bright);
            margin-bottom: 16px;
            font-size: 15px;
            font-weight: 600;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .question-option {
            padding: 14px 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted);
        }

        .question-option:hover {
            border-color: var(--border-glow);
            background: rgba(139, 92, 246, 0.08);
            color: var(--text);
            box-shadow: var(--shadow-sm);
        }

        .question-option.selected {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.12);
            color: var(--text-bright);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .question-custom-input {
            margin-top: 12px;
            display: none;
        }

        .question-custom-input.visible {
            display: block;
        }

        .question-custom-input textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: rgba(255, 255, 255, 0.03);
            font-size: 14px;
            color: var(--text);
            transition: all 0.3s;
            resize: vertical;
            font-family: inherit;
        }

        .question-custom-input textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: var(--focus-ring);
        }

        /* Recommendation List - Floating Cards */
        .recommendation-list {
            margin-top: 22px;
        }

        .recommendation-item {
            display: flex;
            align-items: center;
            padding: 18px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.02);
            position: relative;
        }

        .recommendation-item:hover {
            border-color: var(--border-glow);
            background: rgba(139, 92, 246, 0.08);
            box-shadow: var(--shadow-sm);
            transform: translateX(4px);
        }

        .recommendation-item.selected {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.12);
            box-shadow: 0 0 25px var(--accent-glow);
        }

        .rec-checkbox {
            width: 26px;
            height: 26px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-right: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.03);
            color: transparent;
        }

        .recommendation-item.selected .rec-checkbox {
            background: linear-gradient(135deg, var(--accent) 0%, #a78bfa 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .selected-targets {
            margin-top: 22px;
            padding: 18px;
            background: rgba(139, 92, 246, 0.08);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            display: none;
        }

        .selected-targets.visible {
            display: block;
        }

        .selected-targets h4 {
            color: var(--accent-hover);
            margin-bottom: 12px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .selected-target-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .target-tag {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid var(--border);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            color: var(--accent-hover);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .target-tag .remove {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .target-tag .remove:hover {
            opacity: 1;
        }

        .rec-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--cyan) 50%, var(--magenta) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin-right: 16px;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .rec-info {
            flex: 1;
        }

        .rec-name {
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .linkedin-link {
            color: #0a66c2;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s ease;
            opacity: 0.8;
        }

        .linkedin-link:hover {
            color: #004182;
            opacity: 1;
            transform: scale(1.1);
        }

        .rec-field {
            font-size: 13px;
            color: var(--muted);
        }

        .rec-match {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .rec-match.high {
            background: rgba(52, 211, 153, 0.15);
            color: var(--emerald);
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .rec-match.medium {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .rec-match.low {
            background: rgba(244, 114, 182, 0.15);
            color: var(--magenta);
            border: 1px solid rgba(244, 114, 182, 0.3);
        }

        /* Match Details Modal - Floating Panel */
        .match-details {
            display: none;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 22px;
            margin-top: 16px;
            box-shadow: var(--shadow-sm);
        }

        .match-details.visible {
            display: block;
        }

        .match-section {
            margin-bottom: 16px;
        }

        .match-section h5 {
            color: var(--accent-hover);
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 600;
        }

        .match-section p {
            color: var(--muted);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Buttons - Holographic Glow Effect */
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #a78bfa 100%);
            color: white;
            box-shadow: 0 8px 25px var(--accent-glow);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px var(--accent-glow), 0 0 30px var(--accent-glow);
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--border-glow);
            box-shadow: var(--shadow-sm);
        }

        .btn-group {
            display: flex;
            gap: 16px;
            margin-top: 28px;
        }

        .btn-icon {
            padding: 10px 16px;
            font-size: 13px;
        }

        /* Email Output - LCD Display */
        .email-output {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
            padding: 28px;
            margin-top: 22px;
            border: 1px solid var(--border);
        }

        .email-editor-field {
            position: relative;
            margin-bottom: 18px;
        }

        .email-editor-label {
            display: block;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 10px;
            font-size: 13px;
        }

        .email-editor-input,
        .email-editor-textarea {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px 48px 14px 16px;
            font-size: 14px;
            font-family: 'SF Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            line-height: 1.7;
            color: var(--text);
            background: rgba(255, 255, 255, 0.03);
            transition: all 0.3s;
        }

        .email-editor-textarea {
            min-height: 300px;
            resize: vertical;
        }

        .email-editor-input:focus,
        .email-editor-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: var(--focus-ring);
        }

        .email-copy-inline {
            position: absolute;
            top: 40px;
            right: 12px;
            height: 32px;
            padding: 0 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--muted);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .email-copy-inline:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--accent);
            color: var(--accent-hover);
        }

        .email-copy-inline.copied {
            border-color: var(--emerald);
            color: var(--emerald);
            background: rgba(52, 211, 153, 0.1);
        }

        /* Email Compare View */
        .email-compare-container {
            display: none;
            gap: 20px;
            margin-bottom: 20px;
        }

        .email-compare-container.visible {
            display: grid;
            grid-template-columns: 1fr 1fr;
        }

        .email-version {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .email-version:hover {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.05);
        }

        .email-version.selected {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .email-version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .email-version-title {
            font-weight: 600;
            color: var(--text-bright);
            font-size: 14px;
        }

        .email-version-badge {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        .email-version-badge.original {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .email-version-badge.regenerated {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        .email-version-subject {
            font-size: 13px;
            color: var(--text-bright);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .email-version-preview {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .compare-actions {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            justify-content: center;
        }

        .compare-actions .btn {
            min-width: 140px;
        }

        @media (max-width: 768px) {
            .email-compare-container.visible {
                grid-template-columns: 1fr;
            }
        }

        /* Email Version Expand Modal */
        .email-expand-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .email-expand-modal.visible {
            display: flex;
        }

        .email-expand-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .email-expand-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .email-expand-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .email-expand-close {
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .email-expand-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-bright);
        }

        .email-expand-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .email-expand-field {
            margin-bottom: 16px;
        }

        .email-expand-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .email-expand-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 12px 14px;
            color: var(--text-bright);
            font-size: 14px;
            transition: all 0.2s;
        }

        .email-expand-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .email-expand-textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 14px;
            color: var(--text-bright);
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
            min-height: 300px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .email-expand-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .email-expand-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .email-expand-hint {
            font-size: 11px;
            color: var(--muted);
            margin-top: 6px;
        }

        .email-version .expand-hint {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 11px;
            color: var(--muted);
            opacity: 0;
            transition: opacity 0.2s;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .email-version:hover .expand-hint {
            opacity: 1;
        }

        .email-version {
            position: relative;
        }

        /* Regenerate Options - Control Panel */
        .regenerate-options {
            display: none;
            margin-top: 22px;
            padding: 22px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .regenerate-options.visible {
            display: block;
        }

        .regenerate-options h4 {
            color: var(--text-bright);
            margin-bottom: 16px;
            font-weight: 600;
        }

        .style-options {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        .style-option {
            padding: 10px 20px;
            border: 1px solid var(--border);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--muted);
            font-family: inherit;
        }

        .style-option:hover {
            border-color: var(--border-glow);
            background: rgba(139, 92, 246, 0.08);
            color: var(--text);
        }

        .style-option.selected {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent-hover);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* Loading State - Ethereal Spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }

        .loading.visible {
            display: block;
        }

        .spinner {
            width: 55px;
            height: 55px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-right-color: var(--cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 22px;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--muted);
            font-size: 15px;
            min-height: 24px;
            transition: opacity 0.3s ease;
        }

        .loading-text.fade {
            opacity: 0;
        }

        /* Animated dots for loading */
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Notice Box - Alert Panel */
        .notice {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: var(--radius-sm);
            padding: 14px 18px;
            margin-bottom: 22px;
            color: #fbbf24;
            font-size: 14px;
        }

        .notice .icon {
            margin-right: 10px;
        }

        /* Hidden by default */
        .hidden {
            display: none !important;
        }

        /* Modal - Floating LCD Display */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .onboarding-list {
            margin: 14px 0 0;
            padding-left: 20px;
            color: var(--muted);
            line-height: 1.7;
        }

        .onboarding-list li {
            margin: 10px 0;
        }

        .modal-content {
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 620px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            backdrop-filter: blur(30px) saturate(180%);
            box-shadow: var(--shadow), 0 0 60px var(--accent-glow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-soft);
        }

        .modal-header h3 {
            color: var(--text-bright);
            font-size: 1.3em;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
            transition: all 0.3s;
        }

        .modal-close:hover {
            color: var(--text-bright);
            transform: rotate(90deg);
        }

        .profile-section {
            margin-bottom: 22px;
        }

        .profile-section h4 {
            color: var(--accent-hover);
            font-size: 13px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .profile-section ul {
            list-style: none;
            padding: 0;
        }

        .profile-section li {
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--muted);
        }

        .profile-section p {
            font-size: 14px;
            color: var(--muted);
            line-height: 1.6;
        }

        .view-profile-btn {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid var(--border);
            color: var(--accent-hover);
            font-size: 12px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.3s;
            font-family: inherit;
            font-weight: 600;
        }

        .view-profile-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        /* Mode Selection - Holographic Cards */
        .mode-selection-container {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 24px;
        }

        .mode-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 45px 35px;
            width: 350px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(25px) saturate(180%);
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), var(--cyan), var(--magenta));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .mode-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 0%, rgba(139, 92, 246, 0.1), transparent 60%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .mode-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow), 0 0 40px var(--accent-glow);
            border-color: var(--border-glow);
        }

        .mode-card:hover::before,
        .mode-card:hover::after {
            opacity: 1;
        }

        .mode-card.selected {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
            box-shadow: var(--shadow), 0 0 50px var(--accent-glow);
        }

        .mode-card.selected::before {
            opacity: 1;
        }

        .mode-card .mode-icon {
            font-size: 4em;
            margin-bottom: 22px;
            filter: drop-shadow(0 0 20px var(--accent-glow));
        }

        .mode-card .mode-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-bright);
            margin-bottom: 16px;
        }

        .mode-card .mode-subtitle {
            font-size: 0.95em;
            color: var(--muted);
            margin-bottom: 22px;
            line-height: 1.6;
        }

        .mode-card .mode-features {
            text-align: left;
            margin: 22px 0;
            padding: 0;
            list-style: none;
        }

        .mode-card .mode-features li {
            padding: 10px 0;
            font-size: 14px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mode-card .mode-features li::before {
            content: 'âœ“';
            color: var(--emerald);
            font-weight: bold;
            filter: drop-shadow(0 0 5px var(--emerald-glow));
        }

        .mode-card .mode-badge {
            display: inline-block;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
        }

        .mode-card.quick .mode-badge {
            background: rgba(52, 211, 153, 0.15);
            color: var(--emerald);
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .mode-card.pro .mode-badge {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .mode-card.pro .mode-coming-soon {
            position: absolute;
            top: 18px;
            right: -28px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 6px 40px;
            font-size: 10px;
            font-weight: 700;
            transform: rotate(45deg);
            letter-spacing: 0.05em;
        }

        .mode-card.pro.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .mode-card.pro.disabled:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        /* Locked card style (Building) */
        .mode-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            position: relative;
            filter: grayscale(40%);
        }

        .mode-card.locked:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
            border-color: var(--border);
        }

        .mode-card.locked::before {
            opacity: 0.3 !important;
        }

        .mode-card.locked .lock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .mode-card.locked .lock-chains {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            border-radius: var(--radius-lg);
        }

        .mode-card.locked .lock-chains::before,
        .mode-card.locked .lock-chains::after {
            content: '';
            position: absolute;
            width: 200%;
            height: 3px;
            background: repeating-linear-gradient(
                90deg,
                #6b7280 0px,
                #6b7280 10px,
                transparent 10px,
                transparent 15px,
                #9ca3af 15px,
                #9ca3af 20px,
                transparent 20px,
                transparent 25px
            );
            opacity: 0.6;
        }

        .mode-card.locked .lock-chains::before {
            top: 50%;
            left: -50%;
            transform: rotate(-45deg);
        }

        .mode-card.locked .lock-chains::after {
            top: 50%;
            left: -50%;
            transform: rotate(45deg);
        }

        .mode-card.locked .lock-icon {
            font-size: 36px;
            margin-bottom: 8px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .mode-card.locked .lock-text {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .option-cards {
                grid-template-columns: 1fr;
            }

            .mode-switcher {
                left: 12px;
                right: 12px;
                justify-content: center;
            }
            
            .mode-switcher-label {
                display: none;
            }
            
            .choice-buttons {
                flex-direction: column;
            }
            
            .progress-steps {
                padding: 10px 15px;
            }
            
            .step-connector {
                width: 20px;
                margin: 0 8px;
            }
            
            .step span:not(.step-number) {
                display: none;
            }
            
            .mode-selection-container {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-card {
                width: 100%;
                max-width: 340px;
            }
        }

        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 20px;
            color: var(--text-bright);
            font-size: 14px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: toastSlideIn 0.3s ease-out;
            pointer-events: auto;
        }

        .toast.info {
            border-color: rgba(99, 102, 241, 0.5);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
        }

        .toast.success {
            border-color: rgba(52, 211, 153, 0.5);
            background: linear-gradient(135deg, rgba(52, 211, 153, 0.15), rgba(16, 185, 129, 0.1));
        }

        .toast.error {
            border-color: rgba(239, 68, 68, 0.5);
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
        }

        .toast.fade-out {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="mode-switcher" id="global-mode-switcher">
        <span class="mode-switcher-label">Mode</span>
        <button class="mode-pill" data-mode="quick">âš¡ Quick</button>
        <button class="mode-pill" data-mode="professional">ðŸ’¼ Professional</button>
    </div>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><a class="app-logo" href="/" title="Back to home">ðŸ¤ Connact.ai</a></h1>
            <div style="display: flex; align-items: center; gap: 12px;">
                {% if user_name or user_email %}
                <div class="user-chip" title="{{ user_email or '' }}">
                    {% if user_picture %}
                    <img src="{{ user_picture }}" alt="User">
                    {% endif %}
                    <span>{{ user_name or user_email }}</span>
                </div>
                {% endif %}
                <a href="/logout" class="btn-logout">Logout</a>
            </div>
        </div>

        <!-- Progress Steps (hidden until mode selected) -->
        <div class="progress-container hidden" id="progress-container">
            <div class="progress-steps">
                <div class="step active" id="step-indicator-1">
                    <span class="step-number">1</span>
                    <span>Purpose</span>
                </div>
                <div class="step-connector" id="connector-1"></div>
                <div class="step" id="step-indicator-2">
                    <span class="step-number">2</span>
                    <span>Your Profile</span>
                </div>
                <div class="step-connector" id="connector-2"></div>
                <div class="step" id="step-indicator-3">
                    <span class="step-number">3</span>
                    <span>Find Targets</span>
                </div>
                <div class="step-connector" id="connector-3"></div>
                <div class="step" id="step-indicator-4">
                    <span class="step-number">4</span>
                    <span>Template</span>
                </div>
                <div class="step-connector" id="connector-4"></div>
                <div class="step" id="step-indicator-5">
                    <span class="step-number">5</span>
                    <span>Generate</span>
                </div>
            </div>
        </div>

        <!-- Mode Selection (shown first) -->
        <div class="panel" id="mode-selection">
            <h2><span class="icon">ðŸš€</span> Choose Your Mode</h2>
            <p class="panel-description">Select how you'd like to create your cold emails. You can always switch modes later.</p>
            
            <div class="mode-selection-container">
                <!-- Quick Start Mode -->
                <div class="mode-card quick" id="mode-quick" data-mode="quick">
                    <div class="mode-icon">âš¡</div>
                    <div class="mode-title">Quick Start</div>
                    <div class="mode-subtitle">Perfect for getting started fast without uploading documents</div>
                    <ul class="mode-features">
                        <li>No resume upload required</li>
                        <li>Answer a few quick questions</li>
                        <li>AI builds your profile from answers</li>
                        <li>Smart target matching</li>
                        <li>Generate personalized emails</li>
                    </ul>
                    <div class="mode-badge">ðŸŽ¯ Best for beginners</div>
                </div>
                
                <!-- Professional Mode -->
                <div class="mode-card pro" id="mode-pro" data-mode="professional">
                    <div class="mode-icon">ðŸ’¼</div>
                    <div class="mode-title">Professional</div>
                    <div class="mode-subtitle">Advanced features for finance and academic professionals</div>
                    <ul class="mode-features">
                        <li>Upload your resume/CV</li>
                        <li>Choose Finance or Academic track</li>
                        <li>Advanced target recommendations</li>
                        <li>Industry-specific email templates</li>
                        <li>Detailed profile analysis</li>
                    </ul>
                    <div class="mode-badge">â­ Premium features</div>
                </div>
            </div>
            
            <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                <button class="btn btn-primary" id="btn-mode-next" disabled>Continue with Selected Mode â†’</button>
            </div>
        </div>

        <!-- Professional Mode: Track Selection -->
        <div class="panel hidden" id="pro-track-selection">
            <h2><span class="icon">ðŸŽ¯</span> Choose Your Track</h2>
            <p class="panel-description">Select your professional focus area for tailored recommendations.</p>
            
            <div class="mode-selection-container">
                <!-- Finance Track -->
                <div class="mode-card" id="track-finance" data-track="finance">
                    <div class="mode-icon">ðŸ“ˆ</div>
                    <div class="mode-title">Finance</div>
                    <div class="mode-subtitle">Investment banking, asset management, fintech, quantitative finance</div>
                    <ul class="mode-features">
                        <li>Connect with finance professionals</li>
                        <li>Investment banks & hedge funds</li>
                        <li>Fintech startups & VCs</li>
                        <li>Quantitative research roles</li>
                    </ul>
                </div>
                
                <!-- Academic Track (Locked - Building) -->
                <div class="mode-card locked" id="track-academic" data-track="academic">
                    <div class="lock-overlay">
                        <div class="lock-chains"></div>
                        <span class="lock-icon">ðŸ”’</span>
                        <span class="lock-text">Building</span>
                    </div>
                    <div class="mode-icon">ðŸŽ“</div>
                    <div class="mode-title">Academic</div>
                    <div class="mode-subtitle">Research positions, PhD programs, postdoc opportunities</div>
                    <ul class="mode-features">
                        <li>Connect with professors & researchers</li>
                        <li>PhD & postdoc applications</li>
                        <li>Research collaborations</li>
                        <li>Academic conference networking</li>
                    </ul>
                </div>
            </div>
            
            <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                <button class="btn btn-secondary" id="btn-track-back">â† Back to Mode Selection</button>
                <button class="btn btn-primary" id="btn-track-next" disabled>Continue â†’</button>
            </div>
        </div>

        <!-- Professional Mode: Resume Upload -->
        <div class="panel hidden" id="pro-resume-upload">
            <h2><span class="icon">ðŸ“„</span> Upload Your Resume</h2>
            <p class="panel-description">Upload your resume or CV so we can analyze your background and find the best matches.</p>
            
            <div class="notice" style="background: rgba(139, 92, 246, 0.12); border-color: rgba(139, 92, 246, 0.4); color: #c4b5fd;">
                <span class="icon">ðŸ’¼</span>
                <strong>Professional Mode:</strong> Your resume helps us find highly targeted recommendations in the <span id="selected-track-display">your field</span> sector.
            </div>
            
            <div class="form-group">
                <label>Upload your resume (PDF)</label>
                <div style="border: 1px dashed rgba(139, 92, 246, 0.4); border-radius: 16px; padding: 40px; text-align: center; background: rgba(139, 92, 246, 0.08); cursor: pointer; backdrop-filter: blur(18px);" id="pro-resume-dropzone">
                    <div style="font-size: 3em; margin-bottom: 15px;">ðŸ“Ž</div>
                    <div style="font-size: 16px; color: #e0e0e8; margin-bottom: 10px;">Drag & drop your resume here</div>
                    <div style="font-size: 14px; color: #a0a0b0;">or click to browse (PDF only)</div>
                    <input type="file" id="pro-resume-file" accept=".pdf" style="display: none;">
                </div>
            </div>
            
            <div class="loading hidden" id="pro-upload-loading">
                <div class="spinner"></div>
                <div class="loading-text">Analyzing your resume with AI...</div>
            </div>
            
            <div class="hidden" id="pro-resume-success">
                <div class="notice" style="background: rgba(34, 211, 238, 0.15); border-color: rgba(34, 211, 238, 0.5); color: #22d3ee;">
                    <span class="icon">âœ…</span> Resume analyzed successfully! We found key information about your background.
                </div>
                <div id="pro-resume-summary" style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 20px; margin-top: 15px; color: #e0e0e8;">
                    <!-- Resume summary will be shown here -->
                </div>
            </div>
            
            <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                <button class="btn btn-secondary" id="btn-resume-back">â† Back to Track Selection</button>
                <button class="btn btn-primary" id="btn-resume-next" disabled>Continue â†’</button>
            </div>
        </div>

        <!-- Professional Mode: Target Selection -->
        <div class="panel hidden" id="pro-target-choice">
            <h2><span class="icon">ðŸŽ¯</span> Do You Have Specific Targets?</h2>
            <p class="panel-description">Tell us if you already know who you want to contact, or if you need our AI to find the best matches.</p>
            
            <div class="mode-selection-container">
                <!-- I Have Targets -->
                <div class="mode-card" id="target-have" data-target-choice="have">
                    <div class="mode-icon">âœ…</div>
                    <div class="mode-title">Yes, I Have Targets</div>
                    <div class="mode-subtitle">I know specific people I want to contact</div>
                    <ul class="mode-features">
                        <li>Enter target names directly</li>
                        <li>AI fetches their profiles</li>
                        <li>Generate tailored emails</li>
                    </ul>
                </div>
                
                <!-- Need Recommendations -->
                <div class="mode-card" id="target-need" data-target-choice="need">
                    <div class="mode-icon">ðŸ”</div>
                    <div class="mode-title">Find Targets for Me</div>
                    <div class="mode-subtitle">Let AI recommend the best people based on your profile</div>
                    <ul class="mode-features">
                        <li>Answer a few preference questions</li>
                        <li>AI analyzes your resume</li>
                        <li>Get personalized recommendations</li>
                    </ul>
                </div>
            </div>
            
            <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                <button class="btn btn-secondary" id="btn-target-choice-back">â† Back</button>
                <button class="btn btn-primary" id="btn-target-choice-next" disabled>Continue â†’</button>
            </div>
        </div>

        <!-- Professional Mode: Preference Questions (when user needs recommendations) -->
        <div class="panel hidden" id="pro-preferences">
            <h2><span class="icon">ðŸŽ¯</span> Refine Your Target Preferences</h2>
            <p class="panel-description">Answer a few questions to help us find the perfect contacts for you.</p>
            
            <div class="notice" style="background: rgba(244, 114, 182, 0.12); border-color: rgba(244, 114, 182, 0.4); color: #f472b6;">
                <span class="icon">ðŸ¤–</span>
                <strong>AI-Powered:</strong> Based on your resume and these preferences, we'll find highly relevant targets in <span id="pref-track-display">your field</span>.
            </div>

            <!-- Optional: structured targeting context -->
            <div class="form-group" style="margin-top: 10px;">
                <button class="btn btn-secondary btn-icon" id="btn-toggle-pro-target-advanced" type="button">
                    âš™ï¸ Add more targeting details (optional)
                </button>
            </div>
            <div class="hidden" id="pro-target-advanced">
                <div class="form-group">
                    <label>What kind of people are you trying to reach? (role/org/subfield)</label>
                    <textarea id="pro-target-search-intent" rows="3" placeholder="Describe the ideal target in one or two sentences..."></textarea>
                </div>
                <div class="form-group">
                    <label>Must-have keywords (comma-separated)</label>
                    <input type="text" id="pro-target-must-have" placeholder="e.g., IB analyst, buy-side, LLM, NLP">
                </div>
                <div class="form-group">
                    <label>Must-not keywords (comma-separated)</label>
                    <input type="text" id="pro-target-must-not" placeholder="e.g., crypto, web3">
                </div>
                <div class="form-group">
                    <label>Location / language / timezone (optional)</label>
                    <input type="text" id="pro-target-location" placeholder="e.g., UK, English, GMT">
                </div>
                <div class="form-group">
                    <label>Preference: reply likelihood vs prestige</label>
                    <div class="choice-buttons" id="pro-target-contactability">
                        <button class="choice-btn" data-value="balanced" type="button">âš–ï¸ Balanced</button>
                        <button class="choice-btn" data-value="reply" type="button">ðŸ“© More likely to reply</button>
                        <button class="choice-btn" data-value="prestige" type="button">ðŸ† Most senior/famous</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Examples of ideal targets (optional)</label>
                    <textarea id="pro-target-examples" rows="3" placeholder="One per line (names or orgs)..."></textarea>
                </div>
                <div class="form-group">
                    <label>Evidence links or snippets (optional)</label>
                    <textarea id="pro-target-evidence" rows="3" placeholder="URLs or short snippets to ground the search..."></textarea>
                </div>
            </div>
            
            <div id="pro-preference-questions">
                <!-- Dynamic preference questions will be loaded here -->
            </div>
            
            <div class="loading hidden" id="pro-pref-loading">
                <div class="spinner"></div>
                <div class="loading-text">Generating personalized questions...</div>
            </div>
            
            <div class="btn-group" style="justify-content: center; margin-top: 30px;">
                <button class="btn btn-secondary" id="btn-pref-back">â† Back</button>
                <button class="btn btn-primary" id="btn-find-pro-targets">ðŸ” Find My Targets</button>
            </div>
        </div>

        <!-- Step 1: Purpose -->
        <div class="panel hidden" id="step-1">
            <h2><span class="icon">ðŸŽ¯</span> Step 1: What's Your Purpose?</h2>
            <p class="panel-description">Select the type of outreach you want to make and specify your field.</p>
            
            <div class="form-group">
                <label>What do you want to achieve?</label>
                <div class="option-cards" id="purpose-options">
                    <div class="option-card" data-value="academic">
                        <div class="icon">ðŸŽ“</div>
                        <div class="title">Academic Outreach</div>
                        <div class="desc">Contact professors for research opportunities, PhD applications</div>
                    </div>
                    <div class="option-card" data-value="job">
                        <div class="icon">ðŸ’¼</div>
                        <div class="title">Job Seeking</div>
                        <div class="desc">Reach out to recruiters, hiring managers, or potential employers</div>
                    </div>
                    <div class="option-card" data-value="coffee">
                        <div class="icon">â˜•</div>
                        <div class="title">Coffee Chat</div>
                        <div class="desc">Network and learn from industry professionals</div>
                    </div>
                    <div class="option-card" data-value="other">
                        <div class="icon">âœ¨</div>
                        <div class="title">Other</div>
                        <div class="desc">Custom purpose - specify below</div>
                    </div>
                </div>
                <div class="custom-input" id="purpose-custom">
                    <input type="text" id="purpose-custom-input" placeholder="Describe your purpose...">
                </div>
            </div>

            <div class="form-group">
                <label>What field are you interested in?</label>
                <div class="option-cards" id="field-options">
                    <div class="option-card" data-value="ai-ml">
                        <div class="icon">ðŸ¤–</div>
                        <div class="title">AI / Machine Learning</div>
                        <div class="desc">Artificial Intelligence, Deep Learning, NLP</div>
                    </div>
                    <div class="option-card" data-value="software">
                        <div class="icon">ðŸ’»</div>
                        <div class="title">Software Engineering</div>
                        <div class="desc">Web, Mobile, Systems, Cloud</div>
                    </div>
                    <div class="option-card" data-value="finance">
                        <div class="icon">ðŸ“ˆ</div>
                        <div class="title">Finance / Fintech</div>
                        <div class="desc">Banking, Investment, Quantitative Finance</div>
                    </div>
                    <div class="option-card" data-value="other-field">
                        <div class="icon">ðŸ”¬</div>
                        <div class="title">Other Field</div>
                        <div class="desc">Specify your field below</div>
                    </div>
                </div>
                <div class="custom-input" id="field-custom">
                    <input type="text" id="field-custom-input" placeholder="Enter your field...">
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="btn-step1-next" disabled>Next Step â†’</button>
            </div>
        </div>

        <!-- Step 2: Your Profile -->
        <div class="panel hidden" id="step-2">
            <h2><span class="icon">ðŸ‘¤</span> Step 2: Your Profile</h2>
            <p class="panel-description">Help us understand your background to generate personalized emails.</p>

            <!-- Resume choice section (hidden in Quick Start mode) -->
            <div id="resume-choice-section">
                <div class="notice" id="resume-tip">
                    <span class="icon">ðŸ’¡</span>
                    <strong>Tip:</strong> Uploading a resume is recommended for the best results!
                </div>

                <div class="form-group">
                    <label>Do you have a resume to upload?</label>
                    <div class="choice-buttons" id="resume-choice">
                        <button class="choice-btn" data-value="yes">âœ… Yes, I have a resume</button>
                        <button class="choice-btn" data-value="no">ðŸ“ No, I'll answer questions</button>
                    </div>
                </div>
            </div>

            <!-- Quick Start Mode Notice -->
            <div class="notice hidden" id="quick-start-notice" style="background: #e3f2fd; border-color: #2196f3; color: #1565c0;">
                <span class="icon">âš¡</span>
                <strong>Quick Start Mode:</strong> (Optional) upload a resume and/or add your profile link/notes. If you leave everything blank, weâ€™ll ask 5 quick questions to build your profile.
            </div>

            <!-- Resume Upload Section -->
            <div class="hidden" id="resume-upload-section">
                <div class="form-group">
                    <label>Optional: Upload your resume (PDF)</label>
                    <div style="border: 1px dashed rgba(0,0,0,0.25); border-radius: 16px; padding: 34px; text-align: center; background: rgba(255,255,255,0.6); cursor: pointer; backdrop-filter: blur(18px);" id="qs-resume-dropzone">
                        <div style="font-size: 2.8em; margin-bottom: 12px;">ðŸ“Ž</div>
                        <div style="font-size: 16px; color: var(--text); margin-bottom: 8px;">Drag & drop your resume here</div>
                        <div style="font-size: 13px; color: var(--muted);">or click to browse (PDF only)</div>
                        <input type="file" id="resume-file" accept=".pdf" style="display: none;">
                    </div>
                </div>
                <div class="loading" id="upload-loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Analyzing your resume...</div>
                </div>
                <div class="hidden" id="resume-success">
                    <div class="notice" style="background: rgba(34, 211, 238, 0.15); border-color: rgba(34, 211, 238, 0.5); color: #22d3ee;">
                        <span class="icon">âœ…</span> Resume analyzed successfully!
                    </div>
                </div>
            </div>

            <!-- Optional sender profile link & notes -->
            <div class="form-group">
                <label>Optional: Your LinkedIn or profile link</label>
                <input type="text" id="sender-profile-link" placeholder="e.g., https://www.linkedin.com/in/your-name or personal website">
            </div>
            <div class="form-group">
                <label>Optional: Paste key info from your profile</label>
                <p style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">
                    You can paste your LinkedIn â€œAboutâ€ section, headline, or any highlights you want the AI to see.
                </p>
                <textarea id="sender-profile-extra" rows="3" placeholder="Paste a short description, headline, or key points from your profile..."></textarea>
            </div>

            <!-- Questionnaire Section (Quick Start fallback) -->
            <div class="questionnaire" id="questionnaire-section">
                <h3 style="margin-bottom: 10px; color: var(--text);">Quick Profile Builder</h3>
                <p style="font-size: 13px; color: var(--muted); margin-bottom: 14px;">
                    No resume or profile notes provided â€” answer these 5 quick questions instead.
                </p>
                <div class="notice hidden" id="quick-question-prompt" style="margin-bottom: 14px;">
                    <span class="icon">ðŸ“</span>
                    Generate 5 quick questions to build your profile.
                    <div class="btn-group" style="margin-top: 12px; justify-content: flex-end;">
                        <button class="btn btn-primary btn-icon" id="btn-generate-questions" type="button">Generate Questions</button>
                    </div>
                </div>
                <div id="questions-container">
                    <!-- Questions will be dynamically loaded here -->
                </div>
                <div class="loading" id="questionnaire-loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Generating personalized questions...</div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" id="btn-step2-back">â† Back</button>
                <button class="btn btn-primary" id="btn-step2-next" disabled>Next Step â†’</button>
            </div>
        </div>

        <!-- Step 3: Find Targets -->
        <div class="panel hidden" id="step-3">
            <h2><span class="icon">ðŸ”</span> Step 3: Find Your Targets</h2>
            <p class="panel-description">Find the perfect people to reach out to based on your profile and goals.</p>

            <div class="form-group">
                <label>Do you have a specific person in mind?</label>
                <div class="choice-buttons" id="target-choice">
                    <button class="choice-btn" data-value="yes">ðŸŽ¯ Yes, I know who to contact</button>
                    <button class="choice-btn" data-value="no">ðŸ” No, help me find matches</button>
                </div>
            </div>

            <!-- Target preferences for recommendations -->
            <div class="hidden" id="target-preferences">
                <div class="notice" style="margin-bottom: 12px;">
                    <span class="icon">ðŸ’¡</span> Tell us what to look for and we'll propose great targets.
                </div>

                <!-- Optional: structured targeting context -->
                <div class="form-group" style="margin-top: 10px;">
                    <button class="btn btn-secondary btn-icon" id="btn-toggle-target-advanced" type="button">
                        âš™ï¸ Add more targeting details (optional)
                    </button>
                </div>
                <div class="hidden" id="target-advanced">
                    <div class="form-group">
                        <label>What kind of people are you trying to reach? (role/org/subfield)</label>
                        <p style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">
                            Examples: "Assistant professor in NLP", "startup PM in healthcare", "VC associate investing in devtools".
                        </p>
                        <textarea id="target-search-intent" rows="3" placeholder="Describe the ideal target in one or two sentences..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Must-have keywords (comma-separated)</label>
                        <input type="text" id="target-must-have" placeholder="e.g., LLM, retrieval, healthcare">
                    </div>
                    <div class="form-group">
                        <label>Must-not keywords (comma-separated)</label>
                        <input type="text" id="target-must-not" placeholder="e.g., crypto, web3">
                    </div>
                    <div class="form-group">
                        <label>Location / language / timezone (optional)</label>
                        <input type="text" id="target-location" placeholder="e.g., US, English, PST">
                    </div>
                    <div class="form-group">
                        <label>Preference: reply likelihood vs prestige</label>
                        <div class="choice-buttons" id="target-contactability">
                            <button class="choice-btn" data-value="balanced" type="button">âš–ï¸ Balanced</button>
                            <button class="choice-btn" data-value="reply" type="button">ðŸ“© More likely to reply</button>
                            <button class="choice-btn" data-value="prestige" type="button">ðŸ† Most senior/famous</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Examples of ideal targets (optional)</label>
                        <textarea id="target-examples" rows="3" placeholder="One per line (names or orgs)..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Evidence links or snippets (optional)</label>
                        <p style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">
                            Paste any URLs/snippets you want the recommender to use as evidence. Avoid anything uncertain.
                        </p>
                        <textarea id="target-evidence" rows="3" placeholder="URLs or short snippets to ground the search..."></textarea>
                    </div>
                </div>
                <!-- Interactive target preference questionnaire -->
                <div class="questionnaire" id="target-questionnaire">
                    <h3 style="margin-bottom: 12px; color: #f0f0f5;">Refine your ideal targets</h3>
                    <p style="font-size: 13px; color: #a0a0b0; margin-bottom: 10px;">
                        Answer a few quick questions about the kind of people you want to reach. You can skip questions or stop at any time.
                    </p>
                    <div id="target-questions-container"></div>
                    <div class="loading" id="target-questionnaire-loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Thinking about the best questions...</div>
                    </div>
                </div>

                <div class="btn-group" style="justify-content: flex-end;">
                    <button class="btn btn-primary" id="btn-find-matches">Find Matches</button>
                </div>
            </div>

            <!-- Manual Target Input -->
            <div class="hidden" id="manual-target-section">
                <div class="form-group">
                    <label>Target's Name</label>
                    <input type="text" id="target-name" placeholder="e.g., Andrew Ng">
                </div>
                <div class="form-group">
                    <label>Target's Field / Position</label>
                    <input type="text" id="target-field" placeholder="e.g., AI Professor at Stanford">
                </div>
                <div class="form-group">
                    <label>Optional: Target's LinkedIn or profile link</label>
                    <input type="text" id="target-profile-link" placeholder="e.g., LinkedIn, lab page, personal website">
                </div>
                <div class="form-group">
                    <label>Optional: Paste key info about this target</label>
                    <p style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">
                        You can paste a short bio, summary, or key points from their profile to give the AI more context.
                    </p>
                    <textarea id="target-profile-extra" rows="3" placeholder="Paste a short bio, key projects, or notes about this person..."></textarea>
                </div>
                <!-- Document upload (hidden in Quick Start mode) -->
                <div class="form-group" id="target-doc-upload-section">
                    <label>Upload Target's Document (Optional)</label>
                    <p style="font-size: 12px; color: #a0a0b0; margin-bottom: 10px;">ðŸ“Ž Upload a PDF, TXT, or MD file with information about this person</p>
                    <input type="file" id="target-doc-file" accept=".pdf,.txt,.md">
                </div>
                <div class="loading hidden" id="target-doc-loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Analyzing document...</div>
                </div>
                <div class="hidden" id="target-doc-success">
                    <div class="notice" style="background: rgba(34, 211, 238, 0.15); border-color: rgba(34, 211, 238, 0.5); color: #22d3ee;">
                        <span class="icon">âœ…</span> Document analyzed! Profile info extracted.
                    </div>
                </div>
            </div>

            <!-- Recommendation Section -->
            <div class="hidden" id="recommendation-section">
                <div class="loading" id="rec-loading">
                    <div class="spinner"></div>
                    <div class="loading-text" id="rec-loading-text"><span class="loading-dots">Searching for the best matches based on your profile and preferences</span></div>
                </div>
                <div class="recommendation-list" id="recommendation-list">
                    <!-- Recommendations will be loaded here -->
                </div>
                <div class="btn-group" id="rec-actions" style="display: none;">
                    <button class="btn btn-secondary btn-icon" id="btn-more-recs">ðŸ”„ Generate More</button>
                    <button class="btn btn-secondary btn-icon" id="btn-add-manual">âž• Add Manually</button>
                </div>
            </div>

            <!-- Selected Targets Display -->
            <div class="selected-targets" id="selected-targets">
                <h4>âœ… Selected Targets (<span id="selected-count">0</span>)</h4>
                <div class="selected-target-tags" id="selected-target-tags">
                    <!-- Tags will be added here -->
                </div>
            </div>

            <!-- Match Details -->
            <div class="match-details" id="match-details">
                <h4 style="color: #f0f0f5; margin-bottom: 15px;">Match Analysis</h4>
                <div class="match-section">
                    <h5>ðŸŽ¯ Compatibility Score</h5>
                    <p id="match-score-text">Loading...</p>
                </div>
                <div class="match-section">
                    <h5>ðŸ”— Common Interests</h5>
                    <p id="match-interests-text">Loading...</p>
                </div>
                <div class="match-section">
                    <h5>ðŸ’¡ Why This Match</h5>
                    <p id="match-reason-text">Loading...</p>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" id="btn-step3-back">â† Back</button>
                <button class="btn btn-primary" id="btn-step3-next" disabled>Generate Emails â†’</button>
            </div>
        </div>

        <!-- Step 4: Choose Template / Mode -->
        <div class="panel hidden" id="step-4">
            <h2><span class="icon">ðŸ§©</span> Step 4: Email Style & Template</h2>
            <p class="panel-description">Choose whether to let the AI write freely or follow your own template.</p>

            <div class="form-group">
                <label>How do you want to generate your emails?</label>
                <div class="option-cards" id="generation-mode-options">
                    <div class="option-card" data-value="smart">
                        <div class="icon">ðŸ¤–</div>
                        <div class="title">Smart AI Email</div>
                        <div class="desc">Let the AI write the full email based on your profile and the target's profile.</div>
                    </div>
                    <div class="option-card" data-value="template">
                        <div class="icon">âœï¸</div>
                        <div class="title">Use My Template</div>
                        <div class="desc">Provide a template and the AI will follow its structure and tone.</div>
                    </div>
                </div>
            </div>

            <!-- Optional custom email template (only for template mode) -->
            <div class="form-group hidden" id="email-template-section">
                <label for="email-template">Your email template</label>
                <p style="margin: 4px 0 8px; font-size: 13px; color: #a0a0b0;">
                    Paste a template here if you selected <strong>Use My Template</strong>. The AI will keep its structure and tone,
                    and fill in details using your profile and the target's profile.
                </p>
                <textarea id="email-template" rows="6" placeholder="Example:
Subject: Coffee chat about {{field}}

Hi {{receiver_name}},

I&apos;m {{sender_name}}, currently ...

..."></textarea>
            </div>

            <!-- Optional: email goal / ask / constraints -->
            <div class="notice" style="margin-top: 16px;">
                <span class="icon">âœ…</span>
                Optional but recommended: add a clear ask + what you can offer. This makes the email specific and reduces invented details.
            </div>
            <div class="form-group">
                <label>Goal for this email (optional)</label>
                <input type="text" id="email-goal" placeholder="e.g., Request a 15â€“20 min chat next week">
            </div>
            <div class="form-group">
                <label>Your request (one clear ask)</label>
                <textarea id="email-ask" rows="2" placeholder="e.g., Would you be open to a 15â€“20 min chat? Iâ€™m free Tue/Thu afternoon (PST)."></textarea>
            </div>
            <div class="form-group">
                <label>What value can you offer them? (recommended)</label>
                <textarea id="email-value" rows="3" placeholder="e.g., I can share X, help with Y, contribute Z..."></textarea>
            </div>
            <div class="form-group">
                <label>Constraints (tone / length / language) (optional)</label>
                <input type="text" id="email-constraints" placeholder="e.g., concise, friendly, English, under 180 words">
            </div>
            <div class="form-group">
                <label>Hard rules / do not mention (optional)</label>
                <textarea id="email-taboos" rows="2" placeholder="e.g., Donâ€™t claim we met; avoid flattery; donâ€™t mention company X."></textarea>
            </div>
            <div class="form-group">
                <label>Evidence you want the email to cite (optional)</label>
                <p style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">
                    Paste links or short snippets youâ€™re confident are true. The model should not invent facts beyond these.
                </p>
                <textarea id="email-evidence" rows="3" placeholder="URLs or snippets to cite..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-secondary" id="btn-step4-back">â† Back to Targets</button>
                <button class="btn btn-primary" id="btn-step4-next" disabled>Generate Emails â†’</button>
            </div>
        </div>

        <!-- Step 5: Generate Email -->
        <div class="panel hidden" id="step-5">
            <h2><span class="icon">âœ‰ï¸</span> Step 5: Your Cold Emails</h2>
            <p class="panel-description">Here are your personalized cold emails ready to send!</p>

            <!-- Email Navigation for Multiple Targets -->
            <div class="hidden" id="email-nav" style="margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(139, 92, 246, 0.12); padding: 12px 20px; border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.2);">
                    <button class="btn btn-secondary btn-icon" id="btn-prev-email" disabled>â† Previous</button>
                    <span style="font-weight: 600; color: var(--accent);">Email <span id="current-email-num">1</span> of <span id="total-emails">1</span></span>
                    <button class="btn btn-secondary btn-icon" id="btn-next-email" disabled>Next â†’</button>
                </div>
            </div>

            <div class="loading" id="email-loading">
                <div class="spinner"></div>
                <div class="loading-text">Crafting the perfect emails... <span id="email-progress"></span></div>
            </div>

            <div class="hidden" id="email-result">
                <div id="target-info" style="margin-bottom: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 10px; color: #e0e0e8;">
                    <strong>To:</strong> <span id="email-target-name">-</span><br>
                    <strong>Field:</strong> <span id="email-target-field">-</span>
                </div>
                <div class="email-output" id="email-content">
                    <div class="email-editor-field">
                        <label class="email-editor-label" for="email-subject">Subject</label>
                        <button class="email-copy-inline" id="btn-copy-subject" type="button">Copy</button>
                        <input class="email-editor-input" id="email-subject" type="text" placeholder="Subject line..." />
                    </div>
                    <div class="email-editor-field" style="margin-bottom: 0;">
                        <label class="email-editor-label" for="email-body">Email</label>
                        <button class="email-copy-inline" id="btn-copy-body" type="button">Copy</button>
                        <textarea class="email-editor-textarea" id="email-body" placeholder="Email body..."></textarea>
                    </div>
                </div>

                <!-- Email Compare View (shown after regenerate) -->
                <div class="email-compare-container" id="email-compare">
                    <div class="email-version" id="version-original" data-version="original">
                        <span class="expand-hint">ðŸ” Double-click to edit</span>
                        <div class="email-version-header">
                            <span class="email-version-title">ðŸ“„ Original Version</span>
                            <span class="email-version-badge original">First Draft</span>
                        </div>
                        <div class="email-version-subject" id="compare-original-subject"></div>
                        <div class="email-version-preview" id="compare-original-body"></div>
                    </div>
                    <div class="email-version selected" id="version-regenerated" data-version="regenerated">
                        <span class="expand-hint">ðŸ” Double-click to edit</span>
                        <div class="email-version-header">
                            <span class="email-version-title">âœ¨ Regenerated Version</span>
                            <span class="email-version-badge regenerated">New Style</span>
                        </div>
                        <div class="email-version-subject" id="compare-regen-subject"></div>
                        <div class="email-version-preview" id="compare-regen-body"></div>
                    </div>
                </div>
                <div class="compare-actions hidden" id="compare-actions">
                    <button class="btn btn-secondary" id="btn-use-original">â† Use Original</button>
                    <button class="btn btn-primary" id="btn-use-regenerated">Use Regenerated âœ“</button>
                    <button class="btn btn-secondary" id="btn-close-compare">Close Compare</button>
                </div>

                <!-- Email Expand/Edit Modal -->
                <div class="email-expand-modal" id="email-expand-modal">
                    <div class="email-expand-content">
                        <div class="email-expand-header">
                            <div class="email-expand-title">
                                <span id="expand-modal-icon">ðŸ“„</span>
                                <span id="expand-modal-title">Edit Email</span>
                            </div>
                            <button class="email-expand-close" id="btn-expand-close">Ã—</button>
                        </div>
                        <div class="email-expand-body">
                            <div class="email-expand-field">
                                <div class="email-expand-label">Subject</div>
                                <input type="text" class="email-expand-input" id="expand-subject">
                            </div>
                            <div class="email-expand-field">
                                <div class="email-expand-label">Body</div>
                                <textarea class="email-expand-textarea" id="expand-body"></textarea>
                                <div class="email-expand-hint">ðŸ’¡ Click Save to apply your changes</div>
                            </div>
                        </div>
                        <div class="email-expand-footer">
                            <button class="btn btn-secondary" id="btn-expand-cancel">Cancel</button>
                            <button class="btn btn-primary" id="btn-expand-save">ðŸ’¾ Save Changes</button>
                        </div>
                    </div>
                </div>

                <!-- Regenerate Options -->
                <div class="regenerate-options visible" id="regenerate-section">
                    <h4>ðŸ”„ Want to adjust the tone?</h4>
                    <div class="style-options" id="style-options">
                        <div class="style-option" data-style="professional">ðŸ“‹ More Professional</div>
                        <div class="style-option" data-style="friendly">ðŸ˜Š More Friendly</div>
                        <div class="style-option" data-style="concise">âœ‚ï¸ More Concise</div>
                        <div class="style-option" data-style="detailed">ðŸ“ More Detailed</div>
                    <div class="style-option" data-style="custom">âœï¸ Custom</div>
                    </div>
                    <div class="custom-input" id="style-custom">
                        <textarea id="style-custom-input" rows="5" placeholder="Describe how you want to modify the email..."></textarea>
                    </div>
                    <button class="btn btn-primary" id="btn-regenerate" style="margin-top: 15px;">Regenerate This Email</button>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" id="btn-step5-back">â† Back to Template</button>
                    <button class="btn btn-secondary" id="btn-copy-all">ðŸ“‹ Copy All Emails</button>
                    <button class="btn btn-primary" id="btn-new-email">âœ¨ Start Over</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Start Onboarding -->
    <div class="modal-overlay" id="quick-onboarding-modal">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h3>âš¡ Quick Start Guide</h3>
                <button class="modal-close" id="btn-qs-onboarding-close" aria-label="Close">Ã—</button>
            </div>
            <p style="color: var(--muted); line-height: 1.7;">
                We collect a small amount of context about you and your outreach goal so the AI can (1) find relevant people and (2) write a personalized cold email that sounds like you.
            </p>
            <ul class="onboarding-list">
                <li><strong>What we collect:</strong> your purpose + field, plus optional resume / LinkedIn link / key notes (or 5 quick questions if you provide none).</li>
                <li><strong>Why we need it:</strong> to identify your strengths and generate an email that highlights the right points for the right person.</li>
                <li><strong>How targets are found:</strong> we use your context + preferences to recommend real people, then fetch details to personalize the email.</li>
                <li><strong>What you get:</strong> editable <em>Subject</em> + <em>Body</em>, with one-click copy for each.</li>
            </ul>
            <p style="color: var(--muted); line-height: 1.7; margin-top: 12px;">
                Youâ€™ll see a privacy notice on login that explains how data is used and handled.
            </p>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-top: 18px;">
                <label style="display: flex; align-items: center; gap: 10px; color: var(--muted); font-size: 13px;">
                    <input type="checkbox" id="qs-onboarding-dont-show">
                    Donâ€™t show this again
                </label>
                <button class="btn btn-primary" id="btn-qs-onboarding-ok" type="button">Got it</button>
            </div>
        </div>
    </div>

    <!-- Privacy Notice Modal -->
    <div class="modal-overlay" id="privacy-modal">
        <div class="modal-content" style="max-width: 550px; background: rgba(20, 20, 35, 0.95); border: 1px solid rgba(139, 92, 246, 0.3);">
            <div class="modal-header" style="border-bottom-color: rgba(34, 211, 238, 0.4);">
                <h3>ðŸ”’ Privacy Notice</h3>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 4em; margin-bottom: 10px;">ðŸ›¡ï¸</div>
                <h4 style="color: #f0f0f5; margin-bottom: 15px;">Your Privacy Matters to Us</h4>
            </div>
            <div class="profile-section" style="background: rgba(139, 92, 246, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(139, 92, 246, 0.2);">
                <p style="color: #c4b5fd; line-height: 1.8; margin-bottom: 15px;">
                    <strong>We want you to know:</strong>
                </p>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 10px 0; border-bottom: 1px solid rgba(139, 92, 246, 0.2); display: flex; align-items: flex-start; gap: 10px;">
                        <span style="color: #22d3ee; font-size: 1.2em;">âœ“</span>
                        <span style="color: #e0e0e8;">Your personal information and answers are <strong>only used</strong> for matching targets and generating professional emails.</span>
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid rgba(139, 92, 246, 0.2); display: flex; align-items: flex-start; gap: 10px;">
                        <span style="color: #22d3ee; font-size: 1.2em;">âœ“</span>
                        <span style="color: #e0e0e8;">Your data will <strong>not be shared</strong> with any third parties or used for any other purposes.</span>
                    </li>
                    <li style="padding: 10px 0; border-bottom: 1px solid rgba(139, 92, 246, 0.2); display: flex; align-items: flex-start; gap: 10px;">
                        <span style="color: #22d3ee; font-size: 1.2em;">âœ“</span>
                        <span style="color: #e0e0e8;">Uploaded resumes and profile information are processed <strong>securely</strong>. We may store your profile under your account so you can continue later.</span>
                    </li>
                    <li style="padding: 10px 0; display: flex; align-items: flex-start; gap: 10px;">
                        <span style="color: #22d3ee; font-size: 1.2em;">âœ“</span>
                        <span style="color: #e0e0e8;">You can log out at any time and your session data will be cleared.</span>
                    </li>
                </ul>
            </div>
            <div style="text-align: center;">
                <p style="color: #a0a0b0; font-size: 13px; margin-bottom: 20px;">
                    By continuing, you acknowledge that you have read and understood this privacy notice.
                </p>
                <button class="btn btn-primary" id="btn-privacy-accept" style="min-width: 200px;">
                    âœ… I Understand, Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Target Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-target-name">Target Profile</h3>
                <button class="modal-close" onclick="closeProfileModal()">Ã—</button>
            </div>
            <div class="profile-section">
                <h4>ðŸŽ¯ Position</h4>
                <p id="modal-position">-</p>
            </div>
            <div class="profile-section" id="modal-linkedin-section" style="display: none;">
                <h4>ðŸ”— LinkedIn Profile</h4>
                <p><a id="modal-linkedin-url" href="#" target="_blank" style="color: #0a66c2; display: inline-flex; align-items: center; gap: 6px;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                    <span id="modal-linkedin-text">View Profile</span>
                </a></p>
            </div>
            <div class="profile-section">
                <h4>ðŸ“Š Match Score</h4>
                <p id="modal-match-score">-</p>
            </div>
            <div class="profile-section">
                <h4>ðŸ“¬ Response Likelihood</h4>
                <p id="modal-response-likelihood">-</p>
            </div>
            <div class="profile-section">
                <h4>ðŸ’¡ Why This Match</h4>
                <p id="modal-match-reason">-</p>
            </div>
            <div class="profile-section">
                <h4>ðŸ¤ Common Interests</h4>
                <p id="modal-common-interests">-</p>
            </div>
            <div class="profile-section">
                <h4>âœ‰ï¸ Outreach Angle</h4>
                <p id="modal-outreach-angle">-</p>
            </div>
            <div class="profile-section">
                <h4>ðŸŽ“ Education</h4>
                <ul id="modal-education"><li>-</li></ul>
            </div>
            <div class="profile-section">
                <h4>ðŸ’¼ Experience</h4>
                <ul id="modal-experience"><li>-</li></ul>
            </div>
            <div class="profile-section">
                <h4>ðŸ› ï¸ Skills</h4>
                <ul id="modal-skills"><li>-</li></ul>
            </div>
            <div class="profile-section">
                <h4>ðŸ“‚ Projects</h4>
                <ul id="modal-projects"><li>-</li></ul>
            </div>
            <div class="profile-section">
                <h4>ðŸ”Ž Evidence</h4>
                <ul id="modal-evidence"><li>-</li></ul>
            </div>
            <div class="profile-section">
                <h4>ðŸ”— Sources</h4>
                <ul id="modal-sources"><li>-</li></ul>
            </div>
            <div class="profile-section">
                <h4>âš ï¸ Uncertainty</h4>
                <p id="modal-uncertainty">-</p>
            </div>
            <div class="btn-group" style="justify-content: center;">
                <button class="btn btn-primary" onclick="selectFromModal()">âœ… Select This Target</button>
            </div>
        </div>
    </div>

    <script>
        // Toast notification function
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Generate unique session ID
        function generateSessionId() {
            const timestamp = Date.now().toString(36);
            const randomPart = Math.random().toString(36).substring(2, 10);
            return `${timestamp}-${randomPart}`;
        }

        // Server-provided persisted profile (per logged-in user)
        const INITIAL_SENDER_PROFILE = {{ initial_sender_profile | tojson }};
        const INITIAL_PREFERENCES = {{ initial_preferences | tojson }};
        
        // Global state
        const state = {
            sessionId: generateSessionId(),  // Unique session ID for this user session
            mode: null,  // 'quick' or 'professional'
            proTrack: null,  // 'finance' or 'academic' (for professional mode)
            proTargetChoice: null,  // 'have' or 'need' (for professional mode)
            proPreferenceHistory: [],  // Professional mode preference Q&A
            financePreferences: null,  // Structured finance preferences (Professional/Finance track)
            step: 1,
            purpose: null,
            purposeCustom: '',
            field: null,
            fieldCustom: '',
            targetPrefs: {
                field: '',
                fieldCustom: '',
                seniority: '',
                orgType: '',
                outreachGoal: '',
                prominence: ''
            },
            hasResume: null,
            senderProfile: INITIAL_SENDER_PROFILE || null,
            questionnaireHistory: [], // [{ question, answer }]
            questionnaireQuestions: [], // Batch questions (Quick Start)
            questionnaireIndex: 0,
            questionnaireAnswers: [], // string[] aligned to questionnaireQuestions
            quickQuestionsEnabled: false, // Quick Start: only show questions after explicit action
            hasTarget: null,
            selectedTargets: [],  // Array of selected targets
            currentEmailIndex: 0,  // Current email being viewed
            recommendations: [],
            generatedEmails: [],  // Array of {target, email} objects
            senderProfileLink: '',
            senderProfileExtra: '',
            targetProfileLink: '',
            targetProfileExtra: '',
            // Optional targeting context (Step 3 / Professional preferences)
            targetSearchIntent: '',
            targetMustHave: '',
            targetMustNot: '',
            targetLocation: '',
            targetExamples: '',
            targetEvidence: '',
            targetContactability: 'balanced', // balanced | reply | prestige
            // Optional email context (Step 4)
            emailGoal: '',
            emailAsk: '',
            emailValue: '',
            emailConstraints: '',
            emailTaboos: '',
            emailEvidence: '',
            targetPreferenceHistory: [],
            generationMode: null,  // 'smart' or 'template'
            regenerateStyle: null,
            manualTargetProfile: null,  // Profile from uploaded document
            currentModalTarget: null  // Target being viewed in modal
        };

        // Purpose field mapping for better prompts
        const purposeLabels = {
            'academic': 'Academic Outreach (research opportunities, PhD applications)',
            'job': 'Job Seeking (employment opportunities)',
            'coffee': 'Coffee Chat (networking and learning)',
            'other': ''
        };

        // Field labels for better display
        const fieldLabels = {
            'ai-ml': 'AI / Machine Learning',
            'software': 'Software Engineering',
            'finance': 'Finance / Fintech',
            'other-field': ''
        };

        function getFreshState(mode) {
            return {
                mode,
                proTrack: null,
                proTargetChoice: null,
                proPreferenceHistory: [],
                financePreferences: null,
                step: 1,
                purpose: null,
                purposeCustom: '',
                field: null,
                fieldCustom: '',
                targetPrefs: {
                    field: '',
                    fieldCustom: '',
                    seniority: '',
                    orgType: '',
                    outreachGoal: '',
                    prominence: ''
                },
                hasResume: mode === 'quick' ? false : null,
                senderProfile: INITIAL_SENDER_PROFILE || null,
                questionnaireHistory: [],
                questionnaireQuestions: [],
                questionnaireIndex: 0,
                questionnaireAnswers: [],
                quickQuestionsEnabled: false,
                hasTarget: null,
                selectedTargets: [],
                currentEmailIndex: 0,
                recommendations: [],
                generatedEmails: [],
                senderProfileLink: '',
                senderProfileExtra: '',
                targetProfileLink: '',
                targetProfileExtra: '',
                targetSearchIntent: '',
                targetMustHave: '',
                targetMustNot: '',
                targetLocation: '',
                targetExamples: '',
                targetEvidence: '',
                targetContactability: 'balanced',
                emailGoal: '',
                emailAsk: '',
                emailValue: '',
                emailConstraints: '',
                emailTaboos: '',
                emailEvidence: '',
                targetPreferenceHistory: [],
                generationMode: null,
                regenerateStyle: null,
                manualTargetProfile: null,
                currentModalTarget: null
            };
        }

        function resetStepsUI() {
            for (let i = 1; i <= 5; i++) {
                const stepPanel = document.getElementById(`step-${i}`);
                const indicator = document.getElementById(`step-indicator-${i}`);
                if (stepPanel) stepPanel.classList.add('hidden');
                if (indicator) indicator.classList.remove('active', 'completed');
                if (i < 5) {
                    const connector = document.getElementById(`connector-${i}`);
                    if (connector) connector.classList.remove('completed');
                }
            }
        }

        function updateModeSwitcherUI(mode) {
            const pills = document.querySelectorAll('#global-mode-switcher .mode-pill');
            pills.forEach(pill => {
                pill.classList.toggle('active', pill.dataset.mode === mode);
            });
        }

        function resetFormsAndPanels(mode) {
            resetStepsUI();
            document.querySelectorAll('.panel').forEach(panel => panel.classList.add('hidden'));

            ['privacy-modal', 'profile-modal', 'quick-onboarding-modal'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('visible');
            });

            const progress = document.getElementById('progress-container');
            if (progress) progress.classList.add('hidden');

            document.querySelectorAll('.option-card.selected, .choice-btn.selected, .style-option.selected, .mode-card.selected')
                .forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.questionnaire.visible').forEach(el => el.classList.remove('visible'));

            ['purpose-custom', 'field-custom', 'pref-field-custom', 'style-custom'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('visible');
            });

            ['resume-upload-section', 'resume-success', 'quick-start-notice', 'target-preferences', 'target-advanced', 'manual-target-section', 'recommendation-section', 'email-nav', 'email-result', 'target-doc-success', 'pro-target-advanced']
                .forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
            const targetAdvBtn = document.getElementById('btn-toggle-target-advanced');
            if (targetAdvBtn) targetAdvBtn.textContent = 'âš™ï¸ Add more targeting details (optional)';
            const proTargetAdvBtn = document.getElementById('btn-toggle-pro-target-advanced');
            if (proTargetAdvBtn) proTargetAdvBtn.textContent = 'âš™ï¸ Add more targeting details (optional)';

            ['target-questionnaire', 'questionnaire-section'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('visible');
            });

            const resumeChoice = document.getElementById('resume-choice-section');
            if (resumeChoice) resumeChoice.classList.remove('hidden');

            const targetDocSection = document.getElementById('target-doc-upload-section');
            if (targetDocSection) {
                if (mode === 'quick') {
                    targetDocSection.classList.add('hidden');
                } else {
                    targetDocSection.classList.remove('hidden');
                }
            }

            const recActions = document.getElementById('rec-actions');
            if (recActions) recActions.style.display = 'none';

            const matchDetails = document.getElementById('match-details');
            if (matchDetails) matchDetails.classList.remove('visible');

            ['pro-track-selection', 'pro-resume-upload', 'pro-target-choice', 'pro-preferences', 'pro-resume-success']
                .forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });

            ['pro-upload-loading', 'pro-pref-loading'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            const proSummary = document.getElementById('pro-resume-summary');
            if (proSummary) proSummary.innerHTML = '';

            ['questions-container', 'target-questions-container', 'recommendation-list', 'selected-target-tags'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.replaceChildren();
            });

            const emailSubject = document.getElementById('email-subject');
            if (emailSubject) emailSubject.value = '';
            const emailBody = document.getElementById('email-body');
            if (emailBody) emailBody.value = '';

            ['match-score-text', 'match-interests-text', 'match-reason-text'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '-';
            });

            const selectedCount = document.getElementById('selected-count');
            if (selectedCount) selectedCount.textContent = '0';

            const emailProgress = document.getElementById('email-progress');
            if (emailProgress) emailProgress.textContent = '';

            const emailTargetName = document.getElementById('email-target-name');
            if (emailTargetName) emailTargetName.textContent = '-';

            const emailTargetField = document.getElementById('email-target-field');
            if (emailTargetField) emailTargetField.textContent = '-';

            const currentEmailNum = document.getElementById('current-email-num');
            const totalEmails = document.getElementById('total-emails');
            if (currentEmailNum) currentEmailNum.textContent = '1';
            if (totalEmails) totalEmails.textContent = '1';

            ['upload-loading', 'questionnaire-loading', 'target-questionnaire-loading', 'rec-loading', 'email-loading', 'target-doc-loading'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('visible');
            });

            const quickPrompt = document.getElementById('quick-question-prompt');
            if (quickPrompt) quickPrompt.classList.add('hidden');

            document.querySelectorAll('input[type="text"], textarea').forEach(el => {
                el.value = '';
            });
            document.querySelectorAll('input[type="file"]').forEach(el => {
                el.value = '';
            });

            const templateSection = document.getElementById('email-template-section');
            if (templateSection) templateSection.classList.add('hidden');

            ['btn-step1-next', 'btn-step2-next', 'btn-step3-next', 'btn-step4-next', 'btn-find-matches', 'btn-resume-next', 'btn-track-next', 'btn-target-choice-next']
                .forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.disabled = true;
                });
        }

        function startModeFlow(mode, options = {}) {
            const { confirmSwitch = false } = options;
            if (mode !== 'quick' && mode !== 'professional') return;

            if (confirmSwitch && state.mode && state.mode !== mode) {
                const ok = confirm('Switching mode will reset your current progress. Continue?');
                if (!ok) {
                    updateModeSwitcherUI(state.mode);
                    return;
                }
            }

            Object.assign(state, getFreshState(mode));
            resetFormsAndPanels(mode);
            resetRecommendationState();
            updateModeSwitcherUI(mode);

            const modeSelection = document.getElementById('mode-selection');
            if (modeSelection) modeSelection.classList.add('hidden');

            if (mode === 'quick') {
                const progress = document.getElementById('progress-container');
                if (progress) progress.classList.remove('hidden');
                goToStep(1);
                maybeShowQuickStartOnboarding();
            } else if (mode === 'professional') {
                const trackPanel = document.getElementById('pro-track-selection');
                if (trackPanel) trackPanel.classList.remove('hidden');
            }
        }

        function setupGlobalModeSwitcher() {
            const switcher = document.getElementById('global-mode-switcher');
            if (!switcher) return;

            const pills = switcher.querySelectorAll('.mode-pill');
            pills.forEach(pill => {
                pill.addEventListener('click', function() {
                    const targetMode = this.dataset.mode;
                    const modeSelection = document.getElementById('mode-selection');
                    const modeSelectionVisible = modeSelection ? !modeSelection.classList.contains('hidden') : false;
                    if (targetMode === state.mode && !modeSelectionVisible) {
                        return;
                    }
                    const shouldConfirm = Boolean(state.mode && state.mode !== targetMode);
                    startModeFlow(targetMode, { confirmSwitch: shouldConfirm });
                });
            });

            updateModeSwitcherUI(state.mode);
        }

        function setupQuickStartOnboarding() {
            const overlay = document.getElementById('quick-onboarding-modal');
            if (!overlay) return;

            const close = document.getElementById('btn-qs-onboarding-close');
            const ok = document.getElementById('btn-qs-onboarding-ok');
            const dontShow = document.getElementById('qs-onboarding-dont-show');

            function dismiss() {
                overlay.classList.remove('visible');
                if (dontShow && dontShow.checked) {
                    try {
                        localStorage.setItem('qs_onboarding_dismissed', '1');
                    } catch (e) {}
                }
            }

            if (close) close.addEventListener('click', dismiss);
            if (ok) ok.addEventListener('click', dismiss);

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) dismiss();
            });
        }

        function maybeShowQuickStartOnboarding() {
            if (state.mode !== 'quick') return;
            let dismissed = false;
            try {
                dismissed = localStorage.getItem('qs_onboarding_dismissed') === '1';
            } catch (e) {}
            if (dismissed) return;
            const overlay = document.getElementById('quick-onboarding-modal');
            if (overlay) overlay.classList.add('visible');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupGlobalModeSwitcher();
            setupModeSelection();
            setupProfessionalMode();
            setupOptionCards();
            setupChoiceButtons();
            setupFileUpload();
            setupProfileLinkInputs();
            setupTargetingContextInputs();
            setupEmailContextInputs();
            setupNavigationButtons();
            setupQuickStartQuestionPrompt();
            setupQuickStartOnboarding();
            setupGenerationMode();
            setupRegenerate();
            setupCompareView();
            setupTargetDocUpload();
            setupPreferenceForm();
        });

        // Setup mode selection
        function setupModeSelection() {
            const modeCards = document.querySelectorAll('#mode-selection .mode-card');
            const modeNextBtn = document.getElementById('btn-mode-next');
            
            modeCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Skip if disabled
                    if (this.classList.contains('disabled')) {
                        return;
                    }
                    
                    // Deselect all, select current
                    modeCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.mode = this.dataset.mode;
                    updateModeSwitcherUI(state.mode);
                    
                    // Enable continue button
                    modeNextBtn.disabled = false;
                });
            });
            
            // Mode continue button - show privacy notice first
            modeNextBtn.addEventListener('click', function() {
                if (!state.mode) return;
                
                // Show privacy modal
                document.getElementById('privacy-modal').classList.add('visible');
            });
            
            // Privacy accept button
            document.getElementById('btn-privacy-accept').addEventListener('click', function() {
                document.getElementById('privacy-modal').classList.remove('visible');
                startModeFlow(state.mode, { confirmSwitch: false });
            });
        }

        // Setup Professional Mode
        function setupProfessionalMode() {
            // Track selection (Finance / Academic)
            const trackCards = document.querySelectorAll('#pro-track-selection .mode-card');
            const trackNextBtn = document.getElementById('btn-track-next');
            
            trackCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Check if card is locked
                    if (this.classList.contains('locked')) {
                        showToast('ðŸ”’ Academic mode is currently under development. Coming soon!', 'info');
                        return;
                    }
                    trackCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.proTrack = this.dataset.track;
                    trackNextBtn.disabled = false;
                });
            });
            
            // Track back button
            document.getElementById('btn-track-back').addEventListener('click', function() {
                document.getElementById('pro-track-selection').classList.add('hidden');
                document.getElementById('mode-selection').classList.remove('hidden');
                state.proTrack = null;
                trackCards.forEach(c => c.classList.remove('selected'));
                trackNextBtn.disabled = true;
            });
            
            // Track next button -> Resume upload
            trackNextBtn.addEventListener('click', function() {
                document.getElementById('pro-track-selection').classList.add('hidden');
                document.getElementById('pro-resume-upload').classList.remove('hidden');
                // Update display text
                const trackDisplay = state.proTrack === 'finance' ? 'Finance' : 'Academic';
                document.getElementById('selected-track-display').textContent = trackDisplay;
            });
            
            // Resume dropzone
            const dropzone = document.getElementById('pro-resume-dropzone');
            const fileInput = document.getElementById('pro-resume-file');
            
            dropzone.addEventListener('click', () => fileInput.click());
            
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.style.borderColor = '#5856d6';
                dropzone.style.background = '#f0f4ff';
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.style.borderColor = '#0071e3';
                dropzone.style.background = '#f8f9ff';
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.style.borderColor = '#0071e3';
                dropzone.style.background = '#f8f9ff';
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    uploadProResume(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    uploadProResume(this.files[0]);
                }
            });
            
            // Resume back button
            document.getElementById('btn-resume-back').addEventListener('click', function() {
                document.getElementById('pro-resume-upload').classList.add('hidden');
                document.getElementById('pro-track-selection').classList.remove('hidden');
            });
            
            // Resume next button -> Target choice
            document.getElementById('btn-resume-next').addEventListener('click', function() {
                document.getElementById('pro-resume-upload').classList.add('hidden');
                document.getElementById('pro-target-choice').classList.remove('hidden');
            });
            
            // Target choice cards
            const targetChoiceCards = document.querySelectorAll('#pro-target-choice .mode-card');
            const targetChoiceNextBtn = document.getElementById('btn-target-choice-next');
            
            targetChoiceCards.forEach(card => {
                card.addEventListener('click', function() {
                    targetChoiceCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.proTargetChoice = this.dataset.targetChoice;
                    targetChoiceNextBtn.disabled = false;
                });
            });
            
            // Target choice back button
            document.getElementById('btn-target-choice-back').addEventListener('click', function() {
                document.getElementById('pro-target-choice').classList.add('hidden');
                document.getElementById('pro-resume-upload').classList.remove('hidden');
            });
            
            // Target choice next button
            targetChoiceNextBtn.addEventListener('click', function() {
                document.getElementById('pro-target-choice').classList.add('hidden');
                
                if (state.proTargetChoice === 'have') {
                    // User has targets - go directly to Step 3 (manual target input)
                    // Set up state based on track selection
                    state.purpose = state.proTrack === 'academic' ? 'academic' : 'job';
                    state.field = state.proTrack === 'academic' ? 'ai-ml' : 'finance';
                    state.hasResume = true;
                    state.hasTarget = true;
                    
                    // Show progress bar and go to step 3
                    document.getElementById('progress-container').classList.remove('hidden');
                    goToStep(3);
                    
                    // Show manual target input section, hide recommendation section
                    document.getElementById('manual-target-section').classList.remove('hidden');
                    document.getElementById('recommendation-section').classList.add('hidden');
                    document.getElementById('auto-target-section').classList.add('hidden');
                    
                    // Update Step 3 title for clarity
                    const step3Title = document.querySelector('#step-3 h2');
                    if (step3Title) {
                        step3Title.innerHTML = '<span class="icon">ðŸ‘¤</span> Step 3: Enter Your Target';
                    }
                } else {
                    // User needs recommendations - show preference questions
                    document.getElementById('pro-preferences').classList.remove('hidden');
                    const trackDisplay = state.proTrack === 'finance' ? 'Finance' : 'Academic';
                    document.getElementById('pref-track-display').textContent = trackDisplay;
                    loadProPreferenceQuestions();
                }
            });
            
            // Preference back button
            document.getElementById('btn-pref-back').addEventListener('click', function() {
                document.getElementById('pro-preferences').classList.add('hidden');
                document.getElementById('pro-target-choice').classList.remove('hidden');
            });
            
            // Find targets button
            document.getElementById('btn-find-pro-targets').addEventListener('click', async function() {
                await findProTargets();
            });
        }

        // Upload resume for Professional mode
        async function uploadProResume(file) {
            const loading = document.getElementById('pro-upload-loading');
            const success = document.getElementById('pro-resume-success');
            const nextBtn = document.getElementById('btn-resume-next');
            
            loading.classList.remove('hidden');
            success.classList.add('hidden');
            
            const formData = new FormData();
            formData.append('pdf', file);
            formData.append('session_id', state.sessionId);
            
            try {
                const response = await fetch('/api/upload-sender-pdf', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    state.senderProfile = data.profile;
                    loading.classList.add('hidden');
                    success.classList.remove('hidden');
                    nextBtn.disabled = false;
                    
                    // Show resume summary
                    const summary = document.getElementById('pro-resume-summary');
                    summary.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <strong style="color: var(--accent);">ðŸ‘¤ Name:</strong>
                                <p style="margin: 5px 0;">${data.profile.name || 'Not detected'}</p>
                            </div>
                            <div>
                                <strong style="color: var(--accent);">ðŸŽ“ Education:</strong>
                                <p style="margin: 5px 0;">${(data.profile.education || []).slice(0, 2).join(', ') || 'Not detected'}</p>
                            </div>
                            <div>
                                <strong style="color: var(--accent);">ðŸ’¼ Experience:</strong>
                                <p style="margin: 5px 0;">${(data.profile.experiences || []).slice(0, 2).join(', ') || 'Not detected'}</p>
                            </div>
                            <div>
                                <strong style="color: var(--accent);">ðŸ› ï¸ Skills:</strong>
                                <p style="margin: 5px 0;">${(data.profile.skills || []).slice(0, 5).join(', ') || 'Not detected'}</p>
                            </div>
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                loading.classList.add('hidden');
                alert('Error uploading resume: ' + error.message);
            }
        }

        // Finance decision-tree preferences (Professional / Finance track only)
        // G â€” Primary direction (single)
        // S â€” Sector / Group â†’ O â€” Firm type â†’ M â€” Location â†’ Seniority â†’ Optional preferences
        const FINANCE_MAX_QUESTIONS = 16;
        const FINANCE_FIXED_QUESTIONS = [
            {
                id: 'career_directions',
                question: 'G: What is your PRIMARY finance direction right now? (Select one)',
                type: 'single',
                options: [
                    { value: 'ib', label: 'Investment Banking (IB)' },
                    { value: 'st', label: 'Sales & Trading (S&T)' },
                    { value: 'pe', label: 'Private Equity / Growth Equity' },
                    { value: 'hf', label: 'Hedge Fund' },
                    { value: 'am', label: 'Asset / Wealth Management' },
                    { value: 'er', label: 'Equity Research' },
                    { value: 'corp_fin', label: 'Corporate Finance / Strategy' },
                    { value: 'unsure', label: 'Not sure yet â€” keep it broad' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'e.g., Consulting, Risk, Fintech, ...' }
            },

            // Investment Banking (IB)
            {
                id: 'ib_firm_type',
                question: 'O: IB â€” What type of firm are you targeting? (Select all that apply)',
                type: 'multi',
                dependsOn: 'career_directions',
                showIf: ['ib'],
                options: [
                    { value: 'bb', label: 'Bulge Bracket' },
                    { value: 'eb', label: 'Elite Boutique' },
                    { value: 'mm', label: 'Middle Market' },
                    { value: 'industry_boutique', label: 'Industry Boutique' },
                    { value: 'regional', label: 'Regional Investment Bank' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Firm type / examples...' }
            },
            {
                id: 'ib_group_type',
                question: 'S: IB â€” Which group type are you most interested in?',
                type: 'single',
                dependsOn: 'career_directions',
                showIf: ['ib'],
                options: [
                    { value: 'coverage', label: 'Industry Coverage' },
                    { value: 'product', label: 'Product Group' },
                    { value: 'both', label: 'Both / flexible' },
                    { value: 'unsure', label: 'Not sure yet' }
                ]
            },
            {
                id: 'ib_coverage_industries',
                question: 'S: IB Coverage â€” Which industries interest you? (Select all that apply)',
                type: 'multi',
                dependsOn: 'ib_group_type',
                showIf: ['coverage', 'both'],
                options: [
                    { value: 'tmt', label: 'Technology / TMT' },
                    { value: 'healthcare', label: 'Healthcare' },
                    { value: 'industrials', label: 'Industrials' },
                    { value: 'consumer', label: 'Consumer & Retail' },
                    { value: 'fig', label: 'Financial Institutions Group (FIG)' },
                    { value: 'energy', label: 'Energy / Power / Infrastructure' },
                    { value: 'real_estate', label: 'Real Estate' },
                    { value: 'media', label: 'Media & Entertainment' },
                    { value: 'telecom', label: 'Telecom' },
                    { value: 'gaming_sports', label: 'Gaming / Sports' },
                    { value: 'chemicals', label: 'Chemicals' },
                    { value: 'transportation', label: 'Transportation / Aviation' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other industries...' }
            },
            {
                id: 'ib_product_groups',
                question: 'S: IB Product â€” Which product groups interest you? (Select all that apply)',
                type: 'multi',
                dependsOn: 'ib_group_type',
                showIf: ['product', 'both'],
                options: [
                    { value: 'ma', label: 'Mergers & Acquisitions (M&A)' },
                    { value: 'ecm', label: 'Equity Capital Markets (ECM)' },
                    { value: 'dcm', label: 'Debt Capital Markets (DCM)' },
                    { value: 'lev_fin', label: 'Leveraged Finance' },
                    { value: 'restructuring', label: 'Distressed / Restructuring' },
                    { value: 'cross_border', label: 'Cross-border Transactions' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other product groups...' }
            },

            // Sales & Trading (S&T)
            {
                id: 'st_function',
                question: 'S: S&T â€” Which area are you most interested in?',
                type: 'single',
                dependsOn: 'career_directions',
                showIf: ['st'],
                options: [
                    { value: 'sales', label: 'Sales' },
                    { value: 'trading', label: 'Trading' },
                    { value: 'structuring', label: 'Structuring' },
                    { value: 'unsure', label: 'Not sure yet' }
                ]
            },
            {
                id: 'st_sales_area',
                question: 'S: S&T Sales â€” Which area? (Select all that apply)',
                type: 'multi',
                dependsOn: 'st_function',
                showIf: ['sales'],
                options: [
                    { value: 'equities_sales', label: 'Equities Sales' },
                    { value: 'fixed_income_sales', label: 'Fixed Income Sales' },
                    { value: 'prime_brokerage_sales', label: 'Prime Brokerage Sales' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other sales area...' }
            },
            {
                id: 'st_trading_area',
                question: 'S: S&T Trading â€” Which desk/asset class? (Select all that apply)',
                type: 'multi',
                dependsOn: 'st_function',
                showIf: ['trading'],
                options: [
                    { value: 'equities_trading', label: 'Equities Trading' },
                    { value: 'fixed_income_trading', label: 'Fixed Income Trading' },
                    { value: 'rates_trading', label: 'Rates Trading' },
                    { value: 'credit_trading', label: 'Credit Trading' },
                    { value: 'fx_trading', label: 'FX Trading' },
                    { value: 'commodities_trading', label: 'Commodities Trading' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other trading area...' }
            },
            {
                id: 'st_structuring_area',
                question: 'S: S&T Structuring â€” Which area? (Select all that apply)',
                type: 'multi',
                dependsOn: 'st_function',
                showIf: ['structuring'],
                options: [
                    { value: 'equity_derivatives_structuring', label: 'Equity Derivatives Structuring' },
                    { value: 'credit_structuring', label: 'Credit Structuring' },
                    { value: 'rates_structuring', label: 'Rates Structuring' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other structuring area...' }
            },

            // Private Equity / Growth Equity
            {
                id: 'pe_fund_type',
                question: 'O: PE/GE â€” What type of fund are you targeting?',
                type: 'single',
                dependsOn: 'career_directions',
                showIf: ['pe'],
                options: [
                    { value: 'large_cap_pe', label: 'Large-cap PE' },
                    { value: 'mid_market_pe', label: 'Mid-market PE' },
                    { value: 'growth_equity', label: 'Growth Equity' },
                    { value: 'venture_capital', label: 'Venture Capital' },
                    { value: 'sector_focused_pe', label: 'Sector-focused PE' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other fund type...' }
            },
            {
                id: 'pe_industry_focus',
                question: 'S: PE/GE â€” Any preferred industry focus? (Select all that apply)',
                type: 'multi',
                dependsOn: 'career_directions',
                showIf: ['pe'],
                options: [
                    { value: 'technology', label: 'Technology' },
                    { value: 'healthcare', label: 'Healthcare' },
                    { value: 'consumer', label: 'Consumer' },
                    { value: 'industrials', label: 'Industrials' },
                    { value: 'financials', label: 'Financial Services' },
                    { value: 'energy', label: 'Energy' },
                    { value: 'real_estate', label: 'Real Estate' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other industries...' }
            },

            // Hedge Fund
            {
                id: 'hf_strategy',
                question: 'S: HF â€” What strategy are you most interested in? (Select all that apply)',
                type: 'multi',
                dependsOn: 'career_directions',
                showIf: ['hf'],
                options: [
                    { value: 'l_s_equity', label: 'Long/Short Equity' },
                    { value: 'global_macro', label: 'Global Macro' },
                    { value: 'event_driven', label: 'Event-driven' },
                    { value: 'quant', label: 'Quant / Systematic' },
                    { value: 'multi_strat', label: 'Multi-strategy' },
                    { value: 'credit_distressed', label: 'Credit / Distressed' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other strategies...' }
            },
            {
                id: 'hf_role',
                question: 'S: HF â€” Which role(s) are you targeting? (Select all that apply)',
                type: 'multi',
                dependsOn: 'career_directions',
                showIf: ['hf'],
                options: [
                    { value: 'analyst', label: 'Analyst' },
                    { value: 'trader', label: 'Trader' },
                    { value: 'quant_research', label: 'Quant Research' },
                    { value: 'portfolio_analyst', label: 'Portfolio Analyst' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other roles...' }
            },

            // Asset / Wealth Management
            {
                id: 'am_track',
                question: 'O: AM/WM â€” Which area are you targeting?',
                type: 'single',
                dependsOn: 'career_directions',
                showIf: ['am'],
                options: [
                    { value: 'asset_management', label: 'Asset Management' },
                    { value: 'wealth_management', label: 'Wealth Management / Private Banking' },
                    { value: 'unsure', label: 'Not sure yet' }
                ]
            },
            {
                id: 'am_asset_class',
                question: 'S: Asset Management â€” Which asset class(es)? (Select all that apply)',
                type: 'multi',
                dependsOn: 'am_track',
                showIf: ['asset_management'],
                options: [
                    { value: 'equities', label: 'Equities' },
                    { value: 'fixed_income', label: 'Fixed Income' },
                    { value: 'multi_asset', label: 'Multi-Asset' },
                    { value: 'alternatives', label: 'Alternatives' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other asset classes...' }
            },

            // Equity Research
            {
                id: 'er_industry',
                question: 'S: Equity Research â€” Which coverage sector(s)? (Select all that apply)',
                type: 'multi',
                dependsOn: 'career_directions',
                showIf: ['er'],
                options: [
                    { value: 'technology', label: 'Technology' },
                    { value: 'healthcare', label: 'Healthcare' },
                    { value: 'consumer', label: 'Consumer' },
                    { value: 'industrials', label: 'Industrials' },
                    { value: 'energy', label: 'Energy' },
                    { value: 'financials', label: 'Financials' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other sectors...' }
            },
            {
                id: 'er_role',
                question: 'O: Equity Research â€” Which role are you targeting?',
                type: 'single',
                dependsOn: 'career_directions',
                showIf: ['er'],
                options: [
                    { value: 'research_analyst', label: 'Research Analyst' },
                    { value: 'associate', label: 'Associate' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other role...' }
            },

            // Corporate Finance / Strategy
            {
                id: 'corp_role',
                question: 'S: Corporate Finance / Strategy â€” Which area? (Select all that apply)',
                type: 'multi',
                dependsOn: 'career_directions',
                showIf: ['corp_fin'],
                options: [
                    { value: 'corp_dev', label: 'Corporate Development' },
                    { value: 'fpa', label: 'FP&A' },
                    { value: 'strategy_bizops', label: 'Strategy / BizOps' },
                    { value: 'treasury', label: 'Treasury' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other areas...' }
            },

            // Market / Location
            {
                id: 'market_location',
                question: 'M: Which market/location are you targeting? (Select all that apply)',
                type: 'multi',
                options: [
                    { value: 'new_york', label: 'New York' },
                    { value: 'london', label: 'London' },
                    { value: 'hong_kong', label: 'Hong Kong' },
                    { value: 'singapore', label: 'Singapore' },
                    { value: 'san_francisco', label: 'San Francisco / Bay Area' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'e.g., Toronto, Dubai, Frankfurt, Sydney...' }
            },

            // Seniority (who to talk to)
            {
                id: 'target_seniority',
                question: 'Seniority: Who do you want to talk to? (Select all that apply)',
                type: 'multi',
                options: [
                    { value: 'analyst', label: 'Analyst (Year 1-3)' },
                    { value: 'associate', label: 'Associate (Year 4-6)' },
                    { value: 'vp_director', label: 'VP / Director (Year 7-9)' },
                    { value: 'ed_svp', label: 'Executive Director / SVP (Year 10-12)' },
                    { value: 'md', label: 'Managing Director (Year 12+)' },
                    { value: 'other', label: 'Other (please specify)' }
                ],
                custom: { optionValue: 'other', placeholder: 'Other seniority/role...' }
            },

            // Optional Preferences
	            {
	                id: 'outreach_goal',
	                question: 'Optional: What is your primary goal for connecting?',
	                type: 'single',
	                options: [
	                    { value: 'learn_role', label: 'Learn about their day-to-day role and responsibilities' },
	                    { value: 'career_advice', label: 'Get career advice and guidance on breaking in' },
	                    { value: 'referral', label: 'Explore referral opportunities for open positions' },
	                    { value: 'industry_insight', label: 'Gain industry insights and market knowledge' },
	                    { value: 'mentorship', label: 'Seek mentorship or long-term guidance' },
	                    { value: 'other', label: 'Other (please specify)' }
	                ],
	                custom: { optionValue: 'other', placeholder: 'Your goal...' }
	            }
	        ];

        // State for finance fixed questions
        let financeQuestionIndex = 0;
        let financeAnswers = {};
        let financeCustomAnswers = {};
        let financeQuestionHistory = []; // [{ questionIndex, questionId }]
        let financeDraftAnswers = {}; // { [questionId]: { values: string[], customText: string } }

        // Load preference questions for Professional mode
        async function loadProPreferenceQuestions() {
            const container = document.getElementById('pro-preference-questions');
            const loading = document.getElementById('pro-pref-loading');
            
            container.innerHTML = '';
            loading.classList.remove('hidden');

            // For Finance track, use fixed questions
            if (state.proTrack === 'finance') {
                loading.classList.add('hidden');
                financeQuestionIndex = 0;
                financeAnswers = {};
                financeCustomAnswers = {};
                financeQuestionHistory = [];
                financeDraftAnswers = {};
                renderFinanceFixedQuestion();
                return;
            }
            
            try {
                const response = await fetch('/api/next-target-question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        purpose: state.proTrack === 'academic' ? 'Academic research and PhD opportunities' : 'Finance and investment opportunities',
                        field: state.proTrack === 'academic' ? 'Academic Research' : 'Finance',
                        sender_profile: state.senderProfile,
                        history: state.proPreferenceHistory,
                        max_questions: 5
                    })
                });
                
                const data = await response.json();
                loading.classList.remove('hidden');
                
                if (data.success) {
                    loading.classList.add('hidden');
                    renderProPreferenceQuestion(data);
                } else {
                    throw new Error(data.error || 'Failed to load questions');
                }
            } catch (error) {
                loading.classList.add('hidden');
                alert('Error loading questions: ' + error.message);
            }
        }

        // Render a single preference question for Professional mode
        function renderProPreferenceQuestion(result) {
            const container = document.getElementById('pro-preference-questions');
            container.innerHTML = '';
            
            if (result.done) {
                const info = document.createElement('div');
                info.className = 'notice';
                info.style.background = '#d4edda';
                info.style.borderColor = '#28a745';
                info.style.color = '#155724';
                info.innerHTML = `<span class="icon">âœ…</span> Great! We have enough information to find your ideal targets. Click "Find My Targets" below.`;
                container.appendChild(info);
                return;
            }

            const questionText = result.question || 'What type of professionals would you like to connect with?';
            const options = Array.isArray(result.options) ? result.options : null;
            const card = document.createElement('div');
            card.className = 'question-card';
            
            let innerHtml = `<h4>Q${state.proPreferenceHistory.length + 1}: ${questionText}</h4>`;

            if (options && options.length > 0) {
                innerHtml += `<div style="margin: 6px 0 8px; color: #a0a0b0; font-size: 12px;">Tip: You can select multiple options.</div>`;
                innerHtml += `
                    <div class="question-options" id="pro-question-options">
                        ${options.map((opt, idx) => `
                            <div class="question-option" data-index="${idx}">${opt}</div>
                        `).join('')}
                    </div>
                    <div class="question-custom-input" id="pro-question-custom-wrapper">
                        <textarea id="pro-question-custom-input" rows="2" placeholder="Your custom answer..."></textarea>
                    </div>
                `;
            } else {
                innerHtml += `
                    <div class="question-custom-input visible">
                        <textarea id="pro-question-answer-input" rows="3" placeholder="Type your answer here..."></textarea>
                    </div>
                `;
            }

            innerHtml += `
                <div class="btn-group" style="margin-top: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="btn-pro-skip-question">Skip</button>
                    <button class="btn btn-primary" id="btn-pro-next-question" disabled>Next Question</button>
                </div>`;

            card.innerHTML = innerHtml;
            container.appendChild(card);

            const nextBtn = document.getElementById('btn-pro-next-question');
            const skipBtn = document.getElementById('btn-pro-skip-question');
            const selectedIndexes = new Set();

            if (options && options.length > 0) {
                const optionEls = Array.from(document.querySelectorAll('#pro-question-options .question-option'));
                const customWrapper = document.getElementById('pro-question-custom-wrapper');
                const customInput = document.getElementById('pro-question-custom-input');
                const lastIndex = options.length - 1;

                function updateNextEnabled() {
                    if (selectedIndexes.size === 0) {
                        nextBtn.disabled = true;
                        return;
                    }
                    if (selectedIndexes.has(lastIndex)) {
                        nextBtn.disabled = !customInput.value.trim();
                    } else {
                        nextBtn.disabled = false;
                    }
                }

                optionEls.forEach(el => {
                    el.addEventListener('click', function() {
                        const idx = parseInt(this.dataset.index, 10);
                        if (Number.isNaN(idx)) return;

                        if (selectedIndexes.has(idx)) {
                            selectedIndexes.delete(idx);
                            this.classList.remove('selected');
                        } else {
                            selectedIndexes.add(idx);
                            this.classList.add('selected');
                        }

                        if (selectedIndexes.has(lastIndex)) {
                            customWrapper.classList.add('visible');
                        } else {
                            customWrapper.classList.remove('visible');
                        }
                        updateNextEnabled();
                    });
                });

                if (customInput) {
                    customInput.addEventListener('input', updateNextEnabled);
                }
            } else {
                const answerInput = document.getElementById('pro-question-answer-input');
                answerInput.addEventListener('input', function() {
                    nextBtn.disabled = !this.value.trim();
                });
            }

            async function submitAndLoadNext(answer) {
                state.proPreferenceHistory.push({
                    question: questionText,
                    answer: answer || ''
                });
                
                const loading = document.getElementById('pro-pref-loading');
                loading.classList.remove('hidden');
                
                try {
                    const response = await fetch('/api/next-target-question', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            purpose: state.proTrack === 'academic' ? 'Academic research and PhD opportunities' : 'Finance and investment opportunities',
                            field: state.proTrack === 'academic' ? 'Academic Research' : 'Finance',
                            sender_profile: state.senderProfile,
                            history: state.proPreferenceHistory,
                            max_questions: 5
                        })
                    });
                    
                    const data = await response.json();
                    loading.classList.add('hidden');
                    
                    if (data.success) {
                        renderProPreferenceQuestion(data);
                    } else {
                        throw new Error(data.error || 'Failed to load next question');
                    }
                } catch (error) {
                    loading.classList.add('hidden');
                    alert('Error: ' + error.message);
                }
            }

            nextBtn.addEventListener('click', function() {
                let answer = '';
                if (options && options.length > 0) {
                    if (selectedIndexes.size === 0) return;
                    const lastIndex = options.length - 1;
                    const parts = [];

                    for (let i = 0; i < options.length; i++) {
                        if (i === lastIndex) continue;
                        if (selectedIndexes.has(i)) parts.push(options[i]);
                    }

                    if (selectedIndexes.has(lastIndex)) {
                        const customInput = document.getElementById('pro-question-custom-input');
                        if (!customInput.value.trim()) return;
                        const customText = customInput.value.trim();
                        if (parts.length === 0) {
                            answer = customText;
                        } else {
                            parts.push(`Other: ${customText}`);
                        }
                    }
                    if (!answer) answer = parts.join('; ');
                    if (!answer) return;
                } else {
                    const answerInput = document.getElementById('pro-question-answer-input');
                    answer = (answerInput.value || '').trim();
                    if (!answer) return;
                }
                submitAndLoadNext(answer);
            });

            skipBtn.addEventListener('click', function() {
                submitAndLoadNext('');
            });
        }

        // Render fixed Finance questions (decision tree) with single/multi-select + optional "Other" input
        function renderFinanceFixedQuestion() {
            const container = document.getElementById('pro-preference-questions');
            container.innerHTML = '';

            function goBackOneFinanceQuestion() {
                if (financeQuestionHistory.length === 0) return;
                const last = financeQuestionHistory.pop();
                if (!last || !last.questionId) return;

                const prevValuesRaw = financeAnswers[last.questionId];
                const prevValues = Array.isArray(prevValuesRaw)
                    ? prevValuesRaw.map(v => String(v))
                    : [];
                const prevCustomText = String(financeCustomAnswers[last.questionId] || '').trim();

                financeDraftAnswers[last.questionId] = {
                    values: prevValues,
                    customText: prevCustomText,
                };

                delete financeAnswers[last.questionId];
                delete financeCustomAnswers[last.questionId];

                financeQuestionIndex = last.questionIndex || 0;
                renderFinanceFixedQuestion();
            }

            function getQuestionById(id) {
                return FINANCE_FIXED_QUESTIONS.find(q => q.id === id) || null;
            }

            function getOptionLabelFromQuestion(question, value) {
                if (!question) return value;
                if (question.includeNotSure && value === (question.notSureValue || 'unsure')) {
                    return question.notSureLabel || 'Not sure';
                }
                const opts = Array.isArray(question.options) ? question.options : [];
                const found = opts.find(o => o.value === value);
                if (found && found.label) return found.label;
                return value;
            }

            function resolveQuestionOptions(question) {
                if (!question) return [];
                if (question.optionsFrom) {
                    const sourceId = question.optionsFrom;
                    const selected = Array.isArray(financeAnswers[sourceId]) ? financeAnswers[sourceId] : [];
                    const sourceQuestion = getQuestionById(sourceId);
                    const options = selected.map(v => ({
                        value: v,
                        label: getOptionLabelFromQuestion(sourceQuestion, v)
                    }));
                    if (selected.includes('other')) {
                        const customText = String(financeCustomAnswers[sourceId] || '').trim();
                        if (customText) {
                            options.forEach(o => {
                                if (o.value === 'other') o.label = `Other: ${customText}`;
                            });
                        }
                    }
                    if (question.includeNotSure) {
                        options.push({
                            value: question.notSureValue || 'unsure',
                            label: question.notSureLabel || 'Not sure'
                        });
                    }
                    return options;
                }
                return Array.isArray(question.options) ? question.options : [];
            }

            function getAnswerLabels(question) {
                const values = Array.isArray(financeAnswers[question.id]) ? financeAnswers[question.id] : [];
                const opts = resolveQuestionOptions(question);
                const optMap = new Map(opts.map(o => [o.value, o.label]));
                return values.map(v => {
                    if (question.custom && v === question.custom.optionValue) {
                        const customText = String(financeCustomAnswers[question.id] || '').trim();
                        return customText ? `Other: ${customText}` : 'Other';
                    }
                    return optMap.get(v) || getOptionLabelFromQuestion(question, v);
                });
            }

            function renderFinanceSummary({ capped = false } = {}) {
                buildFinancePreferenceSummary();

                const info = document.createElement('div');
                info.className = 'notice';
                info.style.cssText = 'background: rgba(34, 211, 238, 0.15); border-color: rgba(34, 211, 238, 0.5); color: #22d3ee;';
                info.innerHTML = capped
                    ? `<span class="icon">âœ…</span> Reached the question limit (${FINANCE_MAX_QUESTIONS}). Click <strong>"Find My Targets"</strong> to discover matches based on what you answered.`
                    : `<span class="icon">âœ…</span> Great! We have your preferences. Click <strong>"Find My Targets"</strong> to discover professionals matching your criteria.`;
                container.appendChild(info);

                const summary = document.createElement('div');
                summary.className = 'finance-summary';
                summary.style.cssText = 'margin-top: 20px; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.2);';

                let summaryHtml = '<h4 style="color: #c4b5fd; margin-bottom: 12px;">ðŸ“‹ Your Preferences Summary</h4><ul style="list-style: none; padding: 0; margin: 0;">';

                FINANCE_FIXED_QUESTIONS.forEach(q => {
                    const values = Array.isArray(financeAnswers[q.id]) ? financeAnswers[q.id] : [];
                    if (!values.length) return;
                    const labels = getAnswerLabels(q).map(label => String(label || '').split(' â€” ')[0].split(' (')[0]);
                    if (!labels.length) return;
                    summaryHtml += `<li style="padding: 8px 0; border-bottom: 1px solid rgba(139, 92, 246, 0.2); color: #e0e0e8;">
                        <strong style="color: #c4b5fd;">${q.question.split('?')[0]}:</strong><br>
                        <span style="color: #a0a0b0; font-size: 13px;">${labels.join(', ')}</span>
                    </li>`;
                });

                summaryHtml += '</ul>';
                summary.innerHTML = summaryHtml;
                container.appendChild(summary);

                if (financeQuestionHistory.length > 0) {
                    const actions = document.createElement('div');
                    actions.className = 'btn-group';
                    actions.style.cssText = 'margin-top: 16px; justify-content: flex-end;';
                    actions.innerHTML = `
                        <button class="btn btn-secondary" id="btn-finance-summary-back">â† Back</button>
                    `;
                    container.appendChild(actions);
                    const backBtn = document.getElementById('btn-finance-summary-back');
                    if (backBtn) backBtn.addEventListener('click', goBackOneFinanceQuestion);
                }
            }

            // Hard cap to avoid an overly long tree if user selects many paths
            const answeredCount = Object.keys(financeAnswers).length;
            if (answeredCount >= FINANCE_MAX_QUESTIONS) {
                renderFinanceSummary({ capped: true });
                return;
            }

            // Find the next applicable question (skip questions that don't apply)
            let currentQuestion = null;
            while (financeQuestionIndex < FINANCE_FIXED_QUESTIONS.length) {
                const q = FINANCE_FIXED_QUESTIONS[financeQuestionIndex];

                // Auto-skip primary direction if only one direction selected
                if (q.skipIfSingleSelectionFrom) {
                    const sourceValues = Array.isArray(financeAnswers[q.skipIfSingleSelectionFrom])
                        ? financeAnswers[q.skipIfSingleSelectionFrom]
                        : [];
                    if (sourceValues.length === 1) {
                        financeAnswers[q.id] = [sourceValues[0]];
                        financeQuestionIndex++;
                        continue;
                    }
                }

                // Dependency gating
                if (q.dependsOn && q.showIf) {
                    const dependsAnswer = Array.isArray(financeAnswers[q.dependsOn]) ? financeAnswers[q.dependsOn] : [];
                    if (!dependsAnswer.length || !q.showIf.some(v => dependsAnswer.includes(v))) {
                        financeQuestionIndex++;
                        continue;
                    }
                }

                // Dynamic options (e.g., primary direction) may be empty
                const resolvedOptions = resolveQuestionOptions(q);
                if (!resolvedOptions.length) {
                    financeQuestionIndex++;
                    continue;
                }

                currentQuestion = { ...q, resolvedOptions };
                break;
            }

            if (!currentQuestion) {
                renderFinanceSummary({ capped: false });
                return;
            }

            // Create question card
            const card = document.createElement('div');
            card.className = 'question-card';

            const questionNum = Object.keys(financeAnswers).length + 1;
            const currentQuestionIndex = financeQuestionIndex;
            const type = currentQuestion.type === 'single' ? 'single' : 'multi';
            const helperText = type === 'single'
                ? 'Select one option:'
                : 'Select one or more options that apply to you:';

            let innerHtml = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #f0f0f5;">Q${questionNum}: ${currentQuestion.question}</h4>
                    <span style="color: #a0a0b0; font-size: 12px;">${questionNum}/${FINANCE_MAX_QUESTIONS}</span>
                </div>
                <p style="font-size: 13px; color: #a0a0b0; margin-bottom: 15px;">${helperText}</p>
                <div class="finance-options" id="finance-question-options">
            `;

            currentQuestion.resolvedOptions.forEach((opt, idx) => {
                innerHtml += `
                    <div class="finance-option" data-value="${opt.value}" data-index="${idx}">
                        <div class="finance-option-checkbox">
                            <svg class="checkmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="finance-option-label">${opt.label}</div>
                    </div>
                `;
            });

            innerHtml += `
                </div>
            `;

            if (currentQuestion.custom) {
                const placeholder = String(currentQuestion.custom.placeholder || 'Please specify...').replace(/"/g, '&quot;');
                innerHtml += `
                    <div class="question-custom-input" id="finance-question-custom-wrapper">
                        <textarea id="finance-question-custom-input" rows="2" placeholder="${placeholder}"></textarea>
                    </div>
                `;
            }

            innerHtml += `
                <div class="btn-group" style="margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="btn-finance-back" ${financeQuestionHistory.length === 0 ? 'disabled' : ''}>â† Back</button>
                    <button class="btn btn-secondary" id="btn-finance-skip">Skip</button>
                    <button class="btn btn-primary" id="btn-finance-next" disabled>Next Question â†’</button>
                </div>
            `;

            card.innerHTML = innerHtml;
            container.appendChild(card);

            // Add styles for finance options if not already added
            if (!document.getElementById('finance-option-styles')) {
                const style = document.createElement('style');
                style.id = 'finance-option-styles';
                style.textContent = `
                    .finance-options {
                        display: flex;
                        flex-direction: column;
                        gap: 10px;
                    }
                    .finance-option {
                        display: flex;
                        align-items: flex-start;
                        gap: 12px;
                        padding: 14px 16px;
                        background: rgba(255, 255, 255, 0.03);
                        border: 1px solid rgba(139, 92, 246, 0.2);
                        border-radius: 10px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }
                    .finance-option:hover {
                        background: rgba(139, 92, 246, 0.1);
                        border-color: rgba(139, 92, 246, 0.4);
                    }
                    .finance-option.selected {
                        background: rgba(139, 92, 246, 0.15);
                        border-color: #8b5cf6;
                    }
                    .finance-option-checkbox {
                        width: 22px;
                        height: 22px;
                        min-width: 22px;
                        border: 2px solid rgba(139, 92, 246, 0.4);
                        border-radius: 5px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transition: all 0.2s ease;
                    }
                    .finance-option.selected .finance-option-checkbox {
                        background: #8b5cf6;
                        border-color: #8b5cf6;
                    }
                    .finance-option-checkbox .checkmark {
                        width: 14px;
                        height: 14px;
                        color: #fff;
                        opacity: 0;
                        transform: scale(0.5);
                        transition: all 0.15s ease;
                    }
                    .finance-option.selected .finance-option-checkbox .checkmark {
                        opacity: 1;
                        transform: scale(1);
                    }
                    .finance-option-label {
                        color: #e0e0e8;
                        font-size: 14px;
                        line-height: 1.5;
                    }
                    .finance-option.selected .finance-option-label {
                        color: #f0f0f5;
                    }
                `;
                document.head.appendChild(style);
            }

            const selectedValues = new Set();
            const optionEls = Array.from(container.querySelectorAll('#finance-question-options .finance-option'));
            const nextBtn = document.getElementById('btn-finance-next');
            const skipBtn = document.getElementById('btn-finance-skip');
            const backBtn = document.getElementById('btn-finance-back');

            const customOptionValue = currentQuestion.custom ? currentQuestion.custom.optionValue : null;
            const customWrapper = document.getElementById('finance-question-custom-wrapper');
            const customInput = document.getElementById('finance-question-custom-input');

            function updateCustomVisibility() {
                if (!customWrapper || !customOptionValue) return;
                if (selectedValues.has(customOptionValue)) {
                    customWrapper.classList.add('visible');
                } else {
                    customWrapper.classList.remove('visible');
                }
            }

            function updateNextEnabled() {
                if (selectedValues.size === 0) {
                    nextBtn.disabled = true;
                    return;
                }
                if (customOptionValue && selectedValues.has(customOptionValue)) {
                    nextBtn.disabled = !customInput || !customInput.value.trim();
                    return;
                }
                nextBtn.disabled = false;
            }

            optionEls.forEach(el => {
                el.addEventListener('click', function() {
                    const value = this.dataset.value;
                    if (type === 'single') {
                        if (selectedValues.has(value)) {
                            selectedValues.delete(value);
                            this.classList.remove('selected');
                        } else {
                            selectedValues.clear();
                            optionEls.forEach(o => o.classList.remove('selected'));
                            selectedValues.add(value);
                            this.classList.add('selected');
                        }
                    } else {
                        if (selectedValues.has(value)) {
                            selectedValues.delete(value);
                            this.classList.remove('selected');
                        } else {
                            selectedValues.add(value);
                            this.classList.add('selected');
                        }
                    }
                    updateCustomVisibility();
                    updateNextEnabled();
                });
            });

            if (customInput) {
                customInput.addEventListener('input', updateNextEnabled);
            }

            // Prefill draft answers when navigating back
            const draft = financeDraftAnswers[currentQuestion.id];
            const draftValues = draft && Array.isArray(draft.values) ? draft.values.map(v => String(v)) : [];
            const draftCustomText = draft ? String(draft.customText || '') : '';
            if (draftValues.length) {
                const valueSet = new Set(draftValues);
                optionEls.forEach(el => {
                    const value = String(el.dataset.value || '');
                    if (!value) return;
                    if (type === 'single') {
                        if (draftValues[0] === value) {
                            selectedValues.add(value);
                            el.classList.add('selected');
                        }
                        return;
                    }
                    if (valueSet.has(value)) {
                        selectedValues.add(value);
                        el.classList.add('selected');
                    }
                });
                if (customOptionValue && selectedValues.has(customOptionValue) && customInput) {
                    customInput.value = draftCustomText;
                }
                updateCustomVisibility();
                updateNextEnabled();
            }

            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    goBackOneFinanceQuestion();
                });
            }

            nextBtn.addEventListener('click', function() {
                if (selectedValues.size === 0) return;
                financeAnswers[currentQuestion.id] = Array.from(selectedValues);
                if (customOptionValue && selectedValues.has(customOptionValue) && customInput && customInput.value.trim()) {
                    financeCustomAnswers[currentQuestion.id] = customInput.value.trim();
                } else {
                    delete financeCustomAnswers[currentQuestion.id];
                }
                delete financeDraftAnswers[currentQuestion.id];
                financeQuestionHistory.push({ questionIndex: currentQuestionIndex, questionId: currentQuestion.id });
                financeQuestionIndex++;
                renderFinanceFixedQuestion();
            });

            skipBtn.addEventListener('click', function() {
                financeAnswers[currentQuestion.id] = [];
                delete financeCustomAnswers[currentQuestion.id];
                delete financeDraftAnswers[currentQuestion.id];
                financeQuestionHistory.push({ questionIndex: currentQuestionIndex, questionId: currentQuestion.id });
                financeQuestionIndex++;
                renderFinanceFixedQuestion();
            });
        }

        // Build preference summary for API call
        function buildFinancePreferenceSummary() {
            const parts = [];

            const list = (id) => Array.isArray(financeAnswers[id]) ? financeAnswers[id] : [];
            const first = (id) => {
                const values = list(id);
                return values.length ? values[0] : '';
            };
            const custom = (id) => String(financeCustomAnswers[id] || '').trim();

            const prefs = { track: 'finance' };

            const directionLabels = {
                ib: 'Investment Banking (IB)',
                st: 'Sales & Trading (S&T)',
                pe: 'Private Equity / Growth Equity',
                hf: 'Hedge Fund',
                am: 'Asset / Wealth Management',
                er: 'Equity Research',
                corp_fin: 'Corporate Finance / Strategy',
                unsure: 'Not sure yet â€” keep it broad',
                other: 'Other'
            };
            const directionKeywords = {
                ib: 'Investment Banking',
                st: 'Sales & Trading',
                pe: 'Private Equity / Growth Equity',
                hf: 'Hedge Fund',
                am: 'Asset / Wealth Management',
                er: 'Equity Research',
                corp_fin: 'Corporate Finance / Strategy',
                unsure: 'Finance'
            };

            function joinMapped(values, mapping, otherText) {
                const labels = [];
                values.forEach(v => {
                    if (v === 'other') return;
                    labels.push(mapping[v] || v);
                });
                if (values.includes('other')) {
                    labels.push(otherText || 'Other');
                }
                return labels.filter(Boolean);
            }

            const directions = list('career_directions');
            const primary = first('career_directions');
            if (primary) {
                const primaryText = primary === 'other'
                    ? (custom('career_directions') ? `Other: ${custom('career_directions')}` : 'Other')
                    : (directionLabels[primary] || primary);
                parts.push('Primary direction: ' + primaryText);
            }

            // Branch-specific mapping (S / O)
            const ibFirmLabels = {
                bb: 'Bulge Bracket',
                eb: 'Elite Boutique',
                mm: 'Middle Market',
                industry_boutique: 'Industry Boutique',
                regional: 'Regional Investment Bank',
                other: 'Other'
            };
            const ibFirmToTier = { bb: 'BB', eb: 'EB', mm: 'MM', industry_boutique: 'Boutique', regional: 'Regional', other: 'Unknown' };
            const ibIndustryLabels = {
                tmt: 'TMT',
                healthcare: 'Healthcare',
                industrials: 'Industrials',
                consumer: 'Consumer & Retail',
                fig: 'FIG',
                energy: 'Energy/Power/Infrastructure',
                real_estate: 'Real Estate',
                media: 'Media & Entertainment',
                telecom: 'Telecom',
                gaming_sports: 'Gaming/Sports',
                chemicals: 'Chemicals',
                transportation: 'Transportation/Aviation'
            };
            const ibProductLabels = {
                ma: 'M&A',
                ecm: 'ECM',
                dcm: 'DCM',
                lev_fin: 'Leveraged Finance',
                restructuring: 'Distressed/Restructuring',
                cross_border: 'Cross-border'
            };

            if (primary === 'ib') {
                const firmVal = first('ib_firm_type');
                const firmText = firmVal
                    ? (firmVal === 'other' ? (custom('ib_firm_type') || 'Other') : (ibFirmLabels[firmVal] || firmVal))
                    : '';
                prefs.org_type = firmText ? `${firmText} Investment Bank` : 'Investment Bank';
                if (firmVal) prefs.bank_tier = ibFirmToTier[firmVal] || 'Unknown';
                if (firmText) parts.push('IB firm type: ' + firmText);

                const gt = first('ib_group_type');
                if (gt) {
                    const gtLabels = { coverage: 'Coverage', product: 'Product', both: 'Both', unsure: 'Not sure' };
                    parts.push('IB group type: ' + (gtLabels[gt] || gt));
                }
                if (gt === 'coverage') prefs.group_type = 'coverage';
                else if (gt === 'product') prefs.group_type = 'product';
                else prefs.group_type = 'unknown';

                const industries = list('ib_coverage_industries');
                const industriesText = joinMapped(industries, ibIndustryLabels, custom('ib_coverage_industries'));
                if (industriesText.length) {
                    prefs.sector = industriesText.join('; ');
                    parts.push('IB coverage industries: ' + prefs.sector);
                }

                const products = list('ib_product_groups');
                const productsText = joinMapped(products, ibProductLabels, custom('ib_product_groups'));
                if (productsText.length) {
                    prefs.group = productsText.join('; ');
                    parts.push('IB product groups: ' + prefs.group);
                }
            } else if (primary === 'st') {
                prefs.org_type = 'Sales & Trading';
                const stFunc = first('st_function');
                const stFuncLabels = { sales: 'Sales', trading: 'Trading', structuring: 'Structuring', unsure: 'Not sure' };
                if (stFunc) {
                    prefs.group = stFuncLabels[stFunc] || stFunc;
                    parts.push('S&T focus: ' + prefs.group);
                }

                const stSalesLabels = {
                    equities_sales: 'Equities Sales',
                    fixed_income_sales: 'Fixed Income Sales',
                    prime_brokerage_sales: 'Prime Brokerage Sales'
                };
                const stTradingLabels = {
                    equities_trading: 'Equities Trading',
                    fixed_income_trading: 'Fixed Income Trading',
                    rates_trading: 'Rates Trading',
                    credit_trading: 'Credit Trading',
                    fx_trading: 'FX Trading',
                    commodities_trading: 'Commodities Trading'
                };
                const stStructuringLabels = {
                    equity_derivatives_structuring: 'Equity Derivatives Structuring',
                    credit_structuring: 'Credit Structuring',
                    rates_structuring: 'Rates Structuring'
                };

                if (stFunc === 'sales') {
                    const areas = list('st_sales_area');
                    const areasText = joinMapped(areas, stSalesLabels, custom('st_sales_area'));
                    if (areasText.length) {
                        prefs.sector = areasText.join('; ');
                        parts.push('S&T sales area: ' + prefs.sector);
                    }
                } else if (stFunc === 'trading') {
                    const areas = list('st_trading_area');
                    const areasText = joinMapped(areas, stTradingLabels, custom('st_trading_area'));
                    if (areasText.length) {
                        prefs.sector = areasText.join('; ');
                        parts.push('S&T trading area: ' + prefs.sector);
                    }
                } else if (stFunc === 'structuring') {
                    const areas = list('st_structuring_area');
                    const areasText = joinMapped(areas, stStructuringLabels, custom('st_structuring_area'));
                    if (areasText.length) {
                        prefs.sector = areasText.join('; ');
                        parts.push('S&T structuring area: ' + prefs.sector);
                    }
                }
            } else if (primary === 'pe') {
                prefs.org_type = 'Private Equity / Growth Equity';
                const fundVal = first('pe_fund_type');
                const fundLabels = {
                    large_cap_pe: 'Large-cap PE',
                    mid_market_pe: 'Mid-market PE',
                    growth_equity: 'Growth Equity',
                    venture_capital: 'Venture Capital',
                    sector_focused_pe: 'Sector-focused PE'
                };
                const fundText = fundVal
                    ? (fundVal === 'other' ? (custom('pe_fund_type') || 'Other') : (fundLabels[fundVal] || fundVal))
                    : '';
                if (fundText) {
                    prefs.group = fundText;
                    parts.push('Fund type: ' + fundText);
                }

                const peIndustryLabels = {
                    technology: 'Technology',
                    healthcare: 'Healthcare',
                    consumer: 'Consumer',
                    industrials: 'Industrials',
                    financials: 'Financial Services',
                    energy: 'Energy',
                    real_estate: 'Real Estate'
                };
                const industries = list('pe_industry_focus');
                const industriesText = joinMapped(industries, peIndustryLabels, custom('pe_industry_focus'));
                if (industriesText.length) {
                    prefs.sector = industriesText.join('; ');
                    parts.push('Industry focus: ' + prefs.sector);
                }
            } else if (primary === 'hf') {
                prefs.org_type = 'Hedge Fund';
                const hfStrategyLabels = {
                    l_s_equity: 'Long/Short Equity',
                    global_macro: 'Global Macro',
                    event_driven: 'Event-driven',
                    quant: 'Quant/Systematic',
                    multi_strat: 'Multi-strategy',
                    credit_distressed: 'Credit/Distressed'
                };
                const strategies = list('hf_strategy');
                const strategiesText = joinMapped(strategies, hfStrategyLabels, custom('hf_strategy'));
                if (strategiesText.length) {
                    prefs.group = strategiesText.join('; ');
                    parts.push('HF strategy: ' + prefs.group);
                }

                const hfRoleLabels = {
                    analyst: 'Analyst',
                    trader: 'Trader',
                    quant_research: 'Quant Research',
                    portfolio_analyst: 'Portfolio Analyst'
                };
                const roles = list('hf_role');
                const rolesText = joinMapped(roles, hfRoleLabels, custom('hf_role'));
                if (rolesText.length) parts.push('HF roles: ' + rolesText.join('; '));
            } else if (primary === 'am') {
                const amTrack = first('am_track');
                const amTrackLabels = {
                    asset_management: 'Asset Management',
                    wealth_management: 'Wealth Management / Private Banking',
                    unsure: 'Not sure'
                };
                prefs.org_type = amTrackLabels[amTrack] || 'Asset / Wealth Management';
                if (amTrack) parts.push('AM/WM track: ' + (amTrackLabels[amTrack] || amTrack));

                if (amTrack === 'asset_management') {
                    const amAssetLabels = {
                        equities: 'Equities',
                        fixed_income: 'Fixed Income',
                        multi_asset: 'Multi-Asset',
                        alternatives: 'Alternatives'
                    };
                    const assets = list('am_asset_class');
                    const assetsText = joinMapped(assets, amAssetLabels, custom('am_asset_class'));
                    if (assetsText.length) {
                        prefs.sector = assetsText.join('; ');
                        parts.push('Asset class: ' + prefs.sector);
                    }
                }
            } else if (primary === 'er') {
                prefs.org_type = 'Equity Research';
                const erIndustryLabels = {
                    technology: 'Technology',
                    healthcare: 'Healthcare',
                    consumer: 'Consumer',
                    industrials: 'Industrials',
                    energy: 'Energy',
                    financials: 'Financials'
                };
                const erSectors = list('er_industry');
                const erSectorsText = joinMapped(erSectors, erIndustryLabels, custom('er_industry'));
                if (erSectorsText.length) {
                    prefs.sector = erSectorsText.join('; ');
                    parts.push('ER coverage: ' + prefs.sector);
                }
                const erRoleVal = first('er_role');
                const erRoleLabels = { research_analyst: 'Research Analyst', associate: 'Associate' };
                const erRoleText = erRoleVal
                    ? (erRoleVal === 'other' ? (custom('er_role') || 'Other') : (erRoleLabels[erRoleVal] || erRoleVal))
                    : '';
                if (erRoleText) {
                    prefs.group = erRoleText;
                    parts.push('ER role: ' + erRoleText);
                }
            } else if (primary === 'corp_fin') {
                prefs.org_type = 'Corporate Finance / Strategy';
                const corpRoleLabels = {
                    corp_dev: 'Corporate Development',
                    fpa: 'FP&A',
                    strategy_bizops: 'Strategy / BizOps',
                    treasury: 'Treasury'
                };
                const roles = list('corp_role');
                const rolesText = joinMapped(roles, corpRoleLabels, custom('corp_role'));
                if (rolesText.length) {
                    prefs.group = rolesText.join('; ');
                    parts.push('CorpFin/Strategy focus: ' + prefs.group);
                }
            } else if (primary === 'other') {
                const otherText = custom('career_directions') || 'Other';
                prefs.org_type = `Finance (${otherText})`;
            } else {
                prefs.org_type = 'Finance';
            }

            // Market / Location (M)
            const locationLabels = {
                new_york: 'New York',
                london: 'London',
                hong_kong: 'Hong Kong',
                singapore: 'Singapore',
                san_francisco: 'San Francisco / Bay Area'
            };
            const locations = list('market_location');
            const locationsText = joinMapped(locations, locationLabels, custom('market_location'));
            if (locationsText.length) {
                prefs.location = locationsText.join('; ');
                parts.push('Location: ' + prefs.location);
            }

            // Seniority (who to talk to)
            const seniorityLabels = {
                analyst: 'Analyst',
                associate: 'Associate',
                vp_director: 'VP/Director',
                ed_svp: 'ED/SVP',
                md: 'MD'
            };
            const seniorities = list('target_seniority');
            const senioritiesText = joinMapped(seniorities, seniorityLabels, custom('target_seniority'));
            if (senioritiesText.length) {
                prefs.seniority = senioritiesText.join('; ');
                parts.push('Target seniority: ' + prefs.seniority);
            }

            // Optional preferences
            const outreachVal = first('outreach_goal');
            const outreachLabels = {
                learn_role: 'Learn about day-to-day role and responsibilities',
                career_advice: 'Career advice and guidance on breaking in',
                referral: 'Referral opportunities for open positions',
                industry_insight: 'Industry insights and market knowledge',
                mentorship: 'Mentorship / long-term guidance'
            };
	            if (outreachVal) {
	                const outreachText = outreachVal === 'other' ? (custom('outreach_goal') || 'Other') : (outreachLabels[outreachVal] || outreachVal);
	                prefs.outreach_goal = outreachText;
	                parts.push('Outreach goal: ' + outreachText);
	            }

	            // Target role titles (for SerpAPI query building)
	            const titles = new Set();
            const seniorityVals = list('target_seniority');
            function addTitle(title) {
                const t = String(title || '').trim();
                if (t) titles.add(t);
            }
            function includeGenericSeniorityTitles() {
                seniorityVals.forEach(v => {
                    if (v === 'analyst') addTitle('Analyst');
                    else if (v === 'associate') addTitle('Associate');
                    else if (v === 'vp_director') { addTitle('Vice President'); addTitle('VP'); addTitle('Director'); }
                    else if (v === 'ed_svp') { addTitle('Executive Director'); addTitle('SVP'); }
                    else if (v === 'md') { addTitle('Managing Director'); addTitle('MD'); }
                });
            }
            includeGenericSeniorityTitles();

            if (primary === 'ib') {
                addTitle('Investment Banking');
                if (seniorityVals.includes('analyst')) { addTitle('Investment Banking Analyst'); addTitle('IB Analyst'); }
                if (seniorityVals.includes('associate')) { addTitle('Investment Banking Associate'); addTitle('IB Associate'); }
                if (seniorityVals.includes('vp_director')) { addTitle('Investment Banking Vice President'); addTitle('Investment Banking VP'); }
            } else if (primary === 'er') {
                addTitle('Equity Research');
                addTitle('Equity Research Analyst');
                addTitle('Equity Research Associate');
            } else if (primary === 'pe') {
                addTitle('Private Equity');
                if (seniorityVals.includes('analyst')) addTitle('Private Equity Analyst');
                if (seniorityVals.includes('associate')) addTitle('Private Equity Associate');
                addTitle('Growth Equity Associate');
            } else if (primary === 'hf') {
                addTitle('Hedge Fund');
                const hfRoles = list('hf_role');
                hfRoles.forEach(v => {
                    if (v === 'trader') addTitle('Trader');
                    else if (v === 'analyst') addTitle('Investment Analyst');
                    else if (v === 'quant_research') addTitle('Quant Research');
                    else if (v === 'portfolio_analyst') addTitle('Portfolio Analyst');
                });
            } else if (primary === 'st') {
                addTitle('Sales and Trading');
                const stFunc = first('st_function');
                if (stFunc === 'sales') addTitle('Sales');
                if (stFunc === 'trading') addTitle('Trader');
                if (stFunc === 'structuring') { addTitle('Structuring'); addTitle('Structurer'); }
            } else if (primary === 'am') {
                addTitle('Asset Management');
                const amTrack = first('am_track');
                if (amTrack === 'wealth_management') { addTitle('Wealth Manager'); addTitle('Private Banker'); }
                else { addTitle('Portfolio Manager'); addTitle('Investment Analyst'); }
            } else if (primary === 'corp_fin') {
                addTitle('Corporate Development');
                addTitle('FP&A');
                addTitle('Strategy');
            }

            prefs.target_role_titles = Array.from(titles).slice(0, 8);

            const dirKeywords = directions.map(v => {
                if (v === 'other') return custom('career_directions') || 'Other';
                return directionKeywords[v] || v;
            }).filter(Boolean);

            const primaryKeyword = primary === 'other'
                ? (custom('career_directions') || 'Other')
                : (directionKeywords[primary] || primary);

            const intentLines = [];
            if (primaryKeyword) intentLines.push(`Primary direction: ${primaryKeyword}`);
            const detailParts = [];
            if (prefs.org_type) detailParts.push(`Org: ${prefs.org_type}`);
            if (prefs.bank_tier) detailParts.push(`Bank tier: ${prefs.bank_tier}`);
            if (prefs.group_type && prefs.group_type !== 'unknown') detailParts.push(`Group type: ${prefs.group_type}`);
            if (prefs.group) detailParts.push(`Group: ${prefs.group}`);
            if (prefs.sector) detailParts.push(`Sector: ${prefs.sector}`);
            if (prefs.location) detailParts.push(`Location: ${prefs.location}`);
            if (prefs.seniority) detailParts.push(`Seniority: ${prefs.seniority}`);
            if (prefs.outreach_goal) detailParts.push(`Outreach goal: ${prefs.outreach_goal}`);
            if (detailParts.length) intentLines.push(detailParts.join(' | '));
            prefs.search_intent = intentLines.join('\n');

            // Store in proPreferenceHistory for API consumption
            state.proPreferenceHistory = [{
                question: 'Finance Targeting Preferences (Decision Tree)',
                answer: parts.join('\n')
            }];

            // Store structured prefs for /api/find-recommendations
            state.financePreferences = prefs;
        }

        // Find targets for Professional mode
        async function findProTargets() {
            const container = document.getElementById('pro-preference-questions');
            const loading = document.getElementById('pro-pref-loading');
            
            loading.classList.remove('hidden');
            // Create dynamic loading container
            container.innerHTML = `
                <div class="loading visible" style="padding: 30px;">
                    <div class="spinner"></div>
                    <div class="loading-text" id="pro-loading-text"><span class="loading-dots">${searchLoadingMessages[0]}</span></div>
                </div>
            `;
            
            // Start dynamic loading animation for Pro mode
            let proLoadingInterval = null;
            let proMessageIndex = 0;
            const proLoadingText = document.getElementById('pro-loading-text');
            if (proLoadingText) {
                proLoadingInterval = setInterval(() => {
                    proLoadingText.classList.add('fade');
                    setTimeout(() => {
                        proMessageIndex = (proMessageIndex + 1) % searchLoadingMessages.length;
                        proLoadingText.innerHTML = `<span class="loading-dots">${searchLoadingMessages[proMessageIndex]}</span>`;
                        proLoadingText.classList.remove('fade');
                    }, 300);
                }, 3000);
            }
            
            try {
                const prefExtra = state.proPreferenceHistory.length > 0
                    ? state.proPreferenceHistory.map((qa, idx) => `Q${idx + 1}: ${qa.question}\nA${idx + 1}: ${qa.answer}`).join('\n\n')
                    : '';
                
                const response = await fetch('/api/find-recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        purpose: state.proTrack === 'academic' ? 'Academic research and PhD opportunities' : 'Finance career opportunities',
                        field: state.proTrack === 'academic' ? 'Academic Research' : 'Finance',
                        sender_profile: state.senderProfile,
                        preferences: {
                            ...(state.proTrack === 'finance' && state.financePreferences ? state.financePreferences : {}),
                            track: state.proTrack,
                            extra: prefExtra,
                            search_intent: [
                                String((state.proTrack === 'finance' && state.financePreferences ? state.financePreferences.search_intent : '') || '').trim(),
                                String((state.targetSearchIntent || '') || '').trim()
                            ].filter(Boolean).join('\n\n'),
                            must_have: (state.targetMustHave || '').trim(),
                            must_not: (state.targetMustNot || '').trim(),
                            location: [
                                String((state.proTrack === 'finance' && state.financePreferences ? state.financePreferences.location : '') || '').trim(),
                                String((state.targetLocation || '') || '').trim()
                            ].filter(Boolean).join('; '),
                            contactability: (() => {
                                const override = String((state.targetContactability || '') || '').trim();
                                const tree = String((state.proTrack === 'finance' && state.financePreferences ? state.financePreferences.contactability : '') || '').trim();
                                if (override && override !== 'balanced') return override;
                                return tree || override || 'balanced';
                            })(),
                            examples: (state.targetExamples || '').trim(),
                            evidence: (state.targetEvidence || '').trim(),
                        }
                    })
                });
                
                const data = await response.json();
                
                // Stop loading animation
                if (proLoadingInterval) clearInterval(proLoadingInterval);
                loading.classList.add('hidden');
                
                if (data.success && data.recommendations && data.recommendations.length > 0) {
                    // Store recommendations locally first (fix for state being cleared by click event)
                    const recommendations = data.recommendations;
                    
                    // Transition to main flow with recommendations
                    document.getElementById('pro-preferences').classList.add('hidden');
                    document.getElementById('progress-container').classList.remove('hidden');
                    
                    // Set up state for main flow
                    state.purpose = state.proTrack === 'academic' ? 'academic' : 'job';
                    state.field = state.proTrack === 'academic' ? 'ai-ml' : 'finance';
                    state.hasResume = true;
                    state.hasTarget = false;
                    
                    // Go directly to Step 3 with recommendations pre-loaded
                    goToStep(3);
                    
                    // Show recommendation section with results
                    // Note: click() triggers resetRecommendationState() which clears state.recommendations
                    // So we must set state.recommendations AFTER the click event
                    document.getElementById('target-choice').querySelector('[data-value="no"]').click();
                    document.getElementById('recommendation-section').classList.remove('hidden');
                    document.getElementById('target-preferences').classList.add('hidden');
                    
                    // IMPORTANT: Set state.recommendations AFTER click() to avoid being cleared
                    state.recommendations = recommendations;
                    renderRecommendations(recommendations);
                    document.getElementById('rec-actions').style.display = 'flex';
                } else {
                    throw new Error(data.error || 'No recommendations found');
                }
            } catch (error) {
                // Stop loading animation
                if (proLoadingInterval) clearInterval(proLoadingInterval);
                loading.classList.add('hidden');
                container.innerHTML = `<div class="notice" style="background: rgba(244, 67, 54, 0.15); border-color: rgba(244, 67, 54, 0.5); color: #f87171;">
                    <span class="icon">âŒ</span> ${error.message}. Please try again or go back to adjust your preferences.
                </div>`;
            }
        }

        // Setup option card selection
        function setupOptionCards() {
            // Purpose options
            document.querySelectorAll('#purpose-options .option-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('#purpose-options .option-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.purpose = this.dataset.value;
                    
                    const customInput = document.getElementById('purpose-custom');
                    if (state.purpose === 'other') {
                        customInput.classList.add('visible');
                    } else {
                        customInput.classList.remove('visible');
                    }
                    checkStep1Valid();
                });
            });

            // Field options
            document.querySelectorAll('#field-options .option-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('#field-options .option-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.field = this.dataset.value;
                    
                    const customInput = document.getElementById('field-custom');
                    if (state.field === 'other-field') {
                        customInput.classList.add('visible');
                    } else {
                        customInput.classList.remove('visible');
                    }
                    checkStep1Valid();
                });
            });

            // Custom input listeners
            document.getElementById('purpose-custom-input').addEventListener('input', function() {
                state.purposeCustom = this.value;
                checkStep1Valid();
            });

            document.getElementById('field-custom-input').addEventListener('input', function() {
                state.fieldCustom = this.value;
                checkStep1Valid();
            });
        }

        // Setup choice buttons (Yes/No)
        function setupChoiceButtons() {
            // Resume choice
            document.querySelectorAll('#resume-choice .choice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#resume-choice .choice-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    state.hasResume = this.dataset.value === 'yes';
                    
                    if (state.hasResume) {
                        document.getElementById('resume-upload-section').classList.remove('hidden');
                        document.getElementById('questionnaire-section').classList.remove('visible');
                    } else {
                        document.getElementById('resume-upload-section').classList.add('hidden');
                        document.getElementById('questionnaire-section').classList.add('visible');
                        loadQuestionnaire();
                    }
                });
            });

            // Target choice
            document.querySelectorAll('#target-choice .choice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#target-choice .choice-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    state.hasTarget = this.dataset.value === 'yes';
                    
                    if (state.hasTarget) {
                        document.getElementById('manual-target-section').classList.remove('hidden');
                        document.getElementById('target-preferences').classList.add('hidden');
                        document.getElementById('target-questionnaire').classList.remove('visible');
                        document.getElementById('recommendation-section').classList.add('hidden');
                        document.getElementById('match-details').classList.remove('visible');
                        resetRecommendationState();
                    } else {
                        document.getElementById('manual-target-section').classList.add('hidden');
                        document.getElementById('target-preferences').classList.remove('hidden');
                        document.getElementById('target-questionnaire').classList.add('visible');
                        document.getElementById('recommendation-section').classList.add('hidden');
                        document.getElementById('match-details').classList.remove('visible');
                        resetRecommendationState();
                        state.targetPreferenceHistory = [];
                        loadTargetQuestionnaire();
                        updateFindMatchesEnabled();
                    }
                    checkStep3Valid();
                });
            });

            // Manual target inputs
            document.getElementById('target-name').addEventListener('input', checkStep3Valid);
            document.getElementById('target-field').addEventListener('input', checkStep3Valid);
        }

        // Setup preference questions for recommendations
        function setupPreferenceForm() {
            // Static preference form removed; keep dynamic questionnaire only.
            const btn = document.getElementById('btn-find-matches');
            if (btn) {
                btn.addEventListener('click', function() {
                    loadRecommendations();
                });
            }
        }

        // Setup file upload
        function setupFileUpload() {
            const resumeInput = document.getElementById('resume-file');
            const dropzone = document.getElementById('qs-resume-dropzone');

            if (dropzone && resumeInput) {
                dropzone.addEventListener('click', () => resumeInput.click());

                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.style.borderColor = '#5856d6';
                    dropzone.style.background = 'rgba(0, 113, 227, 0.08)';
                });

                dropzone.addEventListener('dragleave', () => {
                    dropzone.style.borderColor = 'rgba(0,0,0,0.25)';
                    dropzone.style.background = 'rgba(255,255,255,0.6)';
                });

                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.style.borderColor = 'rgba(0,0,0,0.25)';
                    dropzone.style.background = 'rgba(255,255,255,0.6)';
                    if (e.dataTransfer.files.length > 0) {
                        resumeInput.files = e.dataTransfer.files;
                        uploadResume(e.dataTransfer.files[0]);
                    }
                });
            }

            if (!resumeInput) return;
            resumeInput.addEventListener('change', async function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    await uploadResume(file);
                }
            });
        }

        // Upload and analyze resume
        async function uploadResume(file) {
            const loading = document.getElementById('upload-loading');
            const success = document.getElementById('resume-success');
            
            loading.classList.add('visible');
            success.classList.add('hidden');
            
            const formData = new FormData();
            formData.append('pdf', file);
            formData.append('session_id', state.sessionId);
            
            try {
                const response = await fetch('/api/upload-sender-pdf', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    state.senderProfile = data.profile;
                    loading.classList.remove('visible');
                    success.classList.remove('hidden');
                    updateQuickStartQuestionnaireVisibility();
                    checkStep2Valid();
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                loading.classList.remove('visible');
                alert('Error uploading resume: ' + error.message);
            }
        }

        // Setup target document upload
        function setupTargetDocUpload() {
            document.getElementById('target-doc-file').addEventListener('change', async function() {
                if (this.files.length > 0) {
                    const file = this.files[0];
                    await uploadTargetDoc(file);
                }
            });
        }

        // Upload and analyze target document
        async function uploadTargetDoc(file) {
            const loading = document.getElementById('target-doc-loading');
            const success = document.getElementById('target-doc-success');
            
            loading.classList.remove('hidden');
            success.classList.add('hidden');
            
            const name = document.getElementById('target-name').value.trim();
            const field = document.getElementById('target-field').value.trim();
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);
            formData.append('field', field);
            
            try {
                const response = await fetch('/api/upload-receiver-doc', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    state.manualTargetProfile = data.profile;
                    loading.classList.add('hidden');
                    success.classList.remove('hidden');
                    
                    // Auto-fill name and field if empty
                    if (!name && data.profile.name) {
                        document.getElementById('target-name').value = data.profile.name;
                    }
                    if (!field && data.profile.field) {
                        document.getElementById('target-field').value = data.profile.field;
                    }
                    
                    checkStep3Valid();
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                loading.classList.add('hidden');
                alert('Error uploading document: ' + error.message);
            }
        }

        // Open profile modal for a recommendation
        function openProfileModal(index) {
            const rec = state.recommendations[index];
            if (!rec) return;
            
            state.currentModalTarget = { index, rec };
            
            document.getElementById('modal-target-name').textContent = rec.name;
            document.getElementById('modal-position').textContent = rec.position || rec.field || '-';
            
            // Show LinkedIn URL if available
            const linkedinSection = document.getElementById('modal-linkedin-section');
            const linkedinUrl = document.getElementById('modal-linkedin-url');
            const linkedinText = document.getElementById('modal-linkedin-text');
            if (rec.linkedin_url) {
                linkedinSection.style.display = 'block';
                linkedinUrl.href = rec.linkedin_url;
                linkedinText.textContent = rec.linkedin_url;
            } else {
                linkedinSection.style.display = 'none';
            }
            
            // Match Score with color coding
            document.getElementById('modal-match-score').innerHTML = `<span style="color: ${rec.match_score >= 80 ? '#28a745' : rec.match_score >= 60 ? '#ffc107' : '#dc3545'}; font-weight: bold;">${rec.match_score}%</span> compatibility`;
            
            // Response Likelihood with badge
            const likelihood = rec.response_likelihood || 'medium';
            const likelihoodColors = {
                'high': { bg: '#d4edda', text: '#155724', label: 'ðŸŸ¢ High - Likely to respond' },
                'medium': { bg: '#fff3cd', text: '#856404', label: 'ðŸŸ¡ Medium - May respond' },
                'low': { bg: '#f8d7da', text: '#721c24', label: 'ðŸ”´ Low - Less likely' }
            };
            const lc = likelihoodColors[likelihood] || likelihoodColors['medium'];
            document.getElementById('modal-response-likelihood').innerHTML = `<span style="background: ${lc.bg}; color: ${lc.text}; padding: 4px 12px; border-radius: 12px; font-weight: 500;">${lc.label}</span>`;
            
            // Match Reason
            document.getElementById('modal-match-reason').textContent = rec.match_reason || 'Analysis not available';
            
            // Common Interests
            document.getElementById('modal-common-interests').textContent = rec.common_interests || 'No common interests identified';
            
            // Outreach Angle
            document.getElementById('modal-outreach-angle').innerHTML = rec.outreach_angle 
                ? `<span style="background: #e8f4fd; color: #0366d6; padding: 8px 12px; border-radius: 8px; display: block;">${rec.outreach_angle}</span>`
                : '<span style="color: #999;">Will be suggested when generating email</span>';
            
            // Uncertainty
            document.getElementById('modal-uncertainty').textContent = rec.uncertainty || '-';
            
            // Show education, experience, skills, projects if available (fetched profile)
            const eduList = document.getElementById('modal-education');
            const expList = document.getElementById('modal-experience');
            const skillList = document.getElementById('modal-skills');
            const projList = document.getElementById('modal-projects');
            const evidenceList = document.getElementById('modal-evidence');
            const sourcesList = document.getElementById('modal-sources');
            
            if (rec.education && rec.education.length) {
                eduList.innerHTML = rec.education.map(e => `<li>${e}</li>`).join('');
            } else {
                eduList.innerHTML = '<li style="color: #999;">Will be fetched when generating email</li>';
            }
            
            if (rec.experiences && rec.experiences.length) {
                expList.innerHTML = rec.experiences.map(e => `<li>${e}</li>`).join('');
            } else {
                expList.innerHTML = '<li style="color: #999;">Will be fetched when generating email</li>';
            }
            
            if (rec.skills && rec.skills.length) {
                skillList.innerHTML = rec.skills.map(s => `<li>${s}</li>`).join('');
            } else {
                skillList.innerHTML = '<li style="color: #999;">Will be fetched when generating email</li>';
            }
            
            if (rec.projects && rec.projects.length) {
                projList.innerHTML = rec.projects.map(p => `<li>${p}</li>`).join('');
            } else {
                projList.innerHTML = '<li style="color: #999;">Will be fetched when generating email</li>';
            }

            evidenceList.innerHTML = '';
            if (Array.isArray(rec.evidence) && rec.evidence.length) {
                rec.evidence.forEach(e => {
                    const li = document.createElement('li');
                    li.textContent = String(e || '');
                    evidenceList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.style.color = '#999';
                li.textContent = 'No evidence provided';
                evidenceList.appendChild(li);
            }

            sourcesList.innerHTML = '';
            if (Array.isArray(rec.sources) && rec.sources.length) {
                const urls = rec.sources.map(u => String(u || '').trim()).filter(Boolean);
                if (urls.length) {
                    urls.forEach(url => {
                        const li = document.createElement('li');
                        if (/^https?:\/\//i.test(url)) {
                            const a = document.createElement('a');
                            a.href = url;
                            a.target = '_blank';
                            a.rel = 'noopener noreferrer';
                            a.textContent = url;
                            li.appendChild(a);
                        } else {
                            li.textContent = url;
                        }
                        sourcesList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.style.color = '#999';
                    li.textContent = 'No sources';
                    sourcesList.appendChild(li);
                }
            } else {
                const li = document.createElement('li');
                li.style.color = '#999';
                li.textContent = 'No sources';
                sourcesList.appendChild(li);
            }
            
            document.getElementById('profile-modal').classList.add('visible');
        }

        // Close profile modal
        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('visible');
            state.currentModalTarget = null;
        }

        // Select target from modal
        function selectFromModal() {
            if (state.currentModalTarget) {
                toggleRecommendation(state.currentModalTarget.index);
                closeProfileModal();
            }
        }

        // Close modal when clicking outside
        document.getElementById('profile-modal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeProfileModal();
            }
        });

        // Load questionnaire
        async function loadQuestionnaire() {
            const container = document.getElementById('questions-container');
            const loading = document.getElementById('questionnaire-loading');
            
            container.innerHTML = '';
            loading.classList.add('visible');
            
            try {
                const purposeText = getPurposeText();
                const fieldText = getFieldText();

                // Quick Start: generate a full set of questions once
                if (state.mode === 'quick') {
                    if (!Array.isArray(state.questionnaireQuestions) || state.questionnaireQuestions.length === 0) {
                        const response = await fetch('/api/generate-questionnaire', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                purpose: purposeText,
                                field: fieldText
                            })
                        });
                        const data = await response.json();
                        if (data.success) {
                            state.questionnaireQuestions = Array.isArray(data.questions) ? data.questions : [];
                            state.questionnaireIndex = state.questionnaireHistory.length;
                            state.questionnaireAnswers = new Array(state.questionnaireQuestions.length).fill('');
                            loading.classList.remove('visible');
                            renderBatchQuestionList();
                            return;
                        }
                        throw new Error(data.error || 'Failed to generate questions');
                    }

                    state.questionnaireIndex = state.questionnaireHistory.length;
                    loading.classList.remove('visible');
                    if (!Array.isArray(state.questionnaireAnswers) || state.questionnaireAnswers.length !== state.questionnaireQuestions.length) {
                        state.questionnaireAnswers = new Array(state.questionnaireQuestions.length).fill('');
                    }
                    renderBatchQuestionList();
                    return;
                }

                const response = await fetch('/api/next-question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        purpose: purposeText,
                        field: fieldText,
                        history: state.questionnaireHistory,
                        max_questions: 5
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loading.classList.remove('visible');
                    renderNextQuestion(data);
                } else {
                    throw new Error(data.error || 'Failed to generate questions');
                }
            } catch (error) {
                loading.classList.remove('visible');
                alert('Error loading questionnaire: ' + error.message);
            }
        }

        function rebuildQuestionnaireHistoryFromAnswers() {
            const questions = Array.isArray(state.questionnaireQuestions) ? state.questionnaireQuestions : [];
            const answers = Array.isArray(state.questionnaireAnswers) ? state.questionnaireAnswers : [];
            state.questionnaireHistory = questions.map((q, idx) => ({
                question: String((q && q.question) || '').trim(),
                answer: String(answers[idx] || '').trim()
            })).filter(item => item.question);
        }

        function hydrateQuestionnaireAnswersFromHistory() {
            const questions = Array.isArray(state.questionnaireQuestions) ? state.questionnaireQuestions : [];
            const answers = new Array(questions.length).fill('');

            const history = Array.isArray(state.questionnaireHistory) ? state.questionnaireHistory : [];
            for (let i = 0; i < Math.min(history.length, answers.length); i++) {
                const a = history[i]?.answer;
                if (typeof a === 'string' && a.trim()) answers[i] = a.trim();
            }

            state.questionnaireAnswers = answers;
        }

        function renderBatchQuestionList() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            const questions = Array.isArray(state.questionnaireQuestions) ? state.questionnaireQuestions : [];
            if (questions.length === 0) {
                const info = document.createElement('div');
                info.className = 'notice';
                info.innerHTML = `<span class="icon">âš ï¸</span> No questions generated. Please try again.`;
                container.appendChild(info);
                return;
            }

            if (!Array.isArray(state.questionnaireAnswers) || state.questionnaireAnswers.length !== questions.length) {
                hydrateQuestionnaireAnswersFromHistory();
            }

            questions.forEach((item, idx) => {
                const questionText = item?.question || 'Tell us something about your background that is relevant for this outreach.';
                const options = Array.isArray(item?.options) ? item.options : null;

                const card = document.createElement('div');
                card.className = 'question-card';

                const answerValue = String(state.questionnaireAnswers[idx] || '');
                const hasOptions = options && options.length > 0;
                const lastOption = hasOptions ? options[options.length - 1] : null;
                const matchIndex = hasOptions ? options.findIndex(o => String(o) === answerValue) : -1;
                const shouldUseCustom = hasOptions && answerValue && matchIndex === -1;
                const selectedIndex = shouldUseCustom ? (options.length - 1) : matchIndex;

                let innerHtml = `<h4>Q${idx + 1}: ${questionText}</h4>`;

                if (hasOptions) {
                    innerHtml += `
                        <div class="question-options" data-q-index="${idx}">
                            ${options.map((opt, optIndex) => {
                                const isSelected = optIndex === selectedIndex;
                                return `<div class="question-option ${isSelected ? 'selected' : ''}" data-q="${idx}" data-index="${optIndex}">${opt}</div>`;
                            }).join('')}
                        </div>
                        <div class="question-custom-input ${selectedIndex === options.length - 1 ? 'visible' : ''}" data-q-custom="${idx}">
                            <textarea rows="2" data-q-custom-input="${idx}" placeholder="Your custom answer...">${selectedIndex === options.length - 1 ? answerValue : ''}</textarea>
                        </div>
                    `;
                } else {
                    innerHtml += `
                        <div class="question-custom-input visible">
                            <textarea rows="3" data-q-text-input="${idx}" placeholder="Type your answer here...">${answerValue}</textarea>
                        </div>
                    `;
                }

                card.innerHTML = innerHtml;
                container.appendChild(card);

                if (hasOptions) {
                    const optionEls = Array.from(card.querySelectorAll(`.question-option[data-q="${idx}"]`));
                    const customWrapper = card.querySelector(`[data-q-custom="${idx}"]`);
                    const customInput = card.querySelector(`[data-q-custom-input="${idx}"]`);

                    function setAnswerFromSelection(selectedOptIndex) {
                        const isCustom = selectedOptIndex === options.length - 1;
                        if (isCustom) {
                            const text = String(customInput?.value || '').trim();
                            state.questionnaireAnswers[idx] = text;
                        } else {
                            state.questionnaireAnswers[idx] = String(options[selectedOptIndex] || '').trim();
                        }
                        rebuildQuestionnaireHistoryFromAnswers();
                        checkStep2Valid();
                    }

                    optionEls.forEach(el => {
                        el.addEventListener('click', function() {
                            optionEls.forEach(o => o.classList.remove('selected'));
                            this.classList.add('selected');
                            const optIndex = parseInt(this.dataset.index, 10);
                            const isCustom = optIndex === options.length - 1;
                            if (customWrapper) customWrapper.classList.toggle('visible', isCustom);
                            setAnswerFromSelection(optIndex);
                        });
                    });

                    if (customInput) {
                        customInput.addEventListener('input', function() {
                            const selected = card.querySelector(`.question-option.selected[data-q="${idx}"]`);
                            const selectedOptIndex = selected ? parseInt(selected.dataset.index, 10) : -1;
                            if (selectedOptIndex === options.length - 1) {
                                setAnswerFromSelection(selectedOptIndex);
                            }
                        });
                    }

                    // If the last option is selected but no custom text yet, ensure history is still rebuilt
                    if (selectedIndex === options.length - 1 && !answerValue.trim()) {
                        state.questionnaireAnswers[idx] = '';
                    }
                } else {
                    const input = card.querySelector(`[data-q-text-input="${idx}"]`);
                    if (input) {
                        input.addEventListener('input', function() {
                            state.questionnaireAnswers[idx] = String(this.value || '');
                            rebuildQuestionnaireHistoryFromAnswers();
                            checkStep2Valid();
                        });
                    }
                }
            });

            rebuildQuestionnaireHistoryFromAnswers();
            checkStep2Valid();
        }

        // Render a single questionnaire question interactively
        function renderNextQuestion(result) {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            if (result.done) {
                const info = document.createElement('div');
                info.className = 'notice';
                info.innerHTML = `<span class="icon">âœ…</span> We already have enough info from your answers. You can continue to the next step.`;
                container.appendChild(info);
                checkStep2Valid();
                return;
            }

            const questionText = result.question || 'Tell us something about your background that is relevant for this outreach.';
            const options = Array.isArray(result.options) ? result.options : null;
            const card = document.createElement('div');
            card.className = 'question-card';
            
            let innerHtml = `
                <h4>Q${state.questionnaireHistory.length + 1}: ${questionText}</h4>
            `;

            if (options && options.length > 0) {
                innerHtml += `
                    <div class="question-options" id="question-options">
                        ${options.map((opt, idx) => `
                            <div class="question-option" data-index="${idx}">${opt}</div>
                        `).join('')}
                    </div>
                    <div class="question-custom-input" id="question-custom-wrapper">
                        <textarea id="question-custom-input" rows="2" placeholder="Your custom answer..."></textarea>
                    </div>
                `;
            } else {
                innerHtml += `
                    <div class="question-custom-input visible">
                        <textarea id="question-answer-input" rows="3" placeholder="Type your answer here..."></textarea>
                    </div>
                `;
            }

            innerHtml += `
                <div class="btn-group" style="margin-top: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="btn-skip-question">Skip</button>
                    <button class="btn btn-primary" id="btn-next-question" disabled>Next Question</button>
                </div>`;

            card.innerHTML = innerHtml;
            container.appendChild(card);

            const nextBtn = document.getElementById('btn-next-question');
            const skipBtn = document.getElementById('btn-skip-question');

            let selectedIndex = null;

            if (options && options.length > 0) {
                const optionEls = Array.from(document.querySelectorAll('#question-options .question-option'));
                const customWrapper = document.getElementById('question-custom-wrapper');
                const customInput = document.getElementById('question-custom-input');

                function updateNextEnabled() {
                    if (selectedIndex === null) {
                        nextBtn.disabled = true;
                        return;
                    }
                    const isLast = selectedIndex === options.length - 1;
                    if (isLast) {
                        nextBtn.disabled = !customInput.value.trim();
                    } else {
                        nextBtn.disabled = false;
                    }
                }

                optionEls.forEach(el => {
                    el.addEventListener('click', function() {
                        optionEls.forEach(o => o.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedIndex = parseInt(this.dataset.index, 10);
                        const isLast = selectedIndex === options.length - 1;
                        if (isLast) {
                            customWrapper.classList.add('visible');
                        } else {
                            customWrapper.classList.remove('visible');
                        }
                        updateNextEnabled();
                    });
                });

                if (customInput) {
                    customInput.addEventListener('input', updateNextEnabled);
                }
            } else {
                const answerInput = document.getElementById('question-answer-input');
                answerInput.addEventListener('input', function() {
                    nextBtn.disabled = !this.value.trim();
                });
            }

            async function submitAnswerAndLoadNext(answer) {
                state.questionnaireHistory.push({
                    question: questionText,
                    answer: answer || ''
                });
                checkStep2Valid();
                const loading = document.getElementById('questionnaire-loading');
                loading.classList.add('visible');
                try {
                    const response = await fetch('/api/next-question', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            purpose: getPurposeText(),
                            field: getFieldText(),
                            history: state.questionnaireHistory,
                            max_questions: 5
                        })
                    });
                    const data = await response.json();
                    loading.classList.remove('visible');
                    if (data.success) {
                        renderNextQuestion(data);
                    } else {
                        throw new Error(data.error || 'Failed to load next question');
                    }
                } catch (error) {
                    loading.classList.remove('visible');
                    alert('Error loading next question: ' + error.message);
                }
            }

            nextBtn.addEventListener('click', function() {
                let answer = '';
                if (options && options.length > 0) {
                    if (selectedIndex === null) return;
                    const isLast = selectedIndex === options.length - 1;
                    if (isLast) {
                        const customInput = document.getElementById('question-custom-input');
                        if (!customInput.value.trim()) return;
                        answer = customInput.value.trim();
                    } else {
                        answer = options[selectedIndex];
                    }
                } else {
                    const answerInput = document.getElementById('question-answer-input');
                    answer = (answerInput.value || '').trim();
                    if (!answer) return;
                }
                submitAnswerAndLoadNext(answer);
            });

            skipBtn.addEventListener('click', function() {
                submitAnswerAndLoadNext('');
            });
        }

        // Load next target preference question
        async function loadTargetQuestionnaire() {
            const container = document.getElementById('target-questions-container');
            const loading = document.getElementById('target-questionnaire-loading');
            if (!container || !loading) return;
            
            container.innerHTML = '';
            loading.classList.add('visible');
            
            try {
                const response = await fetch('/api/next-target-question', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        purpose: getPurposeText(),
                        field: getTargetFieldFromPreferences() || getFieldText(),
                        sender_profile: state.senderProfile,
                        history: state.targetPreferenceHistory,
                        max_questions: 5
                    })
                });
                const data = await response.json();
                loading.classList.remove('visible');
                if (data.success) {
                    renderNextTargetQuestion(data);
                } else {
                    throw new Error(data.error || 'Failed to load target preference question');
                }
            } catch (error) {
                loading.classList.remove('visible');
                console.error('Error loading target questionnaire:', error);
            }
        }

        // Render a single target preference question
        function renderNextTargetQuestion(result) {
            const container = document.getElementById('target-questions-container');
            if (!container) return;
            container.innerHTML = '';
            
            if (result.done) {
                const info = document.createElement('div');
                info.className = 'notice';
                info.innerHTML = `<span class="icon">âœ…</span> We have enough preference info. You can now find matches.`;
                container.appendChild(info);
                return;
            }

            const questionText = result.question || 'What kind of people would you most like to reach?';
            const options = Array.isArray(result.options) ? result.options : null;
            const card = document.createElement('div');
            card.className = 'question-card';

            let innerHtml = `<h4>Preference Q${state.targetPreferenceHistory.length + 1}: ${questionText}</h4>`;

            if (options && options.length > 0) {
                innerHtml += `<div style="margin: 6px 0 8px; color: #a0a0b0; font-size: 12px;">Tip: You can select multiple options.</div>`;
                innerHtml += `
                    <div class="question-options" id="target-question-options">
                        ${options.map((opt, idx) => `
                            <div class="question-option" data-index="${idx}">${opt}</div>
                        `).join('')}
                    </div>
                    <div class="question-custom-input" id="target-question-custom-wrapper">
                        <textarea id="target-question-custom-input" rows="2" placeholder="Your custom answer..."></textarea>
                    </div>
                `;
            } else {
                innerHtml += `
                    <div class="question-custom-input visible">
                        <textarea id="target-question-answer-input" rows="3" placeholder="Type your answer here..."></textarea>
                    </div>
                `;
            }

            innerHtml += `
                <div class="btn-group" style="margin-top: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" id="btn-target-skip-question">Skip</button>
                    <button class="btn btn-primary" id="btn-target-next-question" disabled>Next Preference</button>
                </div>
            `;

            card.innerHTML = innerHtml;
            container.appendChild(card);

            const nextBtn = document.getElementById('btn-target-next-question');
            const skipBtn = document.getElementById('btn-target-skip-question');
            const selectedIndexes = new Set();

            if (options && options.length > 0) {
                const optionEls = Array.from(document.querySelectorAll('#target-question-options .question-option'));
                const customWrapper = document.getElementById('target-question-custom-wrapper');
                const customInput = document.getElementById('target-question-custom-input');
                const lastIndex = options.length - 1;

                function updateNextEnabled() {
                    if (selectedIndexes.size === 0) {
                        nextBtn.disabled = true;
                        return;
                    }
                    if (selectedIndexes.has(lastIndex)) {
                        nextBtn.disabled = !customInput.value.trim();
                    } else {
                        nextBtn.disabled = false;
                    }
                }

                optionEls.forEach(el => {
                    el.addEventListener('click', function() {
                        const idx = parseInt(this.dataset.index, 10);
                        if (Number.isNaN(idx)) return;

                        if (selectedIndexes.has(idx)) {
                            selectedIndexes.delete(idx);
                            this.classList.remove('selected');
                        } else {
                            selectedIndexes.add(idx);
                            this.classList.add('selected');
                        }

                        if (selectedIndexes.has(lastIndex)) {
                            customWrapper.classList.add('visible');
                        } else {
                            customWrapper.classList.remove('visible');
                        }
                        updateNextEnabled();
                    });
                });

                if (customInput) {
                    customInput.addEventListener('input', updateNextEnabled);
                }
            } else {
                const answerInput = document.getElementById('target-question-answer-input');
                answerInput.addEventListener('input', function() {
                    nextBtn.disabled = !this.value.trim();
                });
            }

            async function submitTargetAnswerAndLoadNext(answer) {
                state.targetPreferenceHistory.push({
                    question: questionText,
                    answer: answer || ''
                });
                try {
                    const loading = document.getElementById('target-questionnaire-loading');
                    loading.classList.add('visible');
                    const response = await fetch('/api/next-target-question', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            purpose: getPurposeText(),
                            field: getTargetFieldFromPreferences() || getFieldText(),
                            sender_profile: state.senderProfile,
                            history: state.targetPreferenceHistory,
                            max_questions: 5
                        })
                    });
                    const data = await response.json();
                    loading.classList.remove('visible');
                    if (data.success) {
                        renderNextTargetQuestion(data);
                    } else {
                        throw new Error(data.error || 'Failed to load next preference question');
                    }
                } catch (error) {
                    const loading = document.getElementById('target-questionnaire-loading');
                    loading.classList.remove('visible');
                    console.error('Error loading next preference question:', error);
                }
            }

            nextBtn.addEventListener('click', function() {
                let answer = '';
                if (options && options.length > 0) {
                    if (selectedIndexes.size === 0) return;
                    const lastIndex = options.length - 1;
                    const parts = [];

                    for (let i = 0; i < options.length; i++) {
                        if (i === lastIndex) continue;
                        if (selectedIndexes.has(i)) parts.push(options[i]);
                    }

                    if (selectedIndexes.has(lastIndex)) {
                        const customInput = document.getElementById('target-question-custom-input');
                        if (!customInput.value.trim()) return;
                        const customText = customInput.value.trim();
                        if (parts.length === 0) {
                            answer = customText;
                        } else {
                            parts.push(`Other: ${customText}`);
                        }
                    }
                    if (!answer) answer = parts.join('; ');
                    if (!answer) return;
                } else {
                    const answerInput = document.getElementById('target-question-answer-input');
                    answer = (answerInput.value || '').trim();
                    if (!answer) return;
                }
                submitTargetAnswerAndLoadNext(answer);
            });

            skipBtn.addEventListener('click', function() {
                submitTargetAnswerAndLoadNext('');
            });
        }

        // Dynamic loading messages for search
        const searchLoadingMessages = [
            'Searching for the best matches based on your profile and preferences',
            'Analyzing your background and interests',
            'Scanning professional networks for relevant contacts',
            'Evaluating match scores and compatibility',
            'Preparing personalized recommendations for you'
        ];
        let searchLoadingInterval = null;

        function startSearchLoadingAnimation() {
            const loadingText = document.getElementById('rec-loading-text');
            if (!loadingText) return;
            
            let messageIndex = 0;
            const updateMessage = () => {
                loadingText.classList.add('fade');
                setTimeout(() => {
                    messageIndex = (messageIndex + 1) % searchLoadingMessages.length;
                    loadingText.innerHTML = `<span class="loading-dots">${searchLoadingMessages[messageIndex]}</span>`;
                    loadingText.classList.remove('fade');
                }, 300);
            };
            
            // Reset to first message
            loadingText.innerHTML = `<span class="loading-dots">${searchLoadingMessages[0]}</span>`;
            searchLoadingInterval = setInterval(updateMessage, 3000);
        }

        function stopSearchLoadingAnimation() {
            if (searchLoadingInterval) {
                clearInterval(searchLoadingInterval);
                searchLoadingInterval = null;
            }
        }

        // Load recommendations
        async function loadRecommendations() {
            const list = document.getElementById('recommendation-list');
            const loading = document.getElementById('rec-loading');
            const actions = document.getElementById('rec-actions');
            
            list.innerHTML = '';
            loading.classList.add('visible');
            startSearchLoadingAnimation();
            actions.style.display = 'none';
            document.getElementById('recommendation-section').classList.remove('hidden');
            
            try {
                const purposeText = getPurposeText();
                const fieldText = getTargetFieldFromPreferences() || getFieldText();
                const prefHistory = state.targetPreferenceHistory || [];
                const prefExtra = prefHistory.length > 0
                    ? prefHistory.map((qa, idx) => `Q${idx + 1}: ${qa.question}\nA${idx + 1}: ${qa.answer}`).join('\n\n')
                    : '';
                
                const response = await fetch('/api/find-recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        purpose: purposeText,
                        field: fieldText,
                        sender_profile: state.senderProfile,
                        preferences: {
                            extra: prefExtra,
                            search_intent: (state.targetSearchIntent || '').trim(),
                            must_have: (state.targetMustHave || '').trim(),
                            must_not: (state.targetMustNot || '').trim(),
                            location: (state.targetLocation || '').trim(),
                            contactability: (state.targetContactability || 'balanced').trim(),
                            examples: (state.targetExamples || '').trim(),
                            evidence: (state.targetEvidence || '').trim(),
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    stopSearchLoadingAnimation();
                    loading.classList.remove('visible');
                    actions.style.display = 'flex';
                    state.recommendations = data.recommendations;
                    renderRecommendations(data.recommendations);
                } else {
                    throw new Error(data.error || 'Failed to find recommendations');
                }
            } catch (error) {
                stopSearchLoadingAnimation();
                loading.classList.remove('visible');
                alert('Error finding recommendations: ' + error.message);
            }
        }

        // Render recommendations
        function renderRecommendations(recommendations) {
            const list = document.getElementById('recommendation-list');
            list.innerHTML = '';
            
            recommendations.forEach((rec, index) => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.dataset.index = index;
                item.dataset.recId = rec.id || '';  // Store unique ID in data attribute
                
                // Check if already selected - use unique ID if available, fallback to name
                const isSelected = state.selectedTargets.some(t => 
                    (rec.id && t.id === rec.id) || (!rec.id && t.name === rec.name)
                );
                if (isSelected) item.classList.add('selected');
                
                const matchClass = rec.match_score >= 80 ? 'high' : (rec.match_score >= 60 ? 'medium' : 'low');
                
                // LinkedIn link - detect if it's a search URL or direct profile URL
                let linkedinHtml = '';
                if (rec.linkedin_url) {
                    const isSearchUrl = rec.linkedin_url.includes('/search/results/');
                    const title = isSearchUrl ? 'Search on LinkedIn' : 'View LinkedIn Profile';
                    const iconColor = isSearchUrl ? '#0077b5' : 'currentColor';
                    linkedinHtml = `<a href="${rec.linkedin_url}" target="_blank" onclick="event.stopPropagation();" class="linkedin-link ${isSearchUrl ? 'search-link' : ''}" title="${title}">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="${iconColor}"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
                        ${isSearchUrl ? 'ðŸ”' : ''}
                    </a>`;
                }
                
                item.innerHTML = `
                    <div class="rec-checkbox">${isSelected ? 'âœ“' : ''}</div>
                    <div class="rec-avatar">${rec.name.charAt(0)}</div>
                    <div class="rec-info">
                        <div class="rec-name">${rec.name} ${linkedinHtml}</div>
                        <div class="rec-field">${rec.position || rec.field}</div>
                    </div>
                    <button class="view-profile-btn" onclick="event.stopPropagation(); openProfileModal(${index})">ðŸ“‹ View</button>
                    <div class="rec-match ${matchClass}">${rec.match_score}% Match</div>
                `;
                
                item.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('view-profile-btn') && !e.target.closest('.linkedin-link')) {
                        toggleRecommendation(index);
                    }
                });
                
                list.appendChild(item);
            });
        }

        // Toggle recommendation selection (multi-select)
        function toggleRecommendation(index) {
            const rec = state.recommendations[index];
            // Use unique ID for matching if available, fallback to name
            const existingIndex = state.selectedTargets.findIndex(t => 
                (rec.id && t.id === rec.id) || (!rec.id && t.name === rec.name)
            );
            
            if (existingIndex >= 0) {
                // Remove from selection
                state.selectedTargets.splice(existingIndex, 1);
            } else {
                // Add to selection (clone to avoid reference issues)
                state.selectedTargets.push({ ...rec });
            }
            
            // Update UI
            updateSelectedTargetsUI();
            
            // Show match details for last clicked
            const details = document.getElementById('match-details');
            details.classList.add('visible');
            document.getElementById('match-score-text').textContent = `${rec.match_score}% compatibility based on your background and goals.`;
            document.getElementById('match-interests-text').textContent = rec.common_interests || 'Analyzing...';
            document.getElementById('match-reason-text').textContent = rec.match_reason || 'This person aligns well with your stated purpose and field.';
            
            checkStep3Valid();
        }

        // Update selected targets UI
        function updateSelectedTargetsUI() {
            const container = document.getElementById('selected-targets');
            const tagsContainer = document.getElementById('selected-target-tags');
            const countSpan = document.getElementById('selected-count');
            
            if (state.selectedTargets.length > 0) {
                container.classList.add('visible');
                countSpan.textContent = state.selectedTargets.length;
                
                tagsContainer.innerHTML = state.selectedTargets.map((t, i) => `
                    <div class="target-tag">
                        ${t.name}
                        <span class="remove" onclick="removeSelectedTarget(${i})">âœ•</span>
                    </div>
                `).join('');
            } else {
                container.classList.remove('visible');
            }
            
            // Update recommendation list checkboxes
            document.querySelectorAll('.recommendation-item').forEach(item => {
                const index = parseInt(item.dataset.index);
                const rec = state.recommendations[index];
                if (!rec) return;  // Safety check
                // Use unique ID for matching if available, fallback to name
                const isSelected = state.selectedTargets.some(t => 
                    (rec.id && t.id === rec.id) || (!rec.id && t.name === rec.name)
                );
                
                if (isSelected) {
                    item.classList.add('selected');
                    item.querySelector('.rec-checkbox').textContent = 'âœ“';
                } else {
                    item.classList.remove('selected');
                    item.querySelector('.rec-checkbox').textContent = '';
                }
            });
        }

        // Remove a selected target
        function removeSelectedTarget(index) {
            state.selectedTargets.splice(index, 1);
            updateSelectedTargetsUI();
            checkStep3Valid();
        }

        // Setup navigation buttons
        function setupNavigationButtons() {
            // Step 1 -> Step 2
            document.getElementById('btn-step1-next').addEventListener('click', function() {
                goToStep(2);
                
                // For Quick Start mode, auto-configure Step 2
                if (state.mode === 'quick') {
                    // Hide resume choice section (Quick Start uses optional inputs)
                    document.getElementById('resume-choice-section').classList.add('hidden');
                    // Show quick start notice
                    document.getElementById('quick-start-notice').classList.remove('hidden');
                    // Show optional resume upload (Quick Start only)
                    document.getElementById('resume-upload-section').classList.remove('hidden');
                    // Show questionnaire only if no other context is provided
                    updateQuickStartQuestionnaireVisibility();
                }
            });

            // Step 2 Back
            document.getElementById('btn-step2-back').addEventListener('click', function() {
                goToStep(1);
            });

            // Step 2 -> Step 3
            document.getElementById('btn-step2-next').addEventListener('click', async function() {
                if (state.mode === 'quick') {
                    await ensureQuickStartSenderProfile();
                } else if (!state.hasResume && state.questionnaireHistory.length > 0) {
                    // Build profile from questionnaire
                    await buildProfileFromQuestionnaire();
                }
                goToStep(3);
                
                // For Quick Start mode, hide document upload in Step 3
                if (state.mode === 'quick') {
                    const docUploadSection = document.getElementById('target-doc-upload-section');
                    if (docUploadSection) {
                        docUploadSection.classList.add('hidden');
                    }
                }
            });

            // Step 3 Back
            document.getElementById('btn-step3-back').addEventListener('click', function() {
                if (state.mode === 'professional') {
                    // Professional mode: go back to the appropriate pro screen
                    document.getElementById('progress-container').classList.add('hidden');
                    document.getElementById('step-3').classList.add('hidden');
                    
                    if (state.hasTarget) {
                        // User had targets - go back to target choice
                        document.getElementById('pro-target-choice').classList.remove('hidden');
                    } else {
                        // User was searching for targets - go back to preferences
                        document.getElementById('pro-preferences').classList.remove('hidden');
                    }
                } else {
                    // Quick Start mode: go to Step 2
                    goToStep(2);
                }
            });

            // Step 3 -> Step 4
            document.getElementById('btn-step3-next').addEventListener('click', async function() {
                if (state.hasTarget) {
                    // Get target info from input fields - single manual target
                    const targetData = {
                        name: document.getElementById('target-name').value,
                        field: document.getElementById('target-field').value
                    };
                    
                    // Merge with uploaded document profile if available
                    if (state.manualTargetProfile) {
                        Object.assign(targetData, state.manualTargetProfile);
                    }
                    
                    state.selectedTargets = [targetData];
                }
                goToStep(4);
            });

            // Step 4 Back (from template/mode selection to targets)
            document.getElementById('btn-step4-back').addEventListener('click', function() {
                goToStep(3);
            });

            // Step 4 -> Step 5 (generate emails)
            document.getElementById('btn-step4-next').addEventListener('click', async function() {
                goToStep(5);
                await generateAllEmails();
            });

            // Step 5 Back (from generated emails to template/mode selection)
            document.getElementById('btn-step5-back').addEventListener('click', function() {
                goToStep(4);
            });

            // Copy subject / body (ChatGPT-style inline buttons)
            document.getElementById('btn-copy-subject').addEventListener('click', async function() {
                const subjectValue = document.getElementById('email-subject').value || '';
                try {
                    await navigator.clipboard.writeText(subjectValue);
                    setCopyButtonState(this, 'Copied', 'Copy');
                } catch (e) {
                    alert('Failed to copy subject. Your browser may block clipboard access.');
                }
            });

            document.getElementById('btn-copy-body').addEventListener('click', async function() {
                const bodyValue = document.getElementById('email-body').value || '';
                try {
                    await navigator.clipboard.writeText(bodyValue);
                    setCopyButtonState(this, 'Copied', 'Copy');
                } catch (e) {
                    alert('Failed to copy email. Your browser may block clipboard access.');
                }
            });

            // Keep state in sync if user edits subject/body
            document.getElementById('email-subject').addEventListener('input', syncEmailEditorToState);
            document.getElementById('email-body').addEventListener('input', syncEmailEditorToState);

            // Copy all emails to clipboard
            document.getElementById('btn-copy-all').addEventListener('click', function() {
                const allEmailsText = state.generatedEmails.map((e, i) => {
                    const parts = parseEmailText(e.email);
                    const subjectLine = parts.subject ? `Subject: ${parts.subject}` : 'Subject:';
                    return `=== Email ${i + 1}: To ${e.target.name} ===\n${subjectLine}\n\n${parts.body}`;
                }).join('\n\n' + '='.repeat(50) + '\n\n');
                navigator.clipboard.writeText(allEmailsText);
                this.textContent = 'âœ… All Copied!';
                setTimeout(() => { this.textContent = 'ðŸ“‹ Copy All Emails'; }, 2000);
            });

            // Email navigation
            document.getElementById('btn-prev-email').addEventListener('click', function() {
                if (state.currentEmailIndex > 0) {
                    state.currentEmailIndex--;
                    displayCurrentEmail();
                }
            });

            document.getElementById('btn-next-email').addEventListener('click', function() {
                if (state.currentEmailIndex < state.generatedEmails.length - 1) {
                    state.currentEmailIndex++;
                    displayCurrentEmail();
                }
            });

            // New email
            document.getElementById('btn-new-email').addEventListener('click', function() {
                location.reload();
            });

            // More recommendations
            document.getElementById('btn-more-recs').addEventListener('click', loadRecommendations);

            // Add manual target from recommendations
            document.getElementById('btn-add-manual').addEventListener('click', function() {
                state.hasTarget = true;
                document.querySelectorAll('#target-choice .choice-btn').forEach(b => b.classList.remove('selected'));
                document.querySelector('#target-choice .choice-btn[data-value="yes"]').classList.add('selected');
                document.getElementById('manual-target-section').classList.remove('hidden');
                document.getElementById('target-preferences').classList.add('hidden');
                document.getElementById('recommendation-section').classList.add('hidden');
                document.getElementById('match-details').classList.remove('visible');
                resetRecommendationState();
            });
        }

        // Build profile from questionnaire answers
        async function buildProfileFromQuestionnaire() {
            try {
                const answers = state.questionnaireHistory
                    .map(qa => qa.answer)
                    .filter(a => a && a.trim());
                
                const response = await fetch('/api/profile-from-questionnaire', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        purpose: getPurposeText(),
                        field: getFieldText(),
                        answers: answers
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    state.senderProfile = data.profile;
                }
            } catch (error) {
                console.error('Error building profile:', error);
            }
        }

        function updateQuickStartQuestionnaireVisibility() {
            if (state.mode !== 'quick') return;

            const questionnaire = document.getElementById('questionnaire-section');
            if (!questionnaire) return;
            const prompt = document.getElementById('quick-question-prompt');

            const hasResumeProfile = Boolean(state.senderProfile);
            const hasLink = Boolean((state.senderProfileLink || '').trim());
            const hasExtra = Boolean((state.senderProfileExtra || '').trim());
            const hasAnyContext = hasResumeProfile || hasLink || hasExtra;

            if (hasAnyContext) {
                if (prompt) prompt.classList.add('hidden');
                questionnaire.classList.remove('visible');
                return;
            }

            questionnaire.classList.add('visible');

            if (!state.quickQuestionsEnabled) {
                if (prompt) prompt.classList.remove('hidden');
                return;
            }

            if (prompt) prompt.classList.add('hidden');

            const hasQuestions = Array.isArray(state.questionnaireQuestions) && state.questionnaireQuestions.length > 0;
            if (!hasQuestions) {
                loadQuestionnaire();
            }
        }

        function setupQuickStartQuestionPrompt() {
            const btn = document.getElementById('btn-generate-questions');
            if (!btn) return;
            btn.addEventListener('click', function() {
                state.quickQuestionsEnabled = true;
                updateQuickStartQuestionnaireVisibility();
                checkStep2Valid();
            });
        }

	        async function ensureQuickStartSenderProfile() {
	            if (state.mode !== 'quick') return;

            if (state.senderProfile) return;

            const link = (state.senderProfileLink || '').trim();
            const extra = (state.senderProfileExtra || '').trim();
            if (link || extra) {
                let rawText = '';
                if (link) rawText += `Profile link: ${link}`;
                if (extra) rawText += `${rawText ? '\n\n' : ''}Additional profile notes:\n${extra}`;
                state.senderProfile = {
                    name: 'User',
                    raw_text: rawText,
                    education: [],
                    experiences: [],
                    skills: [],
                    projects: []
                };
                return;
            }

            const hasAnyAnswer = Array.isArray(state.questionnaireHistory)
                && state.questionnaireHistory.some(qa => (qa.answer || '').trim().length > 0);
	            if (hasAnyAnswer) {
	                await buildProfileFromQuestionnaire();
	            }
	        }

	        function normalizeText(value) {
	            if (value === null || value === undefined) return '';
	            return String(value).trim();
	        }

	        function normalizeTextList(value) {
	            if (!Array.isArray(value)) return [];
	            return value.map(v => normalizeText(v)).filter(Boolean);
	        }

	        function uniqueTextList(values) {
	            const out = [];
	            const seen = new Set();
	            (values || []).forEach(v => {
	                const s = normalizeText(v);
	                if (!s || seen.has(s)) return;
	                seen.add(s);
	                out.push(s);
	            });
	            return out;
	        }

	        function mergeTextLists(...lists) {
	            const merged = [];
	            lists.forEach(list => {
	                if (Array.isArray(list)) {
	                    merged.push(...list);
	                    return;
	                }
	                if (typeof list === 'string' && list.trim()) {
	                    merged.push(list);
	                }
	            });
	            return uniqueTextList(merged);
	        }

	        function mergeReceiverProfiles(base, fetched) {
	            const b = (base && typeof base === 'object') ? base : {};
	            const f = (fetched && typeof fetched === 'object') ? fetched : {};
	            const merged = { ...b, ...f };

	            merged.name = normalizeText(f.name) || normalizeText(b.name);
	            merged.field = normalizeText(f.field) || normalizeText(b.field);
	            merged.position = normalizeText(b.position) || normalizeText(f.position) || normalizeText(b.field) || normalizeText(f.field);
	            merged.linkedin_url = normalizeText(b.linkedin_url) || normalizeText(f.linkedin_url);
	            merged.raw_text = normalizeText(f.raw_text) || normalizeText(b.raw_text);

	            merged.education = mergeTextLists(b.education, f.education);
	            merged.experiences = mergeTextLists(b.experiences, f.experiences);
	            merged.skills = mergeTextLists(b.skills, f.skills);
	            merged.projects = mergeTextLists(b.projects, f.projects);

	            merged.evidence = mergeTextLists(b.evidence, f.evidence);
	            merged.sources = mergeTextLists(b.sources, f.sources, merged.linkedin_url ? [merged.linkedin_url] : []);

	            const positionLine = normalizeText(merged.position);
	            if (positionLine) {
	                const posLower = positionLine.toLowerCase();
	                const experiences = Array.isArray(merged.experiences) ? merged.experiences.slice() : [];
	                const hasPosition = experiences.some(e => normalizeText(e).toLowerCase().includes(posLower));
	                if (!hasPosition) {
	                    merged.experiences = [positionLine, ...experiences];
	                }
	            }

	            return merged;
	        }

	        function buildReceiverEmailContext(profile) {
	            if (!profile || typeof profile !== 'object') return '';
	            const lines = [];
	            const position = normalizeText(profile.position);
	            if (position) lines.push(`Current role: ${position}`);
	            const linkedinUrl = normalizeText(profile.linkedin_url);
	            if (linkedinUrl) lines.push(`LinkedIn: ${linkedinUrl}`);

	            const evidence = normalizeTextList(profile.evidence);
	            if (evidence.length) {
	                lines.push('Evidence snippets:');
	                evidence.slice(0, 2).forEach(e => lines.push(`- ${e}`));
	            }
	            return lines.join('\n');
	        }

	        // Generate all emails for selected targets
	        async function generateAllEmails() {
            const loading = document.getElementById('email-loading');
            const result = document.getElementById('email-result');
            const nav = document.getElementById('email-nav');
            const progress = document.getElementById('email-progress');
            
            loading.classList.add('visible');
            result.classList.remove('hidden');
            result.classList.add('hidden');
            nav.classList.add('hidden');
            state.generatedEmails = [];
            state.currentEmailIndex = 0;
            
            // ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„ targets
            if (state.selectedTargets && state.selectedTargets.length > 0) {
                try {
                    await fetch('/api/save-targets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: state.sessionId || 'default',
                            targets: state.selectedTargets
                        })
                    });
                } catch (e) {
                    console.log('Failed to save targets:', e);
                }
            }
            
            try {
                const templateInput = document.getElementById('email-template');
                const templateText = templateInput ? templateInput.value.trim() : '';
                const total = state.selectedTargets.length;
                
                for (let i = 0; i < total; i++) {
                    const target = state.selectedTargets[i];
                    progress.textContent = `(${i + 1}/${total}: Researching ${target.name}...)`;
                    
                    // Search for receiver info if needed (only if no uploaded profile data)
                    let receiverProfile = { ...target };
                    
                    // Check if target already has profile data (from uploaded document or has detailed info)
                    const hasProfileData = target.education && target.education.length > 0 ||
                                          target.experiences && target.experiences.length > 0 ||
                                          target.raw_text;
                    
	                    if (!hasProfileData) {
	                        const searchResponse = await fetch('/api/search-receiver', {
	                            method: 'POST',
	                            headers: { 'Content-Type': 'application/json' },
	                            body: JSON.stringify({
	                                name: target.name,
	                                field: target.field || target.position || getFieldText()
	                            })
	                        });
	                        const searchData = await searchResponse.json();
	                        if (searchData.success) {
	                            receiverProfile = mergeReceiverProfiles(receiverProfile, searchData.profile);
	                        }
	                    }
                    
                    // Enrich sender and receiver context with optional profile links/notes
                    let senderRawText = (state.senderProfile && state.senderProfile.raw_text) || '';
                    const senderLink = (state.senderProfileLink || '').trim();
                    const senderExtra = (state.senderProfileExtra || '').trim();
                    if (senderLink) {
                        senderRawText += `\n\nProfile link: ${senderLink}`;
                    }
                    if (senderExtra) {
                        senderRawText += `\n\nAdditional profile notes:\n${senderExtra}`;
                    }

                    const emailValue = (state.emailValue || '').trim();
                    const emailConstraints = (state.emailConstraints || '').trim();
                    const emailTaboos = (state.emailTaboos || '').trim();
                    const emailEvidence = (state.emailEvidence || '').trim();
                    if (emailValue) {
                        senderRawText += `\n\nValue I can offer:\n${emailValue}`;
                    }
                    if (emailConstraints) {
                        senderRawText += `\n\nEmail constraints:\n${emailConstraints}`;
                    }
                    if (emailTaboos) {
                        senderRawText += `\n\nHard rules (do not mention / do not invent):\n${emailTaboos}`;
                    }
                    if (emailEvidence) {
                        senderRawText += `\n\nEvidence you may cite:\n${emailEvidence}`;
                    }

                    let receiverRawText = receiverProfile.raw_text || '';
                    const targetLink = (state.targetProfileLink || '').trim();
                    const targetExtra = (state.targetProfileExtra || '').trim();
                    if (targetLink) {
                        receiverRawText += `\n\nProfile link: ${targetLink}`;
                    }
	                    if (targetExtra) {
	                        receiverRawText += `\n\nAdditional profile notes:\n${targetExtra}`;
	                    }
	                    receiverProfile.raw_text = receiverRawText;
	                    const receiverContext = buildReceiverEmailContext(receiverProfile);
	                    if (receiverContext) {
	                        receiverProfile.context = receiverProfile.context
	                            ? `${receiverProfile.context}\n\n${receiverContext}`
	                            : receiverContext;
	                    }

	                    // Generate email
	                    const goalText = (state.emailGoal || '').trim() || getPurposeText();
                    const askText = (state.emailAsk || '').trim()
                        || `I am looking to ${getPurposeText().toLowerCase()} in ${getFieldText()}`;
                    const bodyPayload = {
                        sender: {
                            ...state.senderProfile,
                            raw_text: senderRawText,
                            motivation: getPurposeText(),
                            ask: askText
                        },
                        receiver: receiverProfile,
                        goal: goalText
                    };

                    if (state.generationMode === 'template' && templateText) {
                        bodyPayload.template = templateText;
                    }

                    const response = await fetch('/api/generate-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bodyPayload)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        state.generatedEmails.push({
                            target: target,
                            receiverProfile: receiverProfile,
                            email: data.email
                        });
                    } else {
                        state.generatedEmails.push({
                            target: target,
                            receiverProfile: receiverProfile,
                            email: `Error generating email: ${data.error || 'Unknown error'}`
                        });
                    }
                }
                
                loading.classList.remove('visible');
                result.classList.remove('hidden');
                
                // Show navigation if multiple emails
                if (state.generatedEmails.length > 1) {
                    nav.classList.remove('hidden');
                    document.getElementById('total-emails').textContent = state.generatedEmails.length;
                }
                
                displayCurrentEmail();
                
            } catch (error) {
                loading.classList.remove('visible');
                alert('Error generating emails: ' + error.message);
            }
        }

        // Display current email in the viewer
        function displayCurrentEmail() {
            const current = state.generatedEmails[state.currentEmailIndex];
            if (!current) return;
            
            document.getElementById('email-target-name').textContent = current.target.name;
            document.getElementById('email-target-field').textContent = current.target.field || current.target.position || getFieldText();
            const parts = parseEmailText(current.email);
            document.getElementById('email-subject').value = parts.subject;
            document.getElementById('email-body').value = parts.body;
            document.getElementById('current-email-num').textContent = state.currentEmailIndex + 1;

            const copySubjectBtn = document.getElementById('btn-copy-subject');
            if (copySubjectBtn) {
                copySubjectBtn.classList.remove('copied');
                copySubjectBtn.textContent = 'Copy';
            }
            const copyBodyBtn = document.getElementById('btn-copy-body');
            if (copyBodyBtn) {
                copyBodyBtn.classList.remove('copied');
                copyBodyBtn.textContent = 'Copy';
            }
            
            // Update navigation buttons
            document.getElementById('btn-prev-email').disabled = state.currentEmailIndex === 0;
            document.getElementById('btn-next-email').disabled = state.currentEmailIndex >= state.generatedEmails.length - 1;
        }

        // Setup regenerate
        function setupRegenerate() {
            const styleOptions = document.querySelectorAll('#style-options .style-option');
            styleOptions.forEach(opt => {
                opt.addEventListener('click', function() {
                    styleOptions.forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    state.regenerateStyle = this.dataset.style;
                    
                    const customInput = document.getElementById('style-custom');
                    if (state.regenerateStyle === 'custom') {
                        customInput.classList.add('visible');
                    } else {
                        customInput.classList.remove('visible');
                    }
                });
            });

            document.getElementById('btn-regenerate').addEventListener('click', regenerateEmail);
        }

        // Track optional sender/target profile links and extra text
        function setupProfileLinkInputs() {
            const senderLinkInput = document.getElementById('sender-profile-link');
            const senderExtraInput = document.getElementById('sender-profile-extra');
            const targetLinkInput = document.getElementById('target-profile-link');
            const targetExtraInput = document.getElementById('target-profile-extra');

            if (senderLinkInput) {
                senderLinkInput.addEventListener('input', function() {
                    state.senderProfileLink = this.value;
                    updateQuickStartQuestionnaireVisibility();
                    checkStep2Valid();
                });
            }
            if (senderExtraInput) {
                senderExtraInput.addEventListener('input', function() {
                    state.senderProfileExtra = this.value;
                    updateQuickStartQuestionnaireVisibility();
                    checkStep2Valid();
                });
            }
            if (targetLinkInput) {
                targetLinkInput.addEventListener('input', function() {
                    state.targetProfileLink = this.value;
                });
            }
            if (targetExtraInput) {
                targetExtraInput.addEventListener('input', function() {
                    state.targetProfileExtra = this.value;
                });
            }
        }

        function setupTargetingContextInputs() {
            function setupToggle(toggleId, panelId) {
                const toggleBtn = document.getElementById(toggleId);
                const panel = document.getElementById(panelId);
                if (!toggleBtn || !panel) return;
                toggleBtn.addEventListener('click', function() {
                    const willShow = panel.classList.contains('hidden');
                    panel.classList.toggle('hidden');
                    toggleBtn.textContent = willShow
                        ? 'âœ– Hide targeting details'
                        : 'âš™ï¸ Add more targeting details (optional)';
                });
            }

            function bindInput(id, setter) {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', function() {
                    setter(String(el.value || ''));
                });
            }

            function setupContactability(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                const buttons = Array.from(container.querySelectorAll('.choice-btn'));
                if (!buttons.length) return;

                function select(value) {
                    state.targetContactability = value;
                    buttons.forEach(b => b.classList.toggle('selected', b.dataset.value === value));
                }

                buttons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        select(String(btn.dataset.value || 'balanced'));
                    });
                });

                select(state.targetContactability || 'balanced');
            }

            setupToggle('btn-toggle-target-advanced', 'target-advanced');
            setupToggle('btn-toggle-pro-target-advanced', 'pro-target-advanced');

            bindInput('target-search-intent', (v) => { state.targetSearchIntent = v; });
            bindInput('target-must-have', (v) => { state.targetMustHave = v; });
            bindInput('target-must-not', (v) => { state.targetMustNot = v; });
            bindInput('target-location', (v) => { state.targetLocation = v; });
            bindInput('target-examples', (v) => { state.targetExamples = v; });
            bindInput('target-evidence', (v) => { state.targetEvidence = v; });

            bindInput('pro-target-search-intent', (v) => { state.targetSearchIntent = v; });
            bindInput('pro-target-must-have', (v) => { state.targetMustHave = v; });
            bindInput('pro-target-must-not', (v) => { state.targetMustNot = v; });
            bindInput('pro-target-location', (v) => { state.targetLocation = v; });
            bindInput('pro-target-examples', (v) => { state.targetExamples = v; });
            bindInput('pro-target-evidence', (v) => { state.targetEvidence = v; });

            setupContactability('target-contactability');
            setupContactability('pro-target-contactability');
        }

        function setupEmailContextInputs() {
            function bind(id, key) {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', function() {
                    state[key] = String(el.value || '');
                });
            }

            bind('email-goal', 'emailGoal');
            bind('email-ask', 'emailAsk');
            bind('email-value', 'emailValue');
            bind('email-constraints', 'emailConstraints');
            bind('email-taboos', 'emailTaboos');
            bind('email-evidence', 'emailEvidence');
        }

        // Setup generation mode (smart vs template)
        function setupGenerationMode() {
            const modeCards = document.querySelectorAll('#generation-mode-options .option-card');
            const templateSection = document.getElementById('email-template-section');
            const templateInput = document.getElementById('email-template');
            const nextBtn = document.getElementById('btn-step4-next');

            function updateNextEnabled() {
                if (!state.generationMode) {
                    nextBtn.disabled = true;
                    return;
                }
                if (state.generationMode === 'template') {
                    const text = templateInput ? templateInput.value.trim() : '';
                    nextBtn.disabled = !text;
                } else {
                    nextBtn.disabled = false;
                }
            }

            modeCards.forEach(card => {
                card.addEventListener('click', function() {
                    modeCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.generationMode = this.dataset.value;

                    if (state.generationMode === 'template') {
                        templateSection.classList.remove('hidden');
                    } else {
                        templateSection.classList.add('hidden');
                    }

                    updateNextEnabled();
                });
            });

            if (templateInput) {
                templateInput.addEventListener('input', updateNextEnabled);
            }
        }

        // Regenerate current email with new style
        async function regenerateEmail() {
            const loading = document.getElementById('email-loading');
            const result = document.getElementById('email-result');
            const current = state.generatedEmails[state.currentEmailIndex];
            
            if (!current) return;
            
            let styleInstruction = '';
            switch (state.regenerateStyle) {
                case 'professional':
                    styleInstruction = 'Make the email more professional and formal';
                    break;
                case 'friendly':
                    styleInstruction = 'Make the email more friendly and warm';
                    break;
                case 'concise':
                    styleInstruction = 'Make the email shorter and more concise';
                    break;
                case 'detailed':
                    styleInstruction = 'Add more details and elaborate on key points';
                    break;
                case 'custom':
                    styleInstruction = document.getElementById('style-custom-input').value;
                    break;
            }
            
            if (!styleInstruction) {
                alert('Please select a style option');
                return;
            }
            
            // Save original email before regenerating
            const originalEmail = current.email;
            
            loading.classList.add('visible');
            result.classList.add('hidden');
            
            try {
                const response = await fetch('/api/regenerate-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        original_email: originalEmail,
                        style_instruction: styleInstruction,
                        sender: state.senderProfile,
                        receiver: current.target
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store both versions
                    state.generatedEmails[state.currentEmailIndex].originalEmail = originalEmail;
                    state.generatedEmails[state.currentEmailIndex].regeneratedEmail = data.email;
                    state.generatedEmails[state.currentEmailIndex].email = data.email;
                    state.generatedEmails[state.currentEmailIndex].selectedVersion = 'regenerated';
                    
                    loading.classList.remove('visible');
                    result.classList.remove('hidden');
                    
                    // Show compare view
                    showCompareView(originalEmail, data.email);
                } else {
                    throw new Error(data.error || 'Failed to regenerate email');
                }
            } catch (error) {
                loading.classList.remove('visible');
                result.classList.remove('hidden');
                alert('Error regenerating email: ' + error.message);
            }
        }

        // Show compare view with original and regenerated versions
        function showCompareView(originalEmail, regeneratedEmail) {
            const compareContainer = document.getElementById('email-compare');
            const compareActions = document.getElementById('compare-actions');
            const emailContent = document.getElementById('email-content');
            
            // Parse both emails
            const originalParts = parseEmailText(originalEmail);
            const regenParts = parseEmailText(regeneratedEmail);
            
            // Fill in original version
            document.getElementById('compare-original-subject').textContent = originalParts.subject || '(No subject)';
            document.getElementById('compare-original-body').textContent = originalParts.body;
            
            // Fill in regenerated version
            document.getElementById('compare-regen-subject').textContent = regenParts.subject || '(No subject)';
            document.getElementById('compare-regen-body').textContent = regenParts.body;
            
            // Show compare view, hide single editor
            compareContainer.classList.add('visible');
            compareActions.classList.remove('hidden');
            emailContent.classList.add('hidden');
            
            // Set regenerated as selected by default
            document.getElementById('version-original').classList.remove('selected');
            document.getElementById('version-regenerated').classList.add('selected');
            
            // Update displayed email to regenerated version
            displayCurrentEmail();
        }

        // Hide compare view and show single editor
        function hideCompareView() {
            const compareContainer = document.getElementById('email-compare');
            const compareActions = document.getElementById('compare-actions');
            const emailContent = document.getElementById('email-content');
            
            compareContainer.classList.remove('visible');
            compareActions.classList.add('hidden');
            emailContent.classList.remove('hidden');
        }

        // Setup compare view interactions
        function setupCompareView() {
            // Track for double click vs single click
            let clickTimer = null;
            let clickedVersion = null;
            
            // Click on version cards - single click to select, double click to expand
            const versionCards = document.querySelectorAll('.email-version');
            versionCards.forEach(card => {
                card.addEventListener('click', function(e) {
                    const version = this.dataset.version;
                    
                    if (clickTimer && clickedVersion === version) {
                        // Double click - open expand modal
                        clearTimeout(clickTimer);
                        clickTimer = null;
                        clickedVersion = null;
                        openExpandModal(version);
                    } else {
                        // First click - wait to see if it's a double click
                        clickedVersion = version;
                        clickTimer = setTimeout(() => {
                            // Single click - just select
                            versionCards.forEach(c => c.classList.remove('selected'));
                            this.classList.add('selected');
                            
                            const current = state.generatedEmails[state.currentEmailIndex];
                            if (current) {
                                current.selectedVersion = version;
                                current.email = version === 'original' ? current.originalEmail : current.regeneratedEmail;
                                displayCurrentEmail();
                            }
                            clickTimer = null;
                            clickedVersion = null;
                        }, 250);
                    }
                });
            });
            
            // Use Original button
            document.getElementById('btn-use-original').addEventListener('click', function() {
                const current = state.generatedEmails[state.currentEmailIndex];
                if (current && current.originalEmail) {
                    current.email = current.originalEmail;
                    current.selectedVersion = 'original';
                    hideCompareView();
                    displayCurrentEmail();
                }
            });
            
            // Use Regenerated button
            document.getElementById('btn-use-regenerated').addEventListener('click', function() {
                const current = state.generatedEmails[state.currentEmailIndex];
                if (current && current.regeneratedEmail) {
                    current.email = current.regeneratedEmail;
                    current.selectedVersion = 'regenerated';
                    hideCompareView();
                    displayCurrentEmail();
                }
            });
            
            // Close Compare button
            document.getElementById('btn-close-compare').addEventListener('click', function() {
                hideCompareView();
            });
            
            // Setup expand modal events
            setupExpandModal();
        }
        
        // Current editing version tracker
        let currentEditingVersion = null;
        
        // Open expand/edit modal for a version
        function openExpandModal(version) {
            const modal = document.getElementById('email-expand-modal');
            const current = state.generatedEmails[state.currentEmailIndex];
            
            if (!current) return;
            
            currentEditingVersion = version;
            
            // Get the email content for this version
            let emailContent = '';
            let title = '';
            let icon = '';
            
            if (version === 'original') {
                emailContent = current.originalEmail || current.email;
                title = 'Edit Original Version';
                icon = 'ðŸ“„';
            } else {
                emailContent = current.regeneratedEmail || current.email;
                title = 'Edit Regenerated Version';
                icon = 'âœ¨';
            }
            
            // Parse and fill in the form
            const parts = parseEmailText(emailContent);
            document.getElementById('expand-subject').value = parts.subject || '';
            document.getElementById('expand-body').value = parts.body || '';
            document.getElementById('expand-modal-title').textContent = title;
            document.getElementById('expand-modal-icon').textContent = icon;
            
            // Show modal
            modal.classList.add('visible');
            
            // Focus on subject
            setTimeout(() => {
                document.getElementById('expand-subject').focus();
            }, 100);
        }
        
        // Close expand modal
        function closeExpandModal() {
            const modal = document.getElementById('email-expand-modal');
            modal.classList.remove('visible');
            currentEditingVersion = null;
        }
        
        // Save changes from expand modal
        function saveExpandModalChanges() {
            const current = state.generatedEmails[state.currentEmailIndex];
            if (!current || !currentEditingVersion) return;
            
            const subject = document.getElementById('expand-subject').value.trim();
            const body = document.getElementById('expand-body').value.trim();
            
            // Build new email text
            const newEmail = buildEmailText(subject, body);
            
            // Update the correct version
            if (currentEditingVersion === 'original') {
                current.originalEmail = newEmail;
                // Update compare view
                document.getElementById('compare-original-subject').textContent = subject || '(No subject)';
                document.getElementById('compare-original-body').textContent = body;
            } else {
                current.regeneratedEmail = newEmail;
                // Update compare view
                document.getElementById('compare-regen-subject').textContent = subject || '(No subject)';
                document.getElementById('compare-regen-body').textContent = body;
            }
            
            // If the current selected version matches, update the main email too
            if (current.selectedVersion === currentEditingVersion) {
                current.email = newEmail;
                displayCurrentEmail();
            }
            
            closeExpandModal();
        }
        
        // Setup expand modal event listeners
        function setupExpandModal() {
            // Close button
            document.getElementById('btn-expand-close').addEventListener('click', closeExpandModal);
            
            // Cancel button
            document.getElementById('btn-expand-cancel').addEventListener('click', closeExpandModal);
            
            // Save button
            document.getElementById('btn-expand-save').addEventListener('click', saveExpandModalChanges);
            
            // Close on backdrop click
            document.getElementById('email-expand-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeExpandModal();
                }
            });
            
            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('email-expand-modal');
                    if (modal.classList.contains('visible')) {
                        closeExpandModal();
                    }
                }
            });
        }

        // Helper functions
        function parseEmailText(emailText) {
            const normalized = String(emailText || '').replace(/\r\n/g, '\n');
            const lines = normalized.split('\n');

            let firstNonEmptyIndex = 0;
            while (firstNonEmptyIndex < lines.length && !lines[firstNonEmptyIndex].trim()) {
                firstNonEmptyIndex++;
            }

            if (firstNonEmptyIndex < lines.length) {
                const firstLine = lines[firstNonEmptyIndex];
                // Match various Subject formats:
                // - "Subject: xxx"
                // - "**Subject:** xxx" (Markdown bold)
                // - "Subject Line: xxx"
                // - "**Subject Line:** xxx"
                const match = firstLine.match(/^\s*\*{0,2}\s*subject(?:\s+line)?\s*\*{0,2}\s*[:\-]\s*\*{0,2}\s*(.*?)\s*\*{0,2}\s*$/i);
                if (match) {
                    const subject = (match[1] || '').trim();
                    let body = lines.slice(firstNonEmptyIndex + 1).join('\n');
                    body = body.replace(/^\n+/, '');
                    return { subject, body };
                }
            }

            return { subject: '', body: normalized.trim() };
        }

        function buildEmailText(subject, body) {
            const subjectText = String(subject || '').trim();
            const bodyText = String(body || '').replace(/\r\n/g, '\n').trim();
            if (!subjectText) return bodyText;
            if (!bodyText) return `Subject: ${subjectText}`;
            return `Subject: ${subjectText}\n\n${bodyText}`;
        }

        function setCopyButtonState(button, copiedText, originalText) {
            button.classList.add('copied');
            button.textContent = copiedText;
            setTimeout(() => {
                button.classList.remove('copied');
                button.textContent = originalText;
            }, 1400);
        }

        function syncEmailEditorToState() {
            const current = state.generatedEmails[state.currentEmailIndex];
            if (!current) return;
            const subjectValue = document.getElementById('email-subject').value;
            const bodyValue = document.getElementById('email-body').value;
            current.email = buildEmailText(subjectValue, bodyValue);
        }

        function getPurposeText() {
            if (state.purpose === 'other') {
                return state.purposeCustom;
            }
            return purposeLabels[state.purpose] || state.purpose;
        }

        function getTargetFieldFromPreferences() {
            const history = Array.isArray(state.targetPreferenceHistory) ? state.targetPreferenceHistory : [];
            for (let i = history.length - 1; i >= 0; i--) {
                const q = String(history[i]?.question || '').toLowerCase();
                const a = String(history[i]?.answer || '').trim();
                if (!a) continue;
                if (q.includes('field') || q.includes('specialization') || q.includes('specialisation') || q.includes('domain') || q.includes('area')) {
                    return a;
                }
            }
            return '';
        }

        function getFieldText() {
            // Priority 1: Use Step 1 field selection
            if (state.field) {
                if (state.field === 'other-field') {
                    return state.fieldCustom || 'your field';
                }
                return fieldLabels[state.field] || state.field;
            }
            
            // Priority 2: Use preference field (for recommendations)
            const prefField = getTargetFieldFromPreferences();
            if (prefField) return prefField;

            const manualField = document.getElementById('target-field')?.value.trim();
            if (manualField) return manualField;

            if (state.selectedTargets.length > 0) {
                const lastTarget = state.selectedTargets[state.selectedTargets.length - 1];
                return lastTarget.field || lastTarget.position || '';
            }
            return 'your field';
        }

        function updateFindMatchesEnabled() {
            const btn = document.getElementById('btn-find-matches');
            if (!btn) return;
            btn.disabled = false;
        }

        function resetRecommendationState() {
            state.recommendations = [];
            state.selectedTargets = [];
            updateSelectedTargetsUI();
            
            const list = document.getElementById('recommendation-list');
            const actions = document.getElementById('rec-actions');
            const loading = document.getElementById('rec-loading');
            const details = document.getElementById('match-details');
            if (list) list.innerHTML = '';
            if (actions) actions.style.display = 'none';
            if (loading) loading.classList.remove('visible');
            if (details) details.classList.remove('visible');
            checkStep3Valid();
        }

        function checkStep1Valid() {
            const purposeValid = state.purpose && (state.purpose !== 'other' || state.purposeCustom.trim());
            const fieldValid = state.field && (state.field !== 'other-field' || state.fieldCustom.trim());
            document.getElementById('btn-step1-next').disabled = !(purposeValid && fieldValid);
        }

        function getFieldLabel() {
            if (state.field === 'other-field') {
                return state.fieldCustom;
            }
            return fieldLabels[state.field] || state.field;
        }

        function checkStep2Valid() {
            let valid = false;
            if (state.hasResume && state.senderProfile) {
                valid = true;
            } else if (state.mode === 'quick') {
                const hasQuickContext = Boolean(state.senderProfile)
                    || Boolean((state.senderProfileLink || '').trim())
                    || Boolean((state.senderProfileExtra || '').trim());
                if (hasQuickContext) {
                    valid = true;
                } else {
                    valid = Boolean(state.quickQuestionsEnabled)
                        && Array.isArray(state.questionnaireHistory)
                        && state.questionnaireHistory.some(qa => (qa.answer || '').trim().length > 0);
                }
            } else if (!state.hasResume) {
                // For questionnaires: require at least one non-empty answer
                valid = Array.isArray(state.questionnaireHistory)
                    && state.questionnaireHistory.some(qa => (qa.answer || '').trim().length > 0);
            }
            document.getElementById('btn-step2-next').disabled = !valid;
        }

        function checkStep3Valid() {
            let valid = false;
            if (state.hasTarget) {
                const name = document.getElementById('target-name').value.trim();
                const field = document.getElementById('target-field').value.trim();
                valid = name && field;
            } else if (state.selectedTargets.length > 0) {
                valid = true;
            }
            document.getElementById('btn-step3-next').disabled = !valid;
        }

        function goToStep(stepNum) {
            // Hide all steps
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`step-${i}`).classList.add('hidden');
                document.getElementById(`step-indicator-${i}`).classList.remove('active', 'completed');
                if (i < 5) {
                    document.getElementById(`connector-${i}`).classList.remove('completed');
                }
            }
            
            // Show current step
            document.getElementById(`step-${stepNum}`).classList.remove('hidden');
            document.getElementById(`step-indicator-${stepNum}`).classList.add('active');
            
            // Mark previous steps as completed
            for (let i = 1; i < stepNum; i++) {
                document.getElementById(`step-indicator-${i}`).classList.add('completed');
                document.getElementById(`connector-${i}`).classList.add('completed');
            }
            
            state.step = stepNum;
        }
    </script>
</body>
</html>

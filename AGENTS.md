# Repository Guidelines（仓库指南）

## 项目结构与模块组织

- `app.py`：Flask Web 入口（路由 + session/账号登录保护）。
- `src/`：核心逻辑
  - `email_agent.py`：从 PDF/JSON 抽取画像、推荐目标、生成/改写邮件。
  - `web_scraper.py`：轻量搜索与页面抓取（在缺少检索增强/grounding 时作为补充）。
  - `cli.py`：CLI 封装（`python -m src.cli ...`）。
- `templates/`：单文件 HTML 模板（内联 CSS/JS，主界面为 `index_v2.html`）。
- `examples/`：示例 JSON 画像（`sender.json`、`receiver.json`）。

## 构建、测试与开发命令

- 安装依赖：`python -m pip install -r requirements.txt`
- 本地运行（Web）：`python app.py`（默认 `http://localhost:5000`）
- 生产运行：`gunicorn app:app`（见 `Procfile`）
- CLI 帮助：`python -m src.cli --help`
- 基础自检（当前未配置正式测试套件）：`python -m compileall .`

## 代码风格与命名约定

- Python：4 空格缩进；函数/变量用 `snake_case`，类用 `PascalCase`。
- 优先使用类型标注与小而纯的辅助函数（参考 `src/email_agent.py` 的解析工具）。
- HTML 模板：优先沿用现有内联 `<script>` 组织 UI 逻辑；除非必要，避免引入外部静态资源。

## 产品理念与“两个核心任务”

- 产品只做两件事：**找人** 与 **生成邮件**；其它能力（问卷/简历解析/模式切换/模板）都服务于提升这两件事的成功率与可控性。
- 做好这两件事的关键是：围绕任务**供给足够且可验证的 context**，并用明确的输出格式/约束减少幻觉与空话。

### 1) 找人（推荐/搜索）策略

- **输入优先级**（尽量结构化字段，而不是大段散文）：
  - `sender_profile`：背景要点、领域/方向、目的（purpose）、想要的帮助（ask）、能提供的价值（value）。
  - `search_intent`：你要找“什么人”（角色/职位/机构/研究方向）+ 关键词 + 负面约束（不要什么）。
  - `filters`：地区/语言、层级、机构类型、行业细分、时间范围等。
  - `evidence`：上传文档（PDF/TXT/MD）或可引用的链接/摘录。
- **输出要求**：
  - 每个候选都要有：`match_score`、`match_reason`、`evidence`（来源链接或文档摘录）、`uncertainty`（不确定就标注，不要编细节）。
  - 候选按“相关性/可联系性/证据充分度”排序；缺证据的点必须显式写成推测。
- **工程拆分**：检索（找候选）与抽取（结构化画像）与排序（打分）分开，避免一个提示词里做所有事。

### 2) 生成邮件（冷启动第一封）策略

- **输入优先级**：
  - `sender_profile` / `receiver_profile` 的可写事实点（教育/经历/项目/共同点线索）与 `goal`（这封信要达成什么）。
  - 明确 `ask`（一个清晰请求）与 `constraints`（语气/长度/语言/禁区：禁止虚构关系与经历）。
  - `evidence`：邮件里引用的事实必须能回溯到用户输入/上传文档/检索证据。
- **输出要求**：
  - 固定结构：Subject → 开场依据（为什么是对方）→ 交集/价值交换 → 明确请求（含时长/可选时间）→ 退出选项。
  - 个性化来自“证据点”，而不是夸赞；信息不足时先提出澄清问题或给保守版本（不编造）。
- **质量闭环**：允许用户对候选/邮件点选“好/差原因”，作为下一轮负例约束与偏好更新。

## 测试指南

- 使用 `pytest`（见 `tests/` 目录）。
- 新增/修改行为时，至少提供可复现路径：
  - CLI：在 `examples/` 增补/更新示例，并在说明中给出运行命令。
  - Web：注明相关接口与请求体（例如 `/api/generate-email`）。

## 提交与拉取请求（PR）规范

- 提交信息采用轻量约定：`feat: ...`、`fix: ...`、`docs: ...`、`chore: ...`、`style: ...`（偶尔使用版本标签如 `v3.0: ...`）。
- PR 需包含：
  - 改动内容与动机，以及任何用户可见的 UX 变化说明。
  - 修改 `templates/` 的 UI 时提供截图/GIF。
  - 确认未提交密钥或敏感数据。

## 文档更新要求（必须）

- 每次修改代码（含 UI、接口、配置、依赖、行为逻辑），都需要同步更新相关文档：`README.md`、`devlog.md`、`note.md`（至少更新“受影响的那一份/几份”，不要求无关内容也改）。
- PR 描述里简要列出“本次改动影响了哪些文档/为什么”。

### `README.md` 写法

- 面向“新用户/评审者”的入口文档：怎么用、怎么跑起来、核心能力是什么。
- 只保留稳定信息：Quick Start、关键命令、环境变量、CLI 示例、线上地址等；避免写过细的实现细节。
- 有用户可见变化时更新：功能列表、使用步骤、示例命令、截图/说明（如有）。

### `devlog.md` 写法

- 面向“开发过程”的按时间记录：每次重要迭代新增一个日期小节（`## YYYY-MM-DD: ...`）。
- 写清三件事：新增/变更点（bullets）、涉及文件（如 `templates/index_v2.html`）、风险/迁移提示（如环境变量或兼容性）。
- 偏事实记录，不做长篇背景论述。

### `note.md` 写法

- 面向“设计/思路沉淀”的长期文档：目标、核心抽象、版本演进、关键决策与取舍。
- 更新原则：当核心流程、抽象边界、模型/推荐策略、重要 UX 流程发生变化时，补充对应章节。
- 允许更主观的解释（为什么这么做），但保持结构清晰，避免把操作指南放进来（操作指南放 `README.md`）。

## 安全与配置提示

- 通过环境变量配置：`GEMINI_API_KEY`（或 `GOOGLE_API_KEY`）、可选 `OPENAI_API_KEY`，以及 Web 端的 `SECRET_KEY`、`INVITE_ONLY`、`INVITE_CODE(S)`、`GOOGLE_CLIENT_ID`/`GOOGLE_CLIENT_SECRET`（可选）。
- 不要提交 PDF（`.gitignore` 已忽略 `*.pdf`）。
